<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ•°å­¦å¿«é€Ÿå‡ºé¢˜å™¨ - å£ç®—+ç«–å¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --secondary-color: #8b5cf6;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --info-color: #3b82f6;
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            margin: 0;
        }

        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #7c3aed;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .question-box {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            margin: 30px 0;
        }

        .question-text {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .answer-input {
            font-size: 2rem;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
        }

        /* ç«–å¼æ ·å¼ */
        .vertical-question {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 300px;
            box-shadow: var(--shadow);
        }

        .vertical-expression {
            text-align: right;
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
        }

        .vertical-number {
            padding: 5px 15px;
        }

        .vertical-operator {
            padding-right: 10px;
        }

        .vertical-line {
            border-top: 3px solid #333;
            margin: 5px 0;
        }

        .vertical-answer {
            padding: 5px 15px;
            font-weight: bold;
        }

        .vertical-input {
            width: 150px;
            font-size: 1.8rem;
            text-align: center;
            padding: 8px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            margin-left: auto;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .result-summary {
            text-align: center;
            padding: 30px;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
        }

        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
        }

        .score-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .result-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-item-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .result-item-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .wrong-answers {
            background: #fef2f2;
            border-left: 4px solid var(--danger-color);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .wrong-answers h3 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }

        .wrong-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wrong-question {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .wrong-answer-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .wrong-answer-info span {
            display: inline-block;
            margin: 0 10px;
        }

        /* é¢˜å‹æ ‡ç­¾ */
        .question-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .type-oral {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-vertical {
            background: #fce7f3;
            color: #9d174d;
        }

        /* æ‰“å°æ ·å¼ */
        .print-area {
            display: none;
        }

        @media print {
            @page {
                margin: 10mm;
                size: A4;
            }

            @page:last {
                margin: 10mm;
            }

            /* å¼ºåˆ¶ä¸æ‰“å°ç©ºç™½é¡µ */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            html, body {
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
                min-height: 0;
                max-height: none;
            }

            /* ç¡®ä¿htmlå’Œbodyä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
            html::after, body::after {
                display: none;
                content: none;
            }

            @page {
                orphans: 0;
                widows: 0;
            }

            body * {
                visibility: hidden;
            }

            .print-area, .print-area * {
                visibility: visible;
            }

            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block;
                background: white;
                padding: 6mm;
                box-sizing: border-box;
                height: auto;
                max-height: none;
                overflow: visible;
                page-break-after: avoid;
                break-after: avoid;
            }

            /* è¯•å·wrapperçš„åˆ†é¡µæ§åˆ¶ */
            .print-copy-wrapper {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            /* åªæœ‰å¤šä¸ªwrapperæ—¶æ‰åœ¨åé¢åˆ†é¡µ */
            .print-copy-wrapper:not(:only-child):not(:last-child) {
                page-break-after: always;
            }

            /* å”¯ä¸€ä¸€ä»½æˆ–æœ€åä¸€ä»½ä¸åˆ†é¡µ */
            .print-copy-wrapper:only-child {
                page-break-after: auto !important;
            }

            .print-copy-wrapper:last-child {
                page-break-after: auto !important;
            }

            /* ç¡®ä¿wrapperå†…éƒ¨æ‰€æœ‰å…ƒç´ éƒ½ä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
            .print-copy-wrapper > * {
                page-break-after: auto !important;
            }

            .print-header {
                text-align: center;
                margin-bottom: 8px;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            .print-header h1 {
                font-size: 1.2rem;
                font-weight: bold;
                margin: 0;
                padding: 0;
            }

            .print-section {
                margin-bottom: 8px;
                page-break-inside: avoid;
            }

            .print-section:last-child {
                margin-bottom: 0;
            }

            /* é˜²æ­¢å†…å®¹åˆ†é¡µ */
            #printContent {
                page-break-inside: avoid;
            }

            /* ç¡®ä¿printContentæœ¬èº«å’Œå†…éƒ¨æœ€åä¸€ä¸ªå…ƒç´ ä¸åˆ†é¡µ */
            #printContent > div:last-child {
                page-break-after: auto !important;
            }

            /* ç‰¹åˆ«å¤„ç†ï¼šprintContentåªæœ‰ä¸€ä¸ªå­å…ƒç´ æ—¶ï¼Œå®Œå…¨ä¸åˆ†é¡µ */
            #printContent:has(> div:only-child) {
                page-break-after: avoid !important;
            }

            #printContent:has(> div:only-child) > div {
                page-break-after: avoid !important;
            }

            .print-section {
                page-break-inside: avoid;
            }

            .print-oral, .print-vertical {
                page-break-inside: avoid;
            }

            .print-section-title {
                font-size: 0.95rem;
                font-weight: bold;
                margin-bottom: 8px;
                padding-bottom: 6px;
                border-bottom: 2px solid #000;
            }

            .print-oral {
                display: inline-block;
                width: 20%;
                margin: 5px 0.5% 8px 0.5%;
                font-size: 0.85rem;
                vertical-align: top;
                font-family: 'Courier New', monospace;
                white-space: nowrap;
                overflow: hidden;
                box-sizing: border-box;
                text-align: left;
                line-height: 1.4;
            }

            .print-oral .eq-align {
                display: inline-block;
                width: 100%;
            }

            .print-vertical {
                display: inline-block;
                width: 20%;
                margin: 5px 0.5% 8px 0.5%;
                vertical-align: top;
                font-family: 'Courier New', monospace;
                font-size: 0.75rem;
                line-height: 1.2;
                background: white;
                padding: 4px;
                border: 1px solid #ddd;
                border-radius: 3px;
                page-break-inside: avoid;
                box-sizing: border-box;
            }

            .print-vertical-calculation {
                text-align: right;
                margin: 3px 0;
            }

            .print-vertical-numbers {
                display: inline-block;
                text-align: right;
                font-size: 0.8rem;
            }

            .print-vertical-line {
                border-top: 0.5px solid #000;
                margin: 2px 0 2px 0;
            }

            .print-vertical-answer {
                min-height: 20px;
                margin-top: 2px;
            }

            .print-vertical-horizontal {
                font-size: 0.7rem;
                color: #333;
                margin-bottom: 3px;
                font-weight: 600;
                text-align: left;
                white-space: nowrap;
                font-family: 'Courier New', monospace;
            }

            .print-vertical-num {
                letter-spacing: 0;
            }

            .print-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                padding-bottom: 6px;
                border-bottom: 2px solid #000;
                font-size: 0.85rem;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            /* ç¡®ä¿æ‰“å°åŒºåŸŸçš„æœ€åä¸€ä¸ªå…ƒç´ ä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
            .print-area > *:last-child {
                page-break-after: auto !important;
            }

            /* é¢å¤–çš„é˜²ç©ºç™½é¡µæªæ–½ */
            #printContent {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            /* ç¡®ä¿bodyå’Œhtmlåœ¨æ‰“å°æ—¶ä¸ä¼šäº§ç”Ÿé¢å¤–é¡µé¢ */
            body {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            html {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            /* ä½¿ç”¨breakå±æ€§çš„ç°ä»£æµè§ˆå™¨æ”¯æŒ */
            .print-copy-wrapper {
                break-inside: avoid;
            }

            .print-copy-wrapper:only-child {
                break-after: avoid !important;
            }

            .print-copy-wrapper:last-child {
                break-after: avoid !important;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: var(--shadow);
            transform: translateX(5px);
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .history-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .history-stats span {
            font-weight: 600;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.6rem;
            }

            .card {
                padding: 20px;
            }

            .question-text {
                font-size: 2rem;
            }

            .answer-input {
                font-size: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .result-stats {
                grid-template-columns: 1fr;
            }

            .vertical-expression {
                font-size: 1.4rem;
            }

            .vertical-input {
                width: 120px;
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§® å°å­¦æ•°å­¦å¿«é€Ÿå‡ºé¢˜å™¨</h1>
            <p>å£ç®— + ç«–å¼ï¼Œè®©æ•°å­¦ç»ƒä¹ æ›´å…¨é¢ï¼</p>
        </header>

        <!-- ä¸»ç•Œé¢ -->
        <div id="homeSection" class="section active">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ¯ å¼€å§‹ç»ƒä¹ </h2>

                <div class="form-group">
                    <label>ğŸ“š é€‰æ‹©å¹´çº§</label>
                    <select id="gradeSelect">
                        <option value="1">ä¸€å¹´çº§ (6-7å²) - 20ä»¥å†…åŠ å‡æ³•</option>
                        <option value="2">äºŒå¹´çº§ (7-8å²) - 100ä»¥å†…åŠ å‡æ³•ã€ä¹˜æ³•å£è¯€</option>
                        <option value="3" selected>ä¸‰å¹´çº§ (8-9å²) - 1000ä»¥å†…åŠ å‡ä¹˜é™¤</option>
                        <option value="4">å››å¹´çº§ (9-10å²) - å¤§æ•°è¿ç®—ã€å°æ•°åŠ å‡</option>
                        <option value="5">äº”å¹´çº§ (10-11å²) - å°æ•°ä¹˜é™¤ã€åˆ†æ•°åŠ å‡</option>
                        <option value="6">å…­å¹´çº§ (11-12å²) - åˆ†æ•°ä¹˜é™¤ã€ç™¾åˆ†æ•°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“ é¢˜å‹é€‰æ‹©ï¼ˆè‡³å°‘é€‰ä¸€ç§ï¼‰</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="oralCheck" checked> å£ç®—é¢˜ï¼ˆæ¨ªå¼è®¡ç®—ï¼‰
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="verticalCheck" checked> ç«–å¼é¢˜ï¼ˆç¬”ç®—è®¡ç®—ï¼‰
                        </label>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">ğŸ’¡ æç¤ºï¼šå¯å•é€‰æˆ–åŒé€‰ï¼Œé¢˜ç›®å°†æŒ‰é¡ºåºå‡ºç°</p>
                </div>

                <div class="form-group">
                    <label>âœï¸ è¿ç®—ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" value="add" checked> åŠ æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="subtract" checked> å‡æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="multiply"> ä¹˜æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="divide"> é™¤æ³•
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ“Š éš¾åº¦çº§åˆ«</label>
                    <select id="difficultySelect">
                        <option value="easy">ç®€å• - åŸºç¡€è¿ç®—</option>
                        <option value="medium" selected>ä¸­ç­‰ - éœ€è¦è¿›é€€ä½</option>
                        <option value="hard">å›°éš¾ - å¤æ‚è¿ç®—</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“Š é¢˜ç›®æ•°é‡è®¾ç½®</label>
                    <div style="display: flex; gap: 15px; margin-bottom: 10px;">
                        <div style="flex: 1;">
                            <label style="font-size: 0.95rem; color: var(--primary-color); font-weight: 600;">ğŸ“ å£ç®—é¢˜</label>
                            <select id="oralCount">
                                <option value="12">12é¢˜</option>
                                <option value="16">16é¢˜</option>
                                <option value="20" selected>20é¢˜</option>
                                <option value="24">24é¢˜</option>
                                <option value="28">28é¢˜</option>
                                <option value="32">32é¢˜</option>
                                <option value="36">36é¢˜</option>
                                <option value="40">40é¢˜</option>
                            </select>
                        </div>
                        <div style="flex: 1;">
                            <label style="font-size: 0.95rem; color: var(--secondary-color); font-weight: 600;">âœï¸ ç«–å¼é¢˜</label>
                            <select id="verticalCount">
                                <option value="8">8é¢˜</option>
                                <option value="12">12é¢˜</option>
                                <option value="16" selected>16é¢˜</option>
                                <option value="20">20é¢˜</option>
                                <option value="24">24é¢˜</option>
                            </select>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">ğŸ“Œ é¢˜ç›®å°†æŒ‰é¡ºåºå‡ºç°ï¼šå…ˆå®Œæˆæ‰€æœ‰å£ç®—é¢˜ï¼Œå†è¿›è¡Œç«–å¼é¢˜ | æ•°é‡ä¸º4çš„å€æ•°ï¼Œä¾¿äºæ’ç‰ˆ</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startPractice()">ğŸ® å¼€å§‹ç»ƒä¹ </button>
                    <button class="btn btn-info" onclick="startTimedTest()">â±ï¸ è®¡æ—¶æµ‹è¯•</button>
                    <button class="btn btn-secondary" onclick="showPrintDialog()">ğŸ–¨ï¸ ç”Ÿæˆè¯•å·</button>
                    <button class="btn btn-primary" onclick="showHistory()">ğŸ“– æŸ¥çœ‹è®°å½•</button>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayCount">0</div>
                        <div class="stat-label">ä»Šæ—¥ç»ƒä¹ ï¼ˆæ¬¡ï¼‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAccuracy">0%</div>
                        <div class="stat-label">å¹³å‡æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalQuestions">0</div>
                        <div class="stat-label">ç´¯è®¡åšé¢˜ï¼ˆé¢˜ï¼‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestStreak">0</div>
                        <div class="stat-label">æœ€ä½³è¿ç»­ç­”å¯¹</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­”é¢˜ç•Œé¢ -->
        <div id="practiceSection" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <span id="questionTypeBadge" class="question-type-badge type-oral">å£ç®—é¢˜</span>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-top: 10px; color: var(--text-secondary);" id="sectionInfo">ç¬¬1/10é¢˜</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">æ€»è¿›åº¦ï¼šç¬¬ <span id="currentQ">1</span>/<span id="totalQ">20</span> é¢˜</div>
                    </div>
                    <div class="timer" id="timer">00:00</div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>

                <!-- å£ç®—é¢˜ç›®æ˜¾ç¤º -->
                <div id="oralQuestionArea" class="question-box">
                    <div class="question-text" id="questionText">23 + 15 = ?</div>
                    <input type="number" class="answer-input" id="answerInput" placeholder="è¾“å…¥ç­”æ¡ˆ" onkeypress="handleKeyPress(event)">
                </div>

                <!-- ç«–å¼é¢˜ç›®æ˜¾ç¤º -->
                <div id="verticalQuestionArea" class="vertical-question" style="display: none;">
                    <div style="text-align: center; font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 15px;" id="verticalHorizontalDisplay">
                        123 + 45 = ?
                    </div>
                    <div class="vertical-expression">
                        <div class="vertical-number" id="verticalNum1">123</div>
                        <div>
                            <span class="vertical-operator" id="verticalOperator">+</span>
                            <span class="vertical-number" id="verticalNum2">45</span>
                        </div>
                        <div class="vertical-line"></div>
                        <div>
                            <input type="number" class="vertical-input" id="verticalAnswerInput" placeholder="?" onkeypress="handleKeyPress(event)">
                        </div>
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitAnswer()">âœ… æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="skipQuestion()">â­ï¸ è·³è¿‡</button>
                    <button class="btn btn-info" onclick="readQuestion()">ğŸ”Š è¯»é¢˜</button>
                </div>
            </div>
        </div>

        <!-- æˆç»©ç•Œé¢ -->
        <div id="resultSection" class="section">
            <div class="card">
                <div class="result-summary">
                    <div class="score-circle">
                        <div class="score-value" id="finalScore">90</div>
                        <div class="score-label">åˆ†</div>
                    </div>

                    <h2 id="resultTitle" style="margin-bottom: 20px;">ğŸ‰ å¤ªæ£’äº†ï¼</h2>

                    <div class="result-stats">
                        <div class="result-item">
                            <div class="result-item-label">é¢˜ç›®æ€»æ•°</div>
                            <div class="result-item-value" id="resultTotal">20</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">æ­£ç¡®é¢˜æ•°</div>
                            <div class="result-item-value" style="color: var(--success-color);" id="resultCorrect">18</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">é”™è¯¯é¢˜æ•°</div>
                            <div class="result-item-value" style="color: var(--danger-color);" id="resultWrong">2</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">ç”¨æ—¶</div>
                            <div class="result-item-value" id="resultTime">03:45</div>
                        </div>
                    </div>

                    <div id="sectionStats" style="margin: 20px 0; padding: 15px; background: #f9fafb; border-radius: 10px;">
                        <h3 style="text-align: center; margin-bottom: 15px; font-size: 1.1rem;">ğŸ“Š å„éƒ¨åˆ†æˆç»©</h3>
                        <div id="sectionStatsContent"></div>
                    </div>

                    <div id="wrongAnswersSection" class="wrong-answers" style="display: none;">
                        <h3>âŒ é”™é¢˜å›é¡¾</h3>
                        <div id="wrongAnswersList"></div>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="restart()">ğŸ”„ å†ç»ƒä¸€æ¬¡</button>
                        <button class="btn btn-secondary" onclick="practiceWrong()">ğŸ“• é‡ç»ƒé”™é¢˜</button>
                        <button class="btn btn-info" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•ç•Œé¢ -->
        <div id="historySection" class="section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“– ç»ƒä¹ è®°å½•</h2>
                <div class="history-list" id="historyList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— ç»ƒä¹ è®°å½•</p>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    <button class="btn btn-danger" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
                </div>
            </div>
        </div>

        <!-- æ‰“å°è®¾ç½®å¯¹è¯æ¡† -->
        <div id="printDialog" class="section" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px;">
            <div class="card" style="max-width: 500px; width: 100%; animation: fadeIn 0.3s ease;">
                <h2 style="margin-bottom: 20px;">ğŸ–¨ï¸ ç”Ÿæˆè¯•å·è®¾ç½®</h2>

                <div class="form-group">
                    <label>ğŸ“Š ç”Ÿæˆä»½æ•°</label>
                    <select id="printCopies" style="margin-bottom: 15px;">
                        <option value="1">1ä»½</option>
                        <option value="2">2ä»½</option>
                        <option value="5">5ä»½</option>
                        <option value="10">10ä»½</option>
                        <option value="20">20ä»½</option>
                        <option value="30" selected>30ä»½ï¼ˆå…¨ç­ä½¿ç”¨ï¼‰</option>
                        <option value="40">40ä»½</option>
                        <option value="50">50ä»½</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ² é¢˜ç›®è®¾ç½®</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="sameQuestions"> æ‰€æœ‰ä»½ä½¿ç”¨ç›¸åŒé¢˜ç›®
                        </label>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                        ğŸ’¡ æç¤ºï¼šå‹¾é€‰åæ‰€æœ‰è¯•å·é¢˜ç›®ç›¸åŒï¼›ä¸å‹¾é€‰åˆ™æ¯ä»½è¯•å·é¢˜ç›®ä¸åŒï¼ˆé˜²ä½œå¼Šï¼‰
                    </p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="confirmGeneratePrint()">âœ… ç¡®è®¤ç”Ÿæˆ</button>
                    <button class="btn btn-secondary" onclick="closePrintDialog()">âŒ å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ‰“å°åŒºåŸŸ -->
        <div class="print-area" id="printArea">
            <div id="printContent"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let questions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongAnswers = [];
        let startTime = null;
        let timerInterval = null;
        let settings = {};
        let streak = 0;

        // åˆå§‹åŒ–
        window.onload = function() {
            loadStats();
            loadHistory();
        };

        // å·¥å…·å‡½æ•°
        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // è·å–æ•°å­—èŒƒå›´
        function getNumberRange(grade) {
            switch(grade) {
                case 1: return { min: 1, max: 10 };
                case 2: return { min: 1, max: 50 };
                case 3: return { min: 1, max: 100 };
                case 4: return { min: 1, max: 500 };
                case 5: return { min: 1, max: 1000 };
                case 6: return { min: 1, max: 5000 };
                default: return { min: 1, max: 100 };
            }
        }

        // ç”Ÿæˆå£ç®—é¢˜
        function generateOralQuestion(grade, difficulty, operation) {
            const { min, max } = getNumberRange(grade);

            switch(operation) {
                case 'add':
                    let a1 = random(min, max);
                    let b1 = random(min, max);
                    if (difficulty === 'easy') {
                        a1 = random(1, Math.min(9, max));
                        b1 = random(1, Math.min(9, max));
                    }
                    return { type: 'oral', question: `${a1} + ${b1}`, answer: a1 + b1, display: `${a1} + ${b1} = ?` };

                case 'subtract':
                    let ans1 = random(min, max);
                    let b_sub = random(min, ans1);
                    let a_sub = ans1 + b_sub;
                    if (difficulty === 'easy') {
                        ans1 = random(1, Math.min(9, max));
                        b_sub = random(1, ans1);
                        a_sub = ans1 + b_sub;
                    }
                    return { type: 'oral', question: `${a_sub} - ${b_sub}`, answer: ans1, display: `${a_sub} - ${b_sub} = ?` };

                case 'multiply':
                    if (grade === 2) {
                        const ma = random(1, 9);
                        const mb = random(1, 9);
                        return { type: 'oral', question: `${ma} Ã— ${mb}`, answer: ma * mb, display: `${ma} Ã— ${mb} = ?` };
                    } else if (grade === 3) {
                        const ma = random(10, 99);
                        const mb = random(2, 9);
                        return { type: 'oral', question: `${ma} Ã— ${mb}`, answer: ma * mb, display: `${ma} Ã— ${mb} = ?` };
                    } else {
                        const ma = random(10, 99);
                        const mb = random(10, difficulty === 'easy' ? 20 : 99);
                        return { type: 'oral', question: `${ma} Ã— ${mb}`, answer: ma * mb, display: `${ma} Ã— ${mb} = ?` };
                    }

                case 'divide':
                    let db, dans;
                    if (grade === 3) {
                        db = random(2, 9);
                        dans = random(1, 12);
                    } else {
                        db = random(2, difficulty === 'easy' ? 9 : 20);
                        dans = random(1, 50);
                    }
                    const da = db * dans;
                    return { type: 'oral', question: `${da} Ã· ${db}`, answer: dans, display: `${da} Ã· ${db} = ?` };

                default:
                    return { type: 'oral', question: '2 + 3', answer: 5, display: '2 + 3 = ?' };
            }
        }

        // ç”Ÿæˆç«–å¼é¢˜
        function generateVerticalQuestion(grade, difficulty, operation) {
            const { min, max } = getNumberRange(grade);

            switch(operation) {
                case 'add':
                    let va1 = random(min, max);
                    let vb1 = random(min, max);
                    // ç¡®ä¿æ˜¯ä¸¤ä½æ•°æˆ–ä¸‰ä½æ•°ï¼Œé€‚åˆç«–å¼
                    if (grade <= 3) {
                        va1 = random(10, Math.min(99, max));
                        vb1 = random(10, Math.min(99, max));
                    } else {
                        va1 = random(100, Math.min(999, max));
                        vb1 = random(100, Math.min(999, max));
                    }
                    return {
                        type: 'vertical',
                        num1: va1,
                        num2: vb1,
                        operator: '+',
                        answer: va1 + vb1,
                        display: `${va1} + ${vb1}`
                    };

                case 'subtract':
                    let vans = random(min, Math.floor(max * 0.7));
                    let vb_sub = random(Math.floor(min * 0.5), vans);
                    let va_sub = vans + vb_sub;
                    if (grade <= 3) {
                        vans = random(10, Math.min(99, max));
                        vb_sub = random(10, vans);
                        va_sub = vans + vb_sub;
                    } else {
                        vans = random(100, Math.min(999, max));
                        vb_sub = random(100, vans);
                        va_sub = vans + vb_sub;
                    }
                    return {
                        type: 'vertical',
                        num1: va_sub,
                        num2: vb_sub,
                        operator: '-',
                        answer: vans,
                        display: `${va_sub} - ${vb_sub}`
                    };

                case 'multiply':
                    if (grade === 3) {
                        const vma = random(11, 99);
                        const vmb = random(2, 9);
                        return {
                            type: 'vertical',
                            num1: vma,
                            num2: vmb,
                            operator: 'Ã—',
                            answer: vma * vmb,
                            display: `${vma} Ã— ${vmb}`
                        };
                    } else {
                        const vma = random(11, 99);
                        const vmb = random(11, difficulty === 'easy' ? 20 : 99);
                        return {
                            type: 'vertical',
                            num1: vma,
                            num2: vmb,
                            operator: 'Ã—',
                            answer: vma * vmb,
                            display: `${vma} Ã— ${vmb}`
                        };
                    }

                case 'divide':
                    let vdb, vdans;
                    if (grade === 3) {
                        vdb = random(2, 9);
                        vdans = random(10, 50);
                    } else {
                        vdb = random(2, 20);
                        vdans = random(10, 100);
                    }
                    const vda = vdb * vdans;
                    return {
                        type: 'vertical',
                        num1: vda,
                        num2: vdb,
                        operator: 'Ã·',
                        answer: vdans,
                        display: `${vda} Ã· ${vdb}`
                    };

                default:
                    return {
                        type: 'vertical',
                        num1: 123,
                        num2: 45,
                        operator: '+',
                        answer: 168,
                        display: '123 + 45'
                    };
            }
        }

        // ç”Ÿæˆæ‰€æœ‰é¢˜ç›®
        function generateQuestions() {
            const grade = parseInt(document.getElementById('gradeSelect').value);
            const difficulty = document.getElementById('difficultySelect').value;

            const operationCheckboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
            const operations = Array.from(operationCheckboxes).map(cb => cb.value).filter(op => ['add', 'subtract', 'multiply', 'divide'].includes(op));

            if (operations.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¿ç®—ç±»å‹', 'error');
                return false;
            }

            const oralChecked = document.getElementById('oralCheck').checked;
            const verticalChecked = document.getElementById('verticalCheck').checked;

            // éªŒè¯è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹
            if (!oralChecked && !verticalChecked) {
                showToast('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹ï¼ˆå£ç®—é¢˜æˆ–ç«–å¼é¢˜ï¼‰', 'error');
                return false;
            }

            // éªŒè¯è¿ç®—ç±»å‹
            if (operations.length === 0) {
                showToast('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¿ç®—ç±»å‹ï¼ˆåŠ å‡ä¹˜é™¤ï¼‰', 'error');
                return false;
            }

            questions = [];

            // ç”Ÿæˆå£ç®—é¢˜
            if (oralChecked) {
                const oralCount = parseInt(document.getElementById('oralCount').value);
                for (let i = 0; i < oralCount; i++) {
                    const op = operations[random(0, operations.length - 1)];
                    questions.push(generateOralQuestion(grade, difficulty, op));
                }
            }

            // ç”Ÿæˆç«–å¼é¢˜
            if (verticalChecked) {
                const verticalCount = parseInt(document.getElementById('verticalCount').value);
                for (let i = 0; i < verticalCount; i++) {
                    const op = operations[random(0, operations.length - 1)];
                    questions.push(generateVerticalQuestion(grade, difficulty, op));
                }
            }

 // ä¸æ‰“ä¹±é¡ºåºï¼Œä¿æŒé¢˜ç›®é¡ºåºï¼šå£ç®— â†’ ç«–å¼

            // è®°å½•å„éƒ¨åˆ†çš„é¢˜ç›®æ•°é‡
            const oralCount = oralChecked ? parseInt(document.getElementById('oralCount').value) : 0;
            const verticalCount = verticalChecked ? parseInt(document.getElementById('verticalCount').value) : 0;

            settings = { grade, difficulty, oralChecked, verticalChecked, oralCount, verticalCount };
            return true;
        }

        // å¼€å§‹ç»ƒä¹ 
        function startPractice() {
            if (!generateQuestions()) return;

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');
            focusInput();
        }

        // è®¡æ—¶æµ‹è¯•
        function startTimedTest() {
            startPractice();
        }

        // è·å–å½“å‰éƒ¨åˆ†ä¿¡æ¯
        function getSectionInfo() {
            const oralCount = settings.oralCount || 0;
            const verticalCount = settings.verticalCount || 0;

            if (currentQuestionIndex < oralCount) {
                return {
                    section: 'å£ç®—é¢˜',
                    sectionName: 'å£ç®—é¢˜',
                    current: currentQuestionIndex + 1,
                    total: oralCount,
                    globalIndex: currentQuestionIndex + 1
                };
            } else {
                return {
                    section: 'ç«–å¼é¢˜',
                    sectionName: 'ç«–å¼é¢˜',
                    current: currentQuestionIndex - oralCount + 1,
                    total: verticalCount,
                    globalIndex: currentQuestionIndex + 1
                };
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            const q = questions[currentQuestionIndex];
            const sectionInfo = getSectionInfo();

            // æ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯
            document.getElementById('currentQ').textContent = sectionInfo.globalIndex;
            document.getElementById('totalQ').textContent = questions.length;
            document.getElementById('sectionInfo').textContent = `ç¬¬${sectionInfo.current}/${sectionInfo.total}é¢˜`;

            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // æ£€æŸ¥æ˜¯å¦åˆšåˆšåˆ‡æ¢åˆ°æ–°éƒ¨åˆ†ï¼Œæ˜¾ç¤ºæç¤º
            if (currentQuestionIndex > 0) {
                const prevQ = questions[currentQuestionIndex - 1];
                if (prevQ.type !== q.type) {
                    showToast(`ğŸ¯ è¿›å…¥${sectionInfo.section}ï¼š${sectionInfo.sectionName}`, 'success');
                }
            }

            if (q.type === 'oral') {
                // æ˜¾ç¤ºå£ç®—é¢˜
                document.getElementById('oralQuestionArea').style.display = 'block';
                document.getElementById('verticalQuestionArea').style.display = 'none';
                document.getElementById('questionText').textContent = q.display;
                document.getElementById('answerInput').value = '';
                document.getElementById('questionTypeBadge').className = 'question-type-badge type-oral';
                document.getElementById('questionTypeBadge').textContent = 'ğŸ“ å£ç®—é¢˜';
            } else {
                // æ˜¾ç¤ºç«–å¼é¢˜
                document.getElementById('oralQuestionArea').style.display = 'none';
                document.getElementById('verticalQuestionArea').style.display = 'block';
                document.getElementById('verticalNum1').textContent = q.num1;
                document.getElementById('verticalNum2').textContent = q.num2;
                document.getElementById('verticalOperator').textContent = q.operator;
                document.getElementById('verticalAnswerInput').value = '';
                document.getElementById('verticalHorizontalDisplay').textContent = `${q.display} = ?`;
                document.getElementById('questionTypeBadge').className = 'question-type-badge type-vertical';
                document.getElementById('questionTypeBadge').textContent = 'âœï¸ ç«–å¼é¢˜';
            }

            focusInput();
        }

        // èšç„¦è¾“å…¥æ¡†
        function focusInput() {
            setTimeout(() => {
                const q = questions[currentQuestionIndex];
                if (q.type === 'oral') {
                    document.getElementById('answerInput').focus();
                } else {
                    document.getElementById('verticalAnswerInput').focus();
                }
            }, 100);
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').textContent = formatTime(elapsed);
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            const q = questions[currentQuestionIndex];
            let userAnswer;

            if (q.type === 'oral') {
                userAnswer = parseInt(document.getElementById('answerInput').value);
            } else {
                userAnswer = parseInt(document.getElementById('verticalAnswerInput').value);
            }

            if (isNaN(userAnswer)) {
                showToast('è¯·è¾“å…¥ç­”æ¡ˆ', 'error');
                return;
            }

            const isCorrect = userAnswer === q.answer;

            if (isCorrect) {
                correctCount++;
                streak++;
                showToast('âœ… æ­£ç¡®ï¼', 'success');
            } else {
                wrongAnswers.push({
                    question: q.display,
                    correctAnswer: q.answer,
                    userAnswer: userAnswer,
                    type: q.type
                });
                streak = 0;
                showToast('âŒ é”™è¯¯ï¼', 'error');
            }

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // è·³è¿‡é¢˜ç›®
        function skipQuestion() {
            const q = questions[currentQuestionIndex];
            wrongAnswers.push({
                question: q.display,
                correctAnswer: q.answer,
                userAnswer: 'è·³è¿‡',
                type: q.type
            });

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            clearInterval(timerInterval);

            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const accuracy = Math.round((correctCount / questions.length) * 100);

            document.getElementById('finalScore').textContent = accuracy;
            document.getElementById('resultTotal').textContent = questions.length;
            document.getElementById('resultCorrect').textContent = correctCount;
            document.getElementById('resultWrong').textContent = questions.length - correctCount;
            document.getElementById('resultTime').textContent = formatTime(totalTime);

            // è®¡ç®—å„éƒ¨åˆ†æˆç»©
            const oralCount = settings.oralCount || 0;
            const verticalCount = settings.verticalCount || 0;

            let oralCorrect = 0;
            let verticalCorrect = 0;

            wrongAnswers.forEach(w => {
                if (w.type === 'oral') {
                    // é”™é¢˜
                } else {
                    // é”™é¢˜
                }
            });

            // ç»Ÿè®¡å„éƒ¨åˆ†æ­£ç¡®æ•°
            for (let i = 0; i < oralCount; i++) {
                const q = questions[i];
                const isWrong = wrongAnswers.some(w => w.question === q.display);
                if (!isWrong) oralCorrect++;
            }

            for (let i = 0; i < verticalCount; i++) {
                const q = questions[oralCount + i];
                if (q) {
                    const isWrong = wrongAnswers.some(w => w.question === q.display);
                    if (!isWrong) verticalCorrect++;
                }
            }

            // æ˜¾ç¤ºå„éƒ¨åˆ†æˆç»©
            let sectionStatsHTML = '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';

            if (oralCount > 0) {
                const oralAccuracy = oralCount > 0 ? Math.round((oralCorrect / oralCount) * 100) : 0;
                sectionStatsHTML += `
                    <div style="padding: 10px; background: white; border-radius: 8px; border-left: 3px solid var(--primary-color);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">å£ç®—é¢˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${oralCorrect}/${oralCount}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">æ­£ç¡®ç‡ï¼š${oralAccuracy}%</div>
                    </div>
                `;
            }

            if (verticalCount > 0) {
                const verticalAccuracy = verticalCount > 0 ? Math.round((verticalCorrect / verticalCount) * 100) : 0;
                sectionStatsHTML += `
                    <div style="padding: 10px; background: white; border-radius: 8px; border-left: 3px solid var(--secondary-color);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">ç«–å¼é¢˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--secondary-color);">${verticalCorrect}/${verticalCount}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">æ­£ç¡®ç‡ï¼š${verticalAccuracy}%</div>
                    </div>
                `;
            }

            sectionStatsHTML += '</div>';
            document.getElementById('sectionStatsContent').innerHTML = sectionStatsHTML;
            document.getElementById('sectionStats').style.display = oralCount > 0 && verticalCount > 0 ? 'block' : 'none';

            // è¯„ä»·
            let title = '';
            if (accuracy >= 95) title = 'ğŸ† å¤ªæ£’äº†ï¼';
            else if (accuracy >= 85) title = 'ğŸ‰ å¾ˆä¼˜ç§€ï¼';
            else if (accuracy >= 70) title = 'ğŸ‘ ç»§ç»­åŠ æ²¹ï¼';
            else if (accuracy >= 60) title = 'ğŸ’ª éœ€è¦åŠªåŠ›ï¼';
            else title = 'ğŸ“š å¤šå¤šç»ƒä¹ ï¼';

            document.getElementById('resultTitle').textContent = title;

            // æ˜¾ç¤ºé”™é¢˜
            if (wrongAnswers.length > 0) {
                document.getElementById('wrongAnswersSection').style.display = 'block';
                document.getElementById('wrongAnswersList').innerHTML = wrongAnswers.map(w => `
                    <div class="wrong-item">
                        <div class="wrong-question">
                            <span style="font-size: 0.85rem; padding: 3px 8px; border-radius: 4px; margin-right: 8px; ${w.type === 'oral' ? 'background: #dbeafe; color: #1e40af;' : 'background: #fce7f3; color: #9d174d;'}">${w.type === 'oral' ? 'å£ç®—' : 'ç«–å¼'}</span>
                            ${w.question}
                        </div>
                        <div class="wrong-answer-info">
                            æ­£ç¡®ç­”æ¡ˆï¼š<span style="color: var(--success-color); font-weight: 600;">${w.correctAnswer}</span>
                            ä½ çš„ç­”æ¡ˆï¼š<span style="color: var(--danger-color);">${w.userAnswer}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('wrongAnswersSection').style.display = 'none';
            }

            // ä¿å­˜è®°å½•
            saveHistory(accuracy, totalTime);

            showSection('resultSection');
        }

        // é‡æ–°ç»ƒä¹ 
        function restart() {
            startPractice();
        }

        // é‡ç»ƒé”™é¢˜
        function practiceWrong() {
            if (wrongAnswers.length === 0) {
                showToast('æ²¡æœ‰é”™é¢˜éœ€è¦é‡ç»ƒ', 'error');
                return;
            }

            questions = wrongAnswers.map(w => {
                if (w.type === 'oral') {
                    return {
                        type: 'oral',
                        question: w.question,
                        answer: w.correctAnswer,
                        display: w.question
                    };
                } else {
                    // ä» display è§£æç«–å¼é¢˜
                    const parts = w.question.split(' ');
                    const num1 = parseInt(parts[0]);
                    const operator = parts[1];
                    const num2 = parseInt(parts[2]);
                    return {
                        type: 'vertical',
                        num1: num1,
                        num2: num2,
                        operator: operator,
                        answer: w.correctAnswer,
                        display: w.question
                    };
                }
            });

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');
        }

        // è¿”å›ä¸»é¡µ
        function goHome() {
            clearInterval(timerInterval);
            loadStats();
            showSection('homeSection');
        }

        // æ˜¾ç¤ºæ‰“å°è®¾ç½®å¯¹è¯æ¡†
        function showPrintDialog() {
            document.getElementById('printDialog').style.display = 'flex';
        }

        // å…³é—­æ‰“å°è®¾ç½®å¯¹è¯æ¡†
        function closePrintDialog() {
            document.getElementById('printDialog').style.display = 'none';
        }

        // ç¡®è®¤ç”Ÿæˆè¯•å·
        function confirmGeneratePrint() {
            const copies = parseInt(document.getElementById('printCopies').value);
            const sameQuestions = document.getElementById('sameQuestions').checked;

            closePrintDialog();
            generatePrint(copies, sameQuestions);
        }

        // ç”Ÿæˆæ‰“å°è¯•å·
        function generatePrint(copies = 1, sameQuestions = true) {
            const printContent = document.getElementById('printContent');
            let html = '';

            // ä¿å­˜åŸå§‹è®¾ç½®
            const originalSettings = {...settings};

            for (let copyIndex = 0; copyIndex < copies; copyIndex++) {
                // å¦‚æœä¸æ˜¯ä½¿ç”¨ç›¸åŒé¢˜ç›®ï¼Œåˆ™é‡æ–°ç”Ÿæˆé¢˜ç›®
                if (!sameQuestions && copyIndex > 0) {
                    // é‡æ–°ç”Ÿæˆé¢˜ç›®
                    const oralChecked = originalSettings.oralChecked;
                    const verticalChecked = originalSettings.verticalChecked;
                    const grade = originalSettings.grade;
                    const difficulty = originalSettings.difficulty;

                    const operationCheckboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
                    const operations = Array.from(operationCheckboxes).map(cb => cb.value).filter(op => ['add', 'subtract', 'multiply', 'divide'].includes(op));

                    questions = [];

                    if (oralChecked) {
                        const oralCount = originalSettings.oralCount || 0;
                        for (let i = 0; i < oralCount; i++) {
                            const op = operations[random(0, operations.length - 1)];
                            questions.push(generateOralQuestion(grade, difficulty, op));
                        }
                    }

                    if (verticalChecked) {
                        const verticalCount = originalSettings.verticalCount || 0;
                        for (let i = 0; i < verticalCount; i++) {
                            const op = operations[random(0, operations.length - 1)];
                            questions.push(generateVerticalQuestion(grade, difficulty, op));
                        }
                    }
                } else if (copyIndex > 0) {
                    // ä½¿ç”¨ç›¸åŒé¢˜ç›®ï¼Œä¸éœ€è¦é‡æ–°ç”Ÿæˆ
                } else {
                    // ç¬¬ä¸€ä»½ï¼Œéœ€è¦å…ˆç”Ÿæˆé¢˜ç›®
                    if (!generateQuestions()) {
                        showToast('âš ï¸ ç”Ÿæˆè¯•å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®', 'error');
                        return;
                    }
                }

                const oralCount = settings.oralCount || 0;
                const verticalCount = settings.verticalCount || 0;

                // æ¯ä»½è¯•å·ç”¨ä¸€ä¸ªwrapperåŒ…è£¹ï¼Œé¿å…å†…éƒ¨å…ƒç´ è¢«åˆ†é¡µè§„åˆ™å½±å“
                html += '<div class="print-copy-wrapper">';

                // æ¯ä»½è¯•å·éƒ½æ·»åŠ æŠ¬å¤´
                html += '<div class="print-header">';
                html += '<h1>å°å­¦æ•°å­¦ç»ƒä¹ é¢˜</h1>';
                html += '</div>';
                html += '<div class="print-info">';
                html += '<div>å§“åï¼š__________</div>';
                html += '<div>æ—¥æœŸï¼š__________</div>';
                html += '<div>ç”¨æ—¶ï¼š__________</div>';
                html += '<div>å¾—åˆ†ï¼š__________</div>';
                html += '</div>';

                // æ‰“å°å£ç®—é¢˜
                if (oralCount > 0) {
                    html += '<div class="print-section">';
                    // æ ¹æ®æ˜¯å¦æœ‰ç«–å¼é¢˜å†³å®šæ ‡é¢˜
                    const oralTitle = 'å£ç®—é¢˜';
                    html += '<div class="print-section-title">' + oralTitle + 'ï¼ˆæ¯é¢˜2åˆ†ï¼Œå…±' + (oralCount * 2) + 'åˆ†ï¼‰</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; align-items: center;">';

                    for (let i = 0; i < oralCount; i++) {
                        const q = questions[i];
                        const questionText = q.question.toString();
                        html += `
                            <div class="print-oral">${questionText}&nbsp;=&nbsp;____</div>
                        `;
                    }

                    html += '</div></div>';
                }

                // æ‰“å°ç«–å¼é¢˜
                if (verticalCount > 0) {
                    html += '<div class="print-section">';
                    const verticalTitle = 'ç«–å¼é¢˜';
                    html += '<div class="print-section-title">' + verticalTitle + 'ï¼ˆç”¨ç«–å¼è®¡ç®—ï¼Œæ¯é¢˜2åˆ†ï¼Œå…±' + (verticalCount * 2) + 'åˆ†ï¼‰</div>';
                    html += '<div style="display: flex; flex-wrap: wrap;">';

                    for (let i = 0; i < verticalCount; i++) {
                        const q = questions[oralCount + i];
                        const num1Str = q.num1.toString();
                        const num2Str = q.num2.toString();
                        const maxLength = Math.max(num1Str.length, num2Str.length);

                        html += `
                            <div class="print-vertical">
                                <div class="print-vertical-horizontal">${q.display}&nbsp;=&nbsp;____</div>
                                <div class="print-vertical-calculation">
                                    <div class="print-vertical-numbers">
                                        <div>${'&nbsp;'.repeat(maxLength - num1Str.length)}${num1Str}</div>
                                        <div>${q.operator}&nbsp;${'&nbsp;'.repeat(maxLength - num2Str.length)}${num2Str}</div>
                                    </div>
                                    <div class="print-vertical-line"></div>
                                    <div class="print-vertical-answer"></div>
                                </div>
                            </div>
                        `;
                    }

                    html += '</div></div>';
                }

                html += '</div>'; // ç»“æŸ print-copy-wrapper
            }

            // æ¢å¤åŸå§‹è®¾ç½®
            settings = originalSettings;

            printContent.innerHTML = html;

            // æ˜¾ç¤ºæç¤º
            if (copies > 1) {
                showToast(`âœ… å·²ç”Ÿæˆ${copies}ä»½è¯•å·ï¼Œå‡†å¤‡æ‰“å°...`, 'success');
                setTimeout(() => {
                    window.print();
                }, 500);
            } else {
                window.print();
            }
        }

        // ä¿å­˜å†å²è®°å½•
        function saveHistory(accuracy, time) {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');

            history.unshift({
                date: new Date().toLocaleString('zh-CN'),
                grade: settings.grade,
                difficulty: settings.difficulty,
                count: questions.length,
                correct: correctCount,
                total: questions.length,
                accuracy: accuracy,
                time: time,
                types: settings.oralChecked && settings.verticalChecked ? 'æ··åˆ' : (settings.oralChecked ? 'å£ç®—' : 'ç«–å¼')
            });

            if (history.length > 50) history.pop();

            localStorage.setItem('mathPracticeHistory', JSON.stringify(history));
            loadStats();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— ç»ƒä¹ è®°å½•</p>';
                return;
            }

            historyList.innerHTML = history.map((h, i) => `
                <div class="history-item">
                    <div class="history-date">${h.date} | ${h.types || 'æ··åˆ'}</div>
                    <div class="history-stats">
                        <span>æ­£ç¡®ç‡ï¼š${h.accuracy}%</span>
                        <span>é¢˜ç›®ï¼š${h.correct}/${h.total}</span>
                        <span>ç”¨æ—¶ï¼š${formatTime(h.time)}</span>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            loadHistory();
            showSection('historySection');
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»ƒä¹ è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('mathPracticeHistory');
                loadHistory();
                loadStats();
                showToast('è®°å½•å·²æ¸…ç©º');
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');

            const today = new Date().toDateString();
            const todayCount = history.filter(h => new Date(h.date).toDateString() === today).length;
            document.getElementById('todayCount').textContent = todayCount;

            if (history.length > 0) {
                const avgAcc = Math.round(history.reduce((sum, h) => sum + h.accuracy, 0) / history.length);
                document.getElementById('avgAccuracy').textContent = avgAcc + '%';
            }

            const totalQuestions = history.reduce((sum, h) => sum + h.total, 0);
            document.getElementById('totalQuestions').textContent = totalQuestions;

            const bestStreak = parseInt(localStorage.getItem('mathPracticeBestStreak') || '0');
            document.getElementById('bestStreak').textContent = bestStreak;
        }

        // è¯»é¢˜
        function readQuestion() {
            const q = questions[currentQuestionIndex];
            let text;

            if (q.type === 'oral') {
                text = q.question.replace('Ã—', 'ä¹˜ä»¥').replace('Ã·', 'é™¤ä»¥').replace('+', 'åŠ ').replace('-', 'å‡');
                text += 'ç­‰äºå‡ ';
            } else {
                text = `${q.num1} ${q.operator === '+' ? 'åŠ ' : q.operator === '-' ? 'å‡' : q.operator === 'Ã—' ? 'ä¹˜ä»¥' : 'é™¤ä»¥'} ${q.num2}ï¼Œç«–å¼è®¡ç®—`;
            }

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½', 'error');
            }
        }

        // é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        }
    </script>
</body>
</html>
