<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ•°å­¦å£ç®—å¿«é€Ÿå‡ºé¢˜å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --secondary-color: #8b5cf6;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --info-color: #3b82f6;
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #7c3aed;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .question-box {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            margin: 30px 0;
        }

        .question-text {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .answer-input {
            font-size: 2rem;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .result-summary {
            text-align: center;
            padding: 30px;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
        }

        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
        }

        .score-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .result-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-item-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .result-item-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .wrong-answers {
            background: #fef2f2;
            border-left: 4px solid var(--danger-color);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .wrong-answers h3 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }

        .wrong-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wrong-question {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .wrong-answer-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .wrong-answer-info span {
            display: inline-block;
            margin: 0 10px;
        }

        .print-area {
            display: none;
        }

        @media print {
            body * {
                visibility: hidden;
            }

            .print-area, .print-area * {
                visibility: visible;
            }

            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block;
                background: white;
                padding: 20px;
            }

            .print-header {
                text-align: center;
                margin-bottom: 20px;
                page-break-after: avoid;
            }

            .print-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 20px;
                padding-bottom: 10px;
                border-bottom: 2px solid #000;
            }

            .print-question {
                display: inline-block;
                width: 30%;
                margin: 10px 0;
                font-size: 1.1rem;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: var(--shadow);
            transform: translateX(5px);
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .history-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .history-stats span {
            font-weight: 600;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.6rem;
            }

            .card {
                padding: 20px;
            }

            .question-text {
                font-size: 2rem;
            }

            .answer-input {
                font-size: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .result-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§® å°å­¦æ•°å­¦å£ç®—å¿«é€Ÿå‡ºé¢˜å™¨</h1>
            <p>è®©æ•°å­¦ç»ƒä¹ æ›´ç®€å•ã€æ›´æœ‰è¶£ï¼</p>
        </header>

        <!-- ä¸»ç•Œé¢ -->
        <div id="homeSection" class="section active">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ¯ å¼€å§‹ç»ƒä¹ </h2>

                <div class="form-group">
                    <label>ğŸ“š é€‰æ‹©å¹´çº§</label>
                    <select id="gradeSelect">
                        <option value="1">ä¸€å¹´çº§ (6-7å²) - 20ä»¥å†…åŠ å‡æ³•</option>
                        <option value="2">äºŒå¹´çº§ (7-8å²) - 100ä»¥å†…åŠ å‡æ³•ã€ä¹˜æ³•å£è¯€</option>
                        <option value="3" selected>ä¸‰å¹´çº§ (8-9å²) - 1000ä»¥å†…åŠ å‡ä¹˜é™¤</option>
                        <option value="4">å››å¹´çº§ (9-10å²) - å¤§æ•°è¿ç®—ã€å°æ•°åŠ å‡</option>
                        <option value="5">äº”å¹´çº§ (10-11å²) - å°æ•°ä¹˜é™¤ã€åˆ†æ•°åŠ å‡</option>
                        <option value="6">å…­å¹´çº§ (11-12å²) - åˆ†æ•°ä¹˜é™¤ã€ç™¾åˆ†æ•°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>âœï¸ è¿ç®—ç±»å‹</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" value="add" checked> åŠ æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="subtract" checked> å‡æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="multiply"> ä¹˜æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="divide"> é™¤æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="mixed"> æ··åˆè¿ç®—
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ“Š éš¾åº¦çº§åˆ«</label>
                    <select id="difficultySelect">
                        <option value="easy">ç®€å• - åŸºç¡€è¿ç®—</option>
                        <option value="medium" selected>ä¸­ç­‰ - éœ€è¦è¿›é€€ä½</option>
                        <option value="hard">å›°éš¾ - å¤æ‚è¿ç®—</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“ é¢˜ç›®æ•°é‡</label>
                    <select id="questionCount">
                        <option value="10">10é¢˜ï¼ˆå¿«é€Ÿç»ƒä¹ ï¼‰</option>
                        <option value="20" selected>20é¢˜ï¼ˆæ ‡å‡†ç»ƒä¹ ï¼‰</option>
                        <option value="50">50é¢˜ï¼ˆå¼ºåŒ–è®­ç»ƒï¼‰</option>
                        <option value="100">100é¢˜ï¼ˆç»¼åˆæµ‹è¯•ï¼‰</option>
                    </select>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startPractice()">ğŸ® å¼€å§‹ç»ƒä¹ </button>
                    <button class="btn btn-info" onclick="startTimedTest()">â±ï¸ è®¡æ—¶æµ‹è¯•</button>
                    <button class="btn btn-secondary" onclick="generatePrint()">ğŸ–¨ï¸ ç”Ÿæˆè¯•å·</button>
                    <button class="btn btn-primary" onclick="showHistory()">ğŸ“– æŸ¥çœ‹è®°å½•</button>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayCount">0</div>
                        <div class="stat-label">ä»Šæ—¥ç»ƒä¹ ï¼ˆæ¬¡ï¼‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAccuracy">0%</div>
                        <div class="stat-label">å¹³å‡æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalQuestions">0</div>
                        <div class="stat-label">ç´¯è®¡åšé¢˜ï¼ˆé¢˜ï¼‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestStreak">0</div>
                        <div class="stat-label">æœ€ä½³è¿ç»­ç­”å¯¹</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­”é¢˜ç•Œé¢ -->
        <div id="practiceSection" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <span style="font-size: 1.2rem; font-weight: 600;">ç¬¬ <span id="currentQ">1</span>/<span id="totalQ">20</span> é¢˜</span>
                    </div>
                    <div class="timer" id="timer">00:00</div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>

                <div class="question-box">
                    <div class="question-text" id="questionText">23 + 15 = ?</div>
                    <input type="number" class="answer-input" id="answerInput" placeholder="è¾“å…¥ç­”æ¡ˆ" onkeypress="handleKeyPress(event)">
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitAnswer()">âœ… æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="skipQuestion()">â­ï¸ è·³è¿‡</button>
                    <button class="btn btn-info" onclick="readQuestion()">ğŸ”Š è¯»é¢˜</button>
                </div>
            </div>
        </div>

        <!-- æˆç»©ç•Œé¢ -->
        <div id="resultSection" class="section">
            <div class="card">
                <div class="result-summary">
                    <div class="score-circle">
                        <div class="score-value" id="finalScore">90</div>
                        <div class="score-label">åˆ†</div>
                    </div>

                    <h2 id="resultTitle" style="margin-bottom: 20px;">ğŸ‰ å¤ªæ£’äº†ï¼</h2>

                    <div class="result-stats">
                        <div class="result-item">
                            <div class="result-item-label">é¢˜ç›®æ•°é‡</div>
                            <div class="result-item-value" id="resultTotal">20</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">æ­£ç¡®é¢˜æ•°</div>
                            <div class="result-item-value" style="color: var(--success-color);" id="resultCorrect">18</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">é”™è¯¯é¢˜æ•°</div>
                            <div class="result-item-value" style="color: var(--danger-color);" id="resultWrong">2</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">ç”¨æ—¶</div>
                            <div class="result-item-value" id="resultTime">03:45</div>
                        </div>
                    </div>

                    <div id="wrongAnswersSection" class="wrong-answers" style="display: none;">
                        <h3>âŒ é”™é¢˜å›é¡¾</h3>
                        <div id="wrongAnswersList"></div>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="restart()">ğŸ”„ å†ç»ƒä¸€æ¬¡</button>
                        <button class="btn btn-secondary" onclick="practiceWrong()">ğŸ“• é‡ç»ƒé”™é¢˜</button>
                        <button class="btn btn-info" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•ç•Œé¢ -->
        <div id="historySection" class="section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“– ç»ƒä¹ è®°å½•</h2>
                <div class="history-list" id="historyList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— ç»ƒä¹ è®°å½•</p>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    <button class="btn btn-danger" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
                </div>
            </div>
        </div>

        <!-- æ‰“å°åŒºåŸŸ -->
        <div class="print-area" id="printArea">
            <div class="print-header">
                <h1>å°å­¦æ•°å­¦å£ç®—ç»ƒä¹ é¢˜</h1>
            </div>
            <div class="print-info">
                <div>å§“åï¼š__________</div>
                <div>æ—¥æœŸï¼š__________</div>
                <div>ç”¨æ—¶ï¼š__________</div>
                <div>å¾—åˆ†ï¼š__________</div>
            </div>
            <div id="printQuestions"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let questions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongAnswers = [];
        let startTime = null;
        let timerInterval = null;
        let settings = {};
        let streak = 0;

        // åˆå§‹åŒ–
        window.onload = function() {
            loadStats();
            loadHistory();
        };

        // å·¥å…·å‡½æ•°
        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // å‡ºé¢˜ç®—æ³•
        function generateAddition(grade, difficulty) {
            let min, max;

            switch(grade) {
                case 1: min = 1; max = 10; break;
                case 2: min = 1; max = 50; break;
                case 3: min = 1; max = 100; break;
                case 4: min = 1; max = 500; break;
                case 5: min = 1; max = 1000; break;
                case 6: min = 1; max = 5000; break;
                default: min = 1; max = 100;
            }

            let a = random(min, max);
            let b = random(min, max);

            if (difficulty === 'easy') {
                // ç®€å•ï¼šä¸è¿›ä½
                a = random(1, Math.min(9, max));
                b = random(1, Math.min(9, max));
            } else if (difficulty === 'hard') {
                // å›°éš¾ï¼šå¤§æ•°è¿ç®—
                a = random(min, max);
                b = random(min, max);
            }

            return {
                question: `${a} + ${b}`,
                answer: a + b
            };
        }

        function generateSubtraction(grade, difficulty) {
            let min, max;

            switch(grade) {
                case 1: min = 1; max = 10; break;
                case 2: min = 1; max = 50; break;
                case 3: min = 1; max = 100; break;
                case 4: min = 1; max = 500; break;
                case 5: min = 1; max = 1000; break;
                case 6: min = 1; max = 5000; break;
                default: min = 1; max = 100;
            }

            let answer = random(min, max);
            let b = random(min, answer);
            let a = answer + b;

            if (difficulty === 'easy') {
                // ç®€å•ï¼šä¸é€€ä½
                answer = random(1, Math.min(9, max));
                b = random(1, answer);
                a = answer + b;
            }

            return {
                question: `${a} - ${b}`,
                answer: answer
            };
        }

        function generateMultiplication(grade, difficulty) {
            if (grade === 2) {
                // ä¹˜æ³•å£è¯€
                const a = random(1, 9);
                const b = random(1, 9);
                return { question: `${a} Ã— ${b}`, answer: a * b };
            } else if (grade === 3) {
                // ä¸¤ä½æ•°ä¹˜ä¸€ä½æ•°
                const a = random(10, 99);
                const b = random(2, 9);
                return { question: `${a} Ã— ${b}`, answer: a * b };
            } else if (grade >= 4) {
                // ä¸¤ä½æ•°ä¹˜ä¸¤ä½æ•°
                const a = random(10, 99);
                const b = random(10, difficulty === 'easy' ? 20 : 99);
                return { question: `${a} Ã— ${b}`, answer: a * b };
            }
            return { question: '2 Ã— 3', answer: 6 };
        }

        function generateDivision(grade, difficulty) {
            let b, answer;

            if (grade === 3) {
                b = random(2, 9);
                answer = random(1, 12);
            } else if (grade >= 4) {
                b = random(2, difficulty === 'easy' ? 9 : 20);
                answer = random(1, 50);
            } else {
                return { question: '6 Ã· 2', answer: 3 };
            }

            const a = b * answer;
            return { question: `${a} Ã· ${b}`, answer: answer };
        }

        function generateMixed(grade, difficulty) {
            // ç®€å•çš„ä¸¤æ­¥è¿ç®—
            const types = ['add_multiply', 'subtract_divide'];
            const type = types[random(0, types.length - 1)];

            if (type === 'add_multiply') {
                const b = random(2, 9);
                const c = random(2, 9);
                const bc = b * c;
                const a = random(1, 50);
                return { question: `${a} + ${b} Ã— ${c}`, answer: a + bc };
            } else {
                const b = random(2, 9);
                const answer = random(1, 12);
                const a = b * answer;
                const c = random(1, 50);
                return { question: `${a} Ã· ${b} + ${c}`, answer: answer + c };
            }
        }

        function generateQuestions() {
            const count = parseInt(document.getElementById('questionCount').value);
            const grade = parseInt(document.getElementById('gradeSelect').value);
            const difficulty = document.getElementById('difficultySelect').value;

            const operationCheckboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
            const operations = Array.from(operationCheckboxes).map(cb => cb.value);

            if (operations.length === 0) {
                showToast('è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¿ç®—ç±»å‹', 'error');
                return false;
            }

            questions = [];

            for (let i = 0; i < count; i++) {
                const op = operations[random(0, operations.length - 1)];
                let q;

                switch(op) {
                    case 'add':
                        q = generateAddition(grade, difficulty);
                        break;
                    case 'subtract':
                        q = generateSubtraction(grade, difficulty);
                        break;
                    case 'multiply':
                        q = generateMultiplication(grade, difficulty);
                        break;
                    case 'divide':
                        q = generateDivision(grade, difficulty);
                        break;
                    case 'mixed':
                        q = generateMixed(grade, difficulty);
                        break;
                    default:
                        q = generateAddition(grade, difficulty);
                }

                questions.push(q);
            }

            settings = { grade, difficulty, count };
            return true;
        }

        // å¼€å§‹ç»ƒä¹ 
        function startPractice() {
            if (!generateQuestions()) return;

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');

            document.getElementById('answerInput').focus();
        }

        // è®¡æ—¶æµ‹è¯•
        function startTimedTest() {
            if (!generateQuestions()) return;

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');

            document.getElementById('answerInput').focus();
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            const q = questions[currentQuestionIndex];
            document.getElementById('questionText').textContent = q.question + ' = ?';
            document.getElementById('currentQ').textContent = currentQuestionIndex + 1;
            document.getElementById('totalQ').textContent = questions.length;

            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            document.getElementById('answerInput').value = '';
            document.getElementById('answerInput').focus();
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').textContent = formatTime(elapsed);
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            const userAnswer = parseInt(document.getElementById('answerInput').value);

            if (isNaN(userAnswer)) {
                showToast('è¯·è¾“å…¥ç­”æ¡ˆ', 'error');
                return;
            }

            const q = questions[currentQuestionIndex];
            const isCorrect = userAnswer === q.answer;

            if (isCorrect) {
                correctCount++;
                streak++;
                showToast('âœ… æ­£ç¡®ï¼', 'success');
            } else {
                wrongAnswers.push({
                    question: q.question,
                    correctAnswer: q.answer,
                    userAnswer: userAnswer
                });
                streak = 0;
                showToast('âŒ é”™è¯¯ï¼', 'error');
            }

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // è·³è¿‡é¢˜ç›®
        function skipQuestion() {
            const q = questions[currentQuestionIndex];
            wrongAnswers.push({
                question: q.question,
                correctAnswer: q.answer,
                userAnswer: 'è·³è¿‡'
            });

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            clearInterval(timerInterval);

            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const accuracy = Math.round((correctCount / questions.length) * 100);

            document.getElementById('finalScore').textContent = accuracy;
            document.getElementById('resultTotal').textContent = questions.length;
            document.getElementById('resultCorrect').textContent = correctCount;
            document.getElementById('resultWrong').textContent = questions.length - correctCount;
            document.getElementById('resultTime').textContent = formatTime(totalTime);

            // è¯„ä»·
            let title = '';
            if (accuracy >= 95) title = 'ğŸ† å¤ªæ£’äº†ï¼';
            else if (accuracy >= 85) title = 'ğŸ‰ å¾ˆä¼˜ç§€ï¼';
            else if (accuracy >= 70) title = 'ğŸ‘ ç»§ç»­åŠ æ²¹ï¼';
            else if (accuracy >= 60) title = 'ğŸ’ª éœ€è¦åŠªåŠ›ï¼';
            else title = 'ğŸ“š å¤šå¤šç»ƒä¹ ï¼';

            document.getElementById('resultTitle').textContent = title;

            // æ˜¾ç¤ºé”™é¢˜
            if (wrongAnswers.length > 0) {
                document.getElementById('wrongAnswersSection').style.display = 'block';
                document.getElementById('wrongAnswersList').innerHTML = wrongAnswers.map(w => `
                    <div class="wrong-item">
                        <div class="wrong-question">${w.question} = ?</div>
                        <div class="wrong-answer-info">
                            æ­£ç¡®ç­”æ¡ˆï¼š<span style="color: var(--success-color); font-weight: 600;">${w.correctAnswer}</span>
                            ä½ çš„ç­”æ¡ˆï¼š<span style="color: var(--danger-color);">${w.userAnswer}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('wrongAnswersSection').style.display = 'none';
            }

            // ä¿å­˜è®°å½•
            saveHistory(accuracy, totalTime);

            showSection('resultSection');
        }

        // é‡æ–°ç»ƒä¹ 
        function restart() {
            startPractice();
        }

        // é‡ç»ƒé”™é¢˜
        function practiceWrong() {
            if (wrongAnswers.length === 0) {
                showToast('æ²¡æœ‰é”™é¢˜éœ€è¦é‡ç»ƒ', 'error');
                return;
            }

            questions = wrongAnswers.map(w => ({
                question: w.question,
                answer: w.correctAnswer
            }));

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');
        }

        // è¿”å›ä¸»é¡µ
        function goHome() {
            clearInterval(timerInterval);
            loadStats();
            showSection('homeSection');
        }

        // ç”Ÿæˆæ‰“å°è¯•å·
        function generatePrint() {
            if (!generateQuestions()) return;

            const printQuestions = document.getElementById('printQuestions');
            printQuestions.innerHTML = questions.map((q, i) => `
                <div class="print-question">${i + 1}. ${q.question} = ______</div>
            `).join('');

            window.print();
        }

        // ä¿å­˜å†å²è®°å½•
        function saveHistory(accuracy, time) {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');

            history.unshift({
                date: new Date().toLocaleString('zh-CN'),
                grade: settings.grade,
                difficulty: settings.difficulty,
                count: settings.count,
                correct: correctCount,
                total: questions.length,
                accuracy: accuracy,
                time: time
            });

            // åªä¿ç•™æœ€è¿‘50æ¡è®°å½•
            if (history.length > 50) history.pop();

            localStorage.setItem('mathPracticeHistory', JSON.stringify(history));
            loadStats();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— ç»ƒä¹ è®°å½•</p>';
                return;
            }

            historyList.innerHTML = history.map((h, i) => `
                <div class="history-item">
                    <div class="history-date">${h.date}</div>
                    <div class="history-stats">
                        <span>æ­£ç¡®ç‡ï¼š${h.accuracy}%</span>
                        <span>é¢˜ç›®ï¼š${h.correct}/${h.total}</span>
                        <span>ç”¨æ—¶ï¼š${formatTime(h.time)}</span>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            loadHistory();
            showSection('historySection');
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»ƒä¹ è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('mathPracticeHistory');
                loadHistory();
                loadStats();
                showToast('è®°å½•å·²æ¸…ç©º');
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');

            // ä»Šæ—¥ç»ƒä¹ æ¬¡æ•°
            const today = new Date().toDateString();
            const todayCount = history.filter(h => new Date(h.date).toDateString() === today).length;
            document.getElementById('todayCount').textContent = todayCount;

            // å¹³å‡æ­£ç¡®ç‡
            if (history.length > 0) {
                const avgAcc = Math.round(history.reduce((sum, h) => sum + h.accuracy, 0) / history.length);
                document.getElementById('avgAccuracy').textContent = avgAcc + '%';
            }

            // ç´¯è®¡åšé¢˜
            const totalQuestions = history.reduce((sum, h) => sum + h.total, 0);
            document.getElementById('totalQuestions').textContent = totalQuestions;

            // æœ€ä½³è¿ç»­ç­”å¯¹
            const bestStreak = parseInt(localStorage.getItem('mathPracticeBestStreak') || '0');
            document.getElementById('bestStreak').textContent = bestStreak;
        }

        // è¯»é¢˜
        function readQuestion() {
            const q = questions[currentQuestionIndex];
            const text = q.question.replace('Ã—', 'ä¹˜ä»¥').replace('Ã·', 'é™¤ä»¥').replace('+', 'åŠ ').replace('-', 'å‡');

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text + 'ç­‰äºå‡ ');
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½', 'error');
            }
        }

        // é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        }

        // æ›´æ–°æœ€ä½³è¿ç»­ç­”å¯¹
        function updateBestStreak() {
            const current = parseInt(localStorage.getItem('mathPracticeBestStreak') || '0');
            if (streak > current) {
                localStorage.setItem('mathPracticeBestStreak', streak.toString());
            }
        }
    </script>
</body>
</html>
