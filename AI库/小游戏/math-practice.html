<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å­¦æ•°å­¦å¿«é€Ÿå‡ºé¢˜å™¨ v1.2.7 - å£ç®—+ç«–å¼+åº”ç”¨é¢˜+æ··åˆè¿ç®—+æ¯”è¾ƒé¢˜å‹+ä¸‰æ­¥è¿ç®—+é¢˜ç›®å»é‡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #10b981;
            --primary-dark: #059669;
            --secondary-color: #8b5cf6;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --success-color: #10b981;
            --info-color: #3b82f6;
            --bg-color: #f0fdf4;
            --card-bg: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--text-primary);
            margin: 0;
        }

        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        header h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
            padding: 30px;
            margin-bottom: 20px;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        select, input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .btn-secondary {
            background: var(--secondary-color);
            color: white;
        }

        .btn-secondary:hover {
            background: #7c3aed;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            border-radius: 12px;
            color: white;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .question-box {
            background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
            padding: 40px;
            border-radius: 16px;
            text-align: center;
            margin: 30px 0;
        }

        .question-text {
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .answer-input {
            font-size: 2rem;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
        }

        /* ç«–å¼æ ·å¼ */
        .vertical-question {
            background: white;
            padding: 30px;
            border-radius: 12px;
            margin: 20px auto;
            max-width: 300px;
            box-shadow: var(--shadow);
        }

        .vertical-expression {
            text-align: right;
            font-size: 1.8rem;
            font-family: 'Courier New', monospace;
            line-height: 1.8;
        }

        .vertical-number {
            padding: 5px 15px;
        }

        .vertical-operator {
            padding-right: 10px;
        }

        .vertical-line {
            border-top: 3px solid #333;
            margin: 5px 0;
        }

        .vertical-answer {
            padding: 5px 15px;
            font-weight: bold;
        }

        .vertical-input {
            width: 150px;
            font-size: 1.8rem;
            text-align: center;
            padding: 8px;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            margin-left: auto;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        .timer {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent-color);
            text-align: center;
            margin-bottom: 20px;
        }

        .result-summary {
            text-align: center;
            padding: 30px;
        }

        .score-circle {
            width: 200px;
            height: 200px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0 auto 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            flex-direction: column;
        }

        .score-value {
            font-size: 3.5rem;
            font-weight: bold;
        }

        .score-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        .result-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .result-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .result-item-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .result-item-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
        }

        .wrong-answers {
            background: #fef2f2;
            border-left: 4px solid var(--danger-color);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }

        .wrong-answers h3 {
            color: var(--danger-color);
            margin-bottom: 15px;
        }

        .wrong-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .wrong-question {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .wrong-answer-info {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .wrong-answer-info span {
            display: inline-block;
            margin: 0 10px;
        }

        /* é¢˜å‹æ ‡ç­¾ */
        .question-type-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 15px;
        }

        .type-oral {
            background: #dbeafe;
            color: #1e40af;
        }

        .type-vertical {
            background: #fce7f3;
            color: #9d174d;
        }

        .type-word-problem {
            background: #ddd6fe;
            color: #5b21b6;
        }

        /* æ‰“å°æ ·å¼ */
        .print-area {
            display: none;
        }

        @media print {
            @page {
                margin: 10mm;
                size: A4;
            }

            @page:last {
                margin: 10mm;
            }

            /* å¼ºåˆ¶ä¸æ‰“å°ç©ºç™½é¡µ */
            * {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }

            html, body {
                height: auto;
                margin: 0;
                padding: 0;
                overflow: visible;
                min-height: 0;
                max-height: none;
            }

            /* ç¡®ä¿htmlå’Œbodyä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
            html::after, body::after {
                display: none;
                content: none;
            }

            @page {
                orphans: 0;
                widows: 0;
            }

            body * {
                visibility: hidden;
            }

            .print-area, .print-area * {
                visibility: visible;
            }

            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                display: block;
                background: white;
                padding: 6mm;
                box-sizing: border-box;
                height: auto;
                max-height: none;
                overflow: visible;
                page-break-after: avoid;
                break-after: avoid;
            }

            /* è¯•å·wrapperçš„åˆ†é¡µæ§åˆ¶ */
            .print-copy-wrapper {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            /* åªæœ‰å¤šä¸ªwrapperæ—¶æ‰åœ¨åé¢åˆ†é¡µ */
            .print-copy-wrapper:not(:only-child):not(:last-child) {
                page-break-after: always;
            }

            /* å”¯ä¸€ä¸€ä»½æˆ–æœ€åä¸€ä»½ä¸åˆ†é¡µ */
            .print-copy-wrapper:only-child {
                page-break-after: auto !important;
            }

            .print-copy-wrapper:last-child {
                page-break-after: auto !important;
            }

            /* ç¡®ä¿wrapperå†…éƒ¨æ‰€æœ‰å…ƒç´ éƒ½ä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
            .print-copy-wrapper > * {
                page-break-after: auto !important;
            }

            .print-header {
                text-align: center;
                margin-bottom: 8px;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            .print-header h1 {
                font-size: 1.2rem;
                font-weight: bold;
                margin: 0;
                padding: 0;
            }

            .print-section {
                margin-bottom: 8px;
                page-break-inside: avoid;
            }

            .print-section:last-child {
                margin-bottom: 0;
            }

            /* é˜²æ­¢å†…å®¹åˆ†é¡µ */
            #printContent {
                page-break-inside: avoid;
            }

            /* ç¡®ä¿printContentæœ¬èº«å’Œå†…éƒ¨æœ€åä¸€ä¸ªå…ƒç´ ä¸åˆ†é¡µ */
            #printContent > div:last-child {
                page-break-after: auto !important;
            }

            /* ç‰¹åˆ«å¤„ç†ï¼šprintContentåªæœ‰ä¸€ä¸ªå­å…ƒç´ æ—¶ï¼Œå®Œå…¨ä¸åˆ†é¡µ */
            #printContent:has(> div:only-child) {
                page-break-after: avoid !important;
            }

            #printContent:has(> div:only-child) > div {
                page-break-after: avoid !important;
            }

            .print-section {
                page-break-inside: avoid;
            }

            .print-oral, .print-vertical {
                page-break-inside: avoid;
            }

            .print-section-title {
                font-size: 0.95rem;
                font-weight: bold;
                margin-bottom: 8px;
                padding-bottom: 6px;
                border-bottom: 2px solid #000;
            }

            .print-oral {
                display: inline-block;
                width: 20%;
                margin: 5px 0.5% 8px 0.5%;
                font-size: 0.85rem;
                vertical-align: top;
                font-family: 'Courier New', monospace;
                white-space: nowrap;
                overflow: hidden;
                box-sizing: border-box;
                text-align: left;
                line-height: 1.4;
            }

            .print-oral .eq-align {
                display: inline-block;
                width: 100%;
            }

            .print-vertical {
                display: inline-block;
                width: 20%;
                margin: 5px 0.5% 8px 0.5%;
                vertical-align: top;
                font-family: 'Courier New', monospace;
                font-size: 0.75rem;
                line-height: 1.2;
                background: white;
                padding: 4px;
                border: 1px solid #ddd;
                border-radius: 3px;
                page-break-inside: avoid;
                box-sizing: border-box;
            }

            .print-vertical-calculation {
                text-align: right;
                margin: 3px 0;
            }

            .print-vertical-numbers {
                display: inline-block;
                text-align: right;
                font-size: 0.8rem;
                font-family: 'Courier New', Courier, monospace;  /* ä½¿ç”¨ç­‰å®½å­—ä½“ç¡®ä¿æ•°å­—å¯¹é½ */
            }

            .print-vertical-line {
                border-top: 0.5px solid #000;
                margin: 2px 0 2px 0;
            }

            .print-vertical-answer {
                min-height: 20px;
                margin-top: 2px;
            }

            .print-vertical-horizontal {
                font-size: 0.7rem;
                color: #333;
                margin-bottom: 3px;
                font-weight: 600;
                text-align: left;
                white-space: nowrap;
                font-family: 'Courier New', monospace;
            }

            .print-vertical-num {
                letter-spacing: 0;
            }

            .print-info {
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                padding-bottom: 6px;
                border-bottom: 2px solid #000;
                font-size: 0.85rem;
                page-break-after: avoid;
                page-break-inside: avoid;
            }

            /* è‰ç¨¿åŒºåŸŸæ ·å¼ */
            .print-draft-area {
                margin-top: 15px;
                padding: 10px;
                border: 1px dashed #999;
                border-radius: 5px;
                background: #fafafa;
                page-break-inside: avoid;
            }

            .print-draft-title {
                font-size: 0.9rem;
                font-weight: bold;
                color: #666;
                margin-bottom: 10px;
                text-align: center;
            }

            .print-draft-lines {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 15px 20px;
            }

            .print-draft-column {
                position: relative;
            }

            .print-draft-column::before {
                content: '';
                position: absolute;
                left: 0;
                right: 0;
                top: 0;
                bottom: 0;
                background-image: repeating-linear-gradient(
                    to bottom,
                    #e0e0e0 0px,
                    #e0e0e0 1px,
                    transparent 1px,
                    transparent calc(1.8rem + 1px)
                );
                background-repeat: repeat-y;
                background-size: 100% 1.8rem;
                pointer-events: none;
                z-index: 1;
            }

            .print-draft-item {
                position: relative;
                min-height: 1.8rem;
                margin-bottom: calc(1.8rem + 1px);
                z-index: 2;
            }
        }
            /* ç¡®ä¿æ‰“å°åŒºåŸŸçš„æœ€åä¸€ä¸ªå…ƒç´ ä¸ä¼šäº§ç”Ÿé¢å¤–åˆ†é¡µ */
            .print-area > *:last-child {
                page-break-after: auto !important;
            }

            /* é¢å¤–çš„é˜²ç©ºç™½é¡µæªæ–½ */
            #printContent {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            /* ç¡®ä¿bodyå’Œhtmlåœ¨æ‰“å°æ—¶ä¸ä¼šäº§ç”Ÿé¢å¤–é¡µé¢ */
            body {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            html {
                page-break-after: avoid !important;
                break-after: avoid !important;
            }

            /* ä½¿ç”¨breakå±æ€§çš„ç°ä»£æµè§ˆå™¨æ”¯æŒ */
            .print-copy-wrapper {
                break-inside: avoid;
            }

            .print-copy-wrapper:only-child {
                break-after: avoid !important;
            }

            .print-copy-wrapper:last-child {
                break-after: avoid !important;
            }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .toast.success {
            background: var(--success-color);
        }

        .toast.error {
            background: var(--danger-color);
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .checkbox-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .history-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .history-item:hover {
            box-shadow: var(--shadow);
            transform: translateX(5px);
        }

        .history-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 5px;
        }

        .history-stats {
            display: flex;
            gap: 15px;
            font-size: 0.9rem;
        }

        .history-stats span {
            font-weight: 600;
            color: var(--primary-color);
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.6rem;
            }

            .card {
                padding: 20px;
            }

            .question-text {
                font-size: 2rem;
            }

            .answer-input {
                font-size: 1.5rem;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .result-stats {
                grid-template-columns: 1fr;
            }

            .vertical-expression {
                font-size: 1.4rem;
            }

            .vertical-input {
                width: 120px;
                font-size: 1.4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ§® å°å­¦æ•°å­¦å¿«é€Ÿå‡ºé¢˜å™¨</h1>
            <p>å£ç®— + ç«–å¼ + åº”ç”¨é¢˜ + æ··åˆè¿ç®—ï¼Œè®©æ•°å­¦ç»ƒä¹ æ›´å…¨é¢ï¼</p>
        </header>

        <!-- ä¸»ç•Œé¢ -->
        <div id="homeSection" class="section active">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ¯ å¼€å§‹ç»ƒä¹ </h2>

                <div class="form-group">
                    <label>ğŸ“š é€‰æ‹©å¹´çº§</label>
                    <select id="gradeSelect">
                        <option value="1">ä¸€å¹´çº§ (6-7å²) - 20ä»¥å†…åŠ å‡æ³•</option>
                        <option value="2">äºŒå¹´çº§ (7-8å²) - 100ä»¥å†…åŠ å‡æ³•ã€ä¹˜æ³•å£è¯€</option>
                        <option value="3" selected>ä¸‰å¹´çº§ (8-9å²) - 1000ä»¥å†…åŠ å‡ä¹˜é™¤</option>
                        <option value="4">å››å¹´çº§ (9-10å²) - å¤§æ•°è¿ç®—ã€å°æ•°åŠ å‡</option>
                        <option value="5">äº”å¹´çº§ (10-11å²) - å°æ•°ä¹˜é™¤ã€åˆ†æ•°åŠ å‡</option>
                        <option value="6">å…­å¹´çº§ (11-12å²) - åˆ†æ•°ä¹˜é™¤ã€ç™¾åˆ†æ•°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“ é¢˜å‹é€‰æ‹©ï¼ˆè‡³å°‘é€‰ä¸€ç§ï¼‰</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="oralCheck" checked> å£ç®—é¢˜ï¼ˆæ¨ªå¼è®¡ç®—ï¼‰
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="verticalCheck" checked> ç«–å¼é¢˜ï¼ˆç¬”ç®—è®¡ç®—ï¼‰
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" id="wordProblemCheck"> åº”ç”¨é¢˜ï¼ˆæ–‡å­—é¢˜ï¼‰
                        </label>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">ğŸ’¡ æç¤ºï¼šå¯å•é€‰æˆ–å¤šé€‰ï¼Œé¢˜ç›®å°†æŒ‰é¡ºåºå‡ºç°</p>
                </div>

                <div class="form-group">
                    <label>âœï¸ è¿ç®—ç±»å‹ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" value="add" checked> åŠ æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="subtract" checked> å‡æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="multiply"> ä¹˜æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="divide"> é™¤æ³•
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="mixed"> æ··åˆè¿ç®—
                        </label>
                        <label class="checkbox-item">
                            <input type="checkbox" value="compare"> æ¯”è¾ƒé¢˜å‹ï¼ˆæ¯”å¤šæ¯”å°‘ï¼‰
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ“Š éš¾åº¦çº§åˆ«</label>
                    <select id="difficultySelect">
                        <option value="easy">ç®€å• - åŸºç¡€è¿ç®—</option>
                        <option value="medium" selected>ä¸­ç­‰ - éœ€è¦è¿›é€€ä½</option>
                        <option value="hard">å›°éš¾ - å¤æ‚è¿ç®—</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ“Š é¢˜ç›®æ•°é‡è®¾ç½®</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="font-size: 0.95rem; color: var(--primary-color); font-weight: 600;">ğŸ“ å£ç®—é¢˜</label>
                                <select id="oralCount">
                                    <option value="12">12é¢˜</option>
                                    <option value="16">16é¢˜</option>
                                    <option value="20" selected>20é¢˜</option>
                                    <option value="24">24é¢˜</option>
                                    <option value="28">28é¢˜</option>
                                    <option value="32">32é¢˜</option>
                                    <option value="36">36é¢˜</option>
                                    <option value="40">40é¢˜</option>
                                </select>
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 0.95rem; color: var(--secondary-color); font-weight: 600;">âœï¸ ç«–å¼é¢˜</label>
                                <select id="verticalCount">
                                    <option value="8">8é¢˜</option>
                                    <option value="12">12é¢˜</option>
                                    <option value="16" selected>16é¢˜</option>
                                    <option value="20">20é¢˜</option>
                                    <option value="24">24é¢˜</option>
                                </select>
                            </div>
                        </div>
                        <div style="display: flex; gap: 15px;">
                            <div style="flex: 1;">
                                <label style="font-size: 0.95rem; color: #8b5cf6; font-weight: 600;">ğŸ“– åº”ç”¨é¢˜</label>
                                <select id="wordProblemCount">
                                    <option value="2">2é¢˜</option>
                                    <option value="4">4é¢˜</option>
                                    <option value="6">6é¢˜</option>
                                    <option value="8" selected>8é¢˜</option>
                                    <option value="10">10é¢˜</option>
                                    <option value="12">12é¢˜</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary);">ğŸ“Œ é¢˜ç›®å°†æŒ‰é¡ºåºå‡ºç°ï¼šå£ç®—é¢˜ â†’ ç«–å¼é¢˜ â†’ åº”ç”¨é¢˜ | æ•°é‡ä¸º4çš„å€æ•°ï¼Œä¾¿äºæ’ç‰ˆ</p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="startPractice()">ğŸ® å¼€å§‹ç»ƒä¹ </button>
                    <button class="btn btn-info" onclick="startTimedTest()">â±ï¸ è®¡æ—¶æµ‹è¯•</button>
                    <button class="btn btn-secondary" onclick="showPrintDialog()">ğŸ–¨ï¸ ç”Ÿæˆè¯•å·</button>
                    <button class="btn btn-primary" onclick="showHistory()">ğŸ“– æŸ¥çœ‹è®°å½•</button>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“ˆ å­¦ä¹ ç»Ÿè®¡</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="todayCount">0</div>
                        <div class="stat-label">ä»Šæ—¥ç»ƒä¹ ï¼ˆæ¬¡ï¼‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avgAccuracy">0%</div>
                        <div class="stat-label">å¹³å‡æ­£ç¡®ç‡</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalQuestions">0</div>
                        <div class="stat-label">ç´¯è®¡åšé¢˜ï¼ˆé¢˜ï¼‰</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="bestStreak">0</div>
                        <div class="stat-label">æœ€ä½³è¿ç»­ç­”å¯¹</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­”é¢˜ç•Œé¢ -->
        <div id="practiceSection" class="section">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <div>
                        <span id="questionTypeBadge" class="question-type-badge type-oral">å£ç®—é¢˜</span>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-top: 10px; color: var(--text-secondary);" id="sectionInfo">ç¬¬1/10é¢˜</div>
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">æ€»è¿›åº¦ï¼šç¬¬ <span id="currentQ">1</span>/<span id="totalQ">20</span> é¢˜</div>
                    </div>
                    <div class="timer" id="timer">00:00</div>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                </div>

                <!-- æ··åˆè¿ç®—æç¤º -->
                <div id="mixedOperationHint" style="display: none; background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; margin-bottom: 20px; border-radius: 8px;">
                    <div style="font-weight: 600; color: #856404; margin-bottom: 5px;">ğŸ’¡ è¿ç®—é¡ºåºæç¤º</div>
                    <div style="font-size: 0.95rem; color: #856404;">å…ˆç®—ä¹˜é™¤ï¼Œåç®—åŠ å‡ï¼›æœ‰æ‹¬å·å…ˆç®—æ‹¬å·é‡Œé¢çš„</div>
                </div>

                <!-- å£ç®—é¢˜ç›®æ˜¾ç¤º -->
                <div id="oralQuestionArea" class="question-box">
                    <div class="question-text" id="questionText">23 + 15 = ?</div>
                    <input type="number" class="answer-input" id="answerInput" placeholder="è¾“å…¥ç­”æ¡ˆ" onkeypress="handleKeyPress(event)">
                </div>

                <!-- ç«–å¼é¢˜ç›®æ˜¾ç¤º -->
                <div id="verticalQuestionArea" class="vertical-question" style="display: none;">
                    <div style="text-align: center; font-size: 1.1rem; color: var(--text-secondary); margin-bottom: 15px;" id="verticalHorizontalDisplay">
                        123 + 45 = ?
                    </div>
                    <div class="vertical-expression">
                        <div class="vertical-number" id="verticalNum1">123</div>
                        <div>
                            <span class="vertical-operator" id="verticalOperator">+</span>
                            <span class="vertical-number" id="verticalNum2">45</span>
                        </div>
                        <div class="vertical-line"></div>
                        <div>
                            <input type="number" class="vertical-input" id="verticalAnswerInput" placeholder="?" onkeypress="handleKeyPress(event)">
                        </div>
                    </div>
                </div>

                <!-- åº”ç”¨é¢˜æ˜¾ç¤º -->
                <div id="wordProblemArea" class="word-problem-question" style="display: none;">
                    <div class="word-problem-content" id="wordProblemText" style="font-size: 1.1rem; line-height: 1.5; color: var(--text-primary); margin-bottom: 15px; white-space: pre-wrap;">
                        é¢˜ç›®å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º
                    </div>
                    <div style="max-width: 400px; margin: 0 auto; padding: 15px; border: 2px dashed #ddd; border-radius: 10px; background: #fafafa; min-height: 100px;">
                        <p style="font-size: 0.85rem; color: var(--text-secondary); text-align: center; margin-bottom: 10px;">ğŸ“ è§£ç­”åŒºåŸŸ</p>
                        <input type="number" class="answer-input" id="wordProblemAnswerInput" placeholder="æœ€ç»ˆç­”æ¡ˆ" onkeypress="handleKeyPress(event)" style="width: 100%; max-width: 200px; margin: 0 auto; display: block;">
                    </div>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="submitAnswer()">âœ… æäº¤ç­”æ¡ˆ</button>
                    <button class="btn btn-secondary" onclick="skipQuestion()">â­ï¸ è·³è¿‡</button>
                    <button class="btn btn-info" onclick="readQuestion()">ğŸ”Š è¯»é¢˜</button>
                </div>
            </div>
        </div>

        <!-- æˆç»©ç•Œé¢ -->
        <div id="resultSection" class="section">
            <div class="card">
                <div class="result-summary">
                    <div class="score-circle">
                        <div class="score-value" id="finalScore">90</div>
                        <div class="score-label">åˆ†</div>
                    </div>

                    <h2 id="resultTitle" style="margin-bottom: 20px;">ğŸ‰ å¤ªæ£’äº†ï¼</h2>

                    <div class="result-stats">
                        <div class="result-item">
                            <div class="result-item-label">é¢˜ç›®æ€»æ•°</div>
                            <div class="result-item-value" id="resultTotal">20</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">æ­£ç¡®é¢˜æ•°</div>
                            <div class="result-item-value" style="color: var(--success-color);" id="resultCorrect">18</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">é”™è¯¯é¢˜æ•°</div>
                            <div class="result-item-value" style="color: var(--danger-color);" id="resultWrong">2</div>
                        </div>
                        <div class="result-item">
                            <div class="result-item-label">ç”¨æ—¶</div>
                            <div class="result-item-value" id="resultTime">03:45</div>
                        </div>
                    </div>

                    <div id="sectionStats" style="margin: 20px 0; padding: 15px; background: #f9fafb; border-radius: 10px;">
                        <h3 style="text-align: center; margin-bottom: 15px; font-size: 1.1rem;">ğŸ“Š å„éƒ¨åˆ†æˆç»©</h3>
                        <div id="sectionStatsContent"></div>
                    </div>

                    <div id="wrongAnswersSection" class="wrong-answers" style="display: none;">
                        <h3>âŒ é”™é¢˜å›é¡¾</h3>
                        <div id="wrongAnswersList"></div>
                    </div>

                    <div class="btn-group" style="margin-top: 30px;">
                        <button class="btn btn-primary" onclick="restart()">ğŸ”„ å†ç»ƒä¸€æ¬¡</button>
                        <button class="btn btn-secondary" onclick="practiceWrong()">ğŸ“• é‡ç»ƒé”™é¢˜</button>
                        <button class="btn btn-info" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- å†å²è®°å½•ç•Œé¢ -->
        <div id="historySection" class="section">
            <div class="card">
                <h2 style="margin-bottom: 20px;">ğŸ“– ç»ƒä¹ è®°å½•</h2>
                <div class="history-list" id="historyList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— ç»ƒä¹ è®°å½•</p>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="goHome()">ğŸ  è¿”å›ä¸»é¡µ</button>
                    <button class="btn btn-danger" onclick="clearHistory()">ğŸ—‘ï¸ æ¸…ç©ºè®°å½•</button>
                </div>
            </div>
        </div>

        <!-- æ‰“å°è®¾ç½®å¯¹è¯æ¡† -->
        <div id="printDialog" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px;">
            <div class="card" style="max-width: 500px; width: 100%; animation: fadeIn 0.3s ease;">
                <h2 style="margin-bottom: 20px;">ğŸ–¨ï¸ ç”Ÿæˆè¯•å·è®¾ç½®</h2>

                <div class="form-group">
                    <label>ğŸ“Š ç”Ÿæˆä»½æ•°</label>
                    <select id="printCopies" style="margin-bottom: 15px;">
                        <option value="1">1ä»½</option>
                        <option value="2">2ä»½</option>
                        <option value="5">5ä»½</option>
                        <option value="10">10ä»½</option>
                        <option value="20">20ä»½</option>
                        <option value="30" selected>30ä»½ï¼ˆå…¨ç­ä½¿ç”¨ï¼‰</option>
                        <option value="40">40ä»½</option>
                        <option value="50">50ä»½</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ² é¢˜ç›®è®¾ç½®</label>
                    <div class="checkbox-group">
                        <label class="checkbox-item">
                            <input type="checkbox" id="sameQuestions"> æ‰€æœ‰ä»½ä½¿ç”¨ç›¸åŒé¢˜ç›®
                        </label>
                    </div>
                    <p style="font-size: 0.85rem; color: var(--text-secondary); margin-top: 8px;">
                        ğŸ’¡ æç¤ºï¼šå‹¾é€‰åæ‰€æœ‰è¯•å·é¢˜ç›®ç›¸åŒï¼›ä¸å‹¾é€‰åˆ™æ¯ä»½è¯•å·é¢˜ç›®ä¸åŒï¼ˆé˜²ä½œå¼Šï¼‰
                    </p>
                </div>

                <div class="btn-group">
                    <button class="btn btn-primary" onclick="confirmGeneratePrint()">âœ… ç¡®è®¤ç”Ÿæˆ</button>
                    <button class="btn btn-secondary" onclick="closePrintDialog()">âŒ å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- æ‰“å°åŒºåŸŸ -->
        <div class="print-area" id="printArea">
            <div id="printContent"></div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let questions = [];
        let currentQuestionIndex = 0;
        let correctCount = 0;
        let wrongAnswers = [];
        let startTime = null;
        let timerInterval = null;
        let settings = {};
        let streak = 0;
        let currentQuestionKeys = new Set();  // ç”¨äºé¢˜ç›®å»é‡

        // åˆå§‹åŒ–
        window.onload = function() {
            loadStats();
            loadHistory();
        };

        // å·¥å…·å‡½æ•°
        function random(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // è·å–æ•°å­—èŒƒå›´
        function getNumberRange(grade) {
            switch(grade) {
                case 1: return { min: 1, max: 10 };
                case 2: return { min: 1, max: 50 };
                case 3: return { min: 1, max: 100 };
                case 4: return { min: 1, max: 500 };
                case 5: return { min: 1, max: 1000 };
                case 6: return { min: 1, max: 5000 };
                default: return { min: 1, max: 100 };
            }
        }



        // ç”Ÿæˆå£ç®—é¢˜
        function generateOralQuestion(grade, difficulty, operation) {
            const { min, max } = getNumberRange(grade);

            switch(operation) {
                case 'add':
                    let a1 = random(min, max);
                    let b1 = random(min, max);
                    if (difficulty === 'easy') {
                        const easyMax = Math.min(20, max);
                        a1 = random(1, easyMax);
                        b1 = random(1, easyMax);
                    }
                    return { type: 'oral', question: `${a1} + ${b1}`, answer: a1 + b1, display: `${a1} + ${b1} = ?` };

                case 'subtract':
                    let ans1 = random(min, max);
                    let b_sub = random(min, ans1);
                    let a_sub = ans1 + b_sub;
                    if (difficulty === 'easy') {
                        const easyMax = Math.min(20, max);
                        ans1 = random(1, easyMax);
                        b_sub = random(1, ans1);
                        a_sub = ans1 + b_sub;
                    }
                    return { type: 'oral', question: `${a_sub} - ${b_sub}`, answer: ans1, display: `${a_sub} - ${b_sub} = ?` };

                case 'multiply':
                    if (grade === 2) {
                        const ma = random(1, 9);
                        const mb = random(1, 9);
                        return { type: 'oral', question: `${ma} Ã— ${mb}`, answer: ma * mb, display: `${ma} Ã— ${mb} = ?` };
                    } else if (grade === 3) {
                        const ma = random(10, 99);
                        const mb = random(2, 9);
                        return { type: 'oral', question: `${ma} Ã— ${mb}`, answer: ma * mb, display: `${ma} Ã— ${mb} = ?` };
                    } else {
                        const ma = random(10, 99);
                        const mb = random(10, difficulty === 'easy' ? 20 : 99);
                        return { type: 'oral', question: `${ma} Ã— ${mb}`, answer: ma * mb, display: `${ma} Ã— ${mb} = ?` };
                    }

                case 'divide':
                    let db, dans;
                    if (grade === 3) {
                        db = random(2, 9);
                        dans = random(1, 12);
                    } else {
                        db = random(2, difficulty === 'easy' ? 9 : 20);
                        dans = random(1, 50);
                    }
                    const da = db * dans;
                    return { type: 'oral', question: `${da} Ã· ${db}`, answer: dans, display: `${da} Ã· ${db} = ?` };

                case 'mixed':
                    // æš‚æ—¶ä¸æ”¯æŒmixedï¼Œè¿”å›é»˜è®¤é¢˜ç›®
                    return { type: 'oral', question: '2 + 3', answer: 5, display: '2 + 3 = ?' };

                default:
                    return { type: 'oral', question: '2 + 3', answer: 5, display: '2 + 3 = ?' };
            }
        }

        // ç”Ÿæˆæ··åˆè¿ç®—å£ç®—é¢˜
        function generateMixedOralQuestion(grade, difficulty, selectedOperations) {
            // æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„è¿ç®—ç±»å‹ç”Ÿæˆæ··åˆè¿ç®—ç»„åˆ
            const hasAdd = selectedOperations.includes('add');
            const hasSubtract = selectedOperations.includes('subtract');
            const hasMultiply = selectedOperations.includes('multiply');
            const hasDivide = selectedOperations.includes('divide');

            // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ··åˆè¿ç®—ç±»å‹ï¼ˆåŸºäºç”¨æˆ·é€‰æ‹©çš„è¿ç®—ï¼‰
            const possibleTypes = [];

            // åŠ å‡æ··åˆï¼ˆä¸¤ä¸ªæ•°ï¼‰
            if (hasAdd && hasSubtract) {
                possibleTypes.push('add_subtract', 'subtract_add');
            }
            // åŠ å‡æ··åˆï¼ˆä¸‰ä¸ªæ•°ï¼‰
            if (hasAdd && hasSubtract) {
                possibleTypes.push('add_subtract_add', 'add_subtract_subtract', 'subtract_add_add');
            }
            // åŠ æ³• + ä¹˜æ³•
            if (hasAdd && hasMultiply) {
                possibleTypes.push('add_multiply', 'multiply_add');
            }
            // å‡æ³• + ä¹˜æ³•
            if (hasSubtract && hasMultiply) {
                possibleTypes.push('subtract_multiply', 'multiply_subtract');
            }
            // åŠ æ³• + é™¤æ³•
            if (hasAdd && hasDivide) {
                possibleTypes.push('add_divide', 'divide_add');
            }
            // å‡æ³• + é™¤æ³•
            if (hasSubtract && hasDivide) {
                possibleTypes.push('subtract_divide', 'divide_subtract');
            }

            if (possibleTypes.length === 0) {
                // å¦‚æœæ²¡æœ‰å¯ä»¥ç»„åˆçš„è¿ç®—ç±»å‹ï¼Œè¿”å›é»˜è®¤é¢˜ç›®
                return {
                    type: 'oral',
                    question: '2 + 3',
                    answer: 5,
                    display: '2 + 3 = ?'
                };
            }

            const type = possibleTypes[random(0, possibleTypes.length - 1)];

            switch(type) {
                case 'add_subtract':  // a + b - cï¼ˆä¸¤ä¸ªæ•°ï¼Œç»“æœä¸ºæ­£ï¼‰
                    const num1 = random(1, Math.floor(getGradeMax(grade) * 0.4));
                    const num2 = random(1, num1);
                    const answer = num1 + num2;
                    return {
                        type: 'oral',
                        question: `${num1} + ${num2} - ${num2}`,
                        answer: num1,
                        display: `${num1} + ${num2} - ${num2} = ?`
                    };

                case 'subtract_add':  // a - b + cï¼ˆä¸¤ä¸ªæ•°ï¼‰
                    const numa = random(5, getGradeMax(grade));
                    const numb = random(1, numa - 2);
                    const numc = random(1, getGradeMax(grade) - (numa - numb));
                    const ans = numa - numb + numc;
                    return {
                        type: 'oral',
                        question: `${numa} - ${numb} + ${numc}`,
                        answer: ans,
                        display: `${numa} - ${numb} + ${numc} = ?`
                    };

                case 'add_subtract_add':  // a + b - cï¼ˆä¸‰ä¸ªæ•°ï¼Œç¡®ä¿ç»“æœæ­£ï¼‰
                    let a1 = random(5, Math.floor(getGradeMax(grade) * 0.3));
                    let b1 = random(1, Math.floor(getGradeMax(grade) * 0.3));
                    let c1 = random(1, a1 + b1 - 1);
                    const ans1 = a1 + b1 - c1;
                    return {
                        type: 'oral',
                        question: `${a1} + ${b1} - ${c1}`,
                        answer: ans1,
                        display: `${a1} + ${b1} - ${c1} = ?`
                    };

                case 'add_subtract_subtract':  // a - b - cï¼ˆä¸‰ä¸ªæ•°ï¼Œç¡®ä¿ç»“æœæ­£ï¼‰
                    let a2 = random(10, getGradeMax(grade));
                    let b2 = random(1, Math.floor(a2 * 0.4));
                    let c2 = random(1, a2 - b2 - 1);
                    const ans2 = a2 - b2 - c2;
                    return {
                        type: 'oral',
                        question: `${a2} - ${b2} - ${c2}`,
                        answer: ans2,
                        display: `${a2} - ${b2} - ${c2} = ?`
                    };

                case 'subtract_add_add':  // a - b + c + dï¼ˆå››ä¸ªæ•°ï¼‰
                    let a3 = random(5, 20);
                    let b3 = random(1, a3 - 2);
                    let c3 = random(1, 10);
                    const ans3 = a3 - b3 + c3;
                    return {
                        type: 'oral',
                        question: `${a3} - ${b3} + ${c3}`,
                        answer: ans3,
                        display: `${a3} - ${b3} + ${c3} = ?`
                    };

                case 'add_multiply':  // a + b Ã— c
                    const mb1 = random(2, 9);
                    const mc1 = random(2, 9);
                    const bmc1 = mb1 * mc1;
                    const ma1 = random(1, getGradeMax(grade) - bmc1);
                    return {
                        type: 'oral',
                        question: `${ma1} + ${mb1} Ã— ${mc1}`,
                        answer: ma1 + bmc1,
                        display: `${ma1} + ${mb1} Ã— ${mc1} = ?`
                    };

                case 'subtract_multiply':  // a - b Ã— c
                    const mb2 = random(2, 9);
                    const mc2 = random(2, 9);
                    const bmc2 = mb2 * mc2;
                    let ma2 = random(bmc2 + 1, getGradeMax(grade));
                    return {
                        type: 'oral',
                        question: `${ma2} - ${mb2} Ã— ${mc2}`,
                        answer: ma2 - bmc2,
                        display: `${ma2} - ${mb2} Ã— ${mc2} = ?`
                    };

                case 'multiply_add':  // a Ã— b + c
                    const ma3 = random(2, 9);
                    const mb3 = random(2, 9);
                    const ma3mb3 = ma3 * mb3;
                    const mc3 = random(1, getGradeMax(grade) - ma3mb3);
                    return {
                        type: 'oral',
                        question: `${ma3} Ã— ${mb3} + ${mc3}`,
                        answer: ma3mb3 + mc3,
                        display: `${ma3} Ã— ${mb3} + ${mc3} = ?`
                    };

                case 'multiply_subtract':  // a Ã— b - c
                    const ma4 = random(2, 9);
                    const mb4 = random(2, 9);
                    const ma4mb4 = ma4 * mb4;
                    const mc4 = random(1, ma4mb4 - 1);
                    return {
                        type: 'oral',
                        question: `${ma4} Ã— ${mb4} - ${mc4}`,
                        answer: ma4mb4 - mc4,
                        display: `${ma4} Ã— ${mb4} - ${mc4} = ?`
                    };

                case 'add_divide':  // a + b Ã· c
                    const mdiv1 = random(2, 9);
                    const mquot1 = random(1, 12);
                    const mdivd1 = mdiv1 * mquot1;
                    const ma5 = random(1, getGradeMax(grade) - mquot1);
                    return {
                        type: 'oral',
                        question: `${ma5} + ${mdivd1} Ã· ${mdiv1}`,
                        answer: ma5 + mquot1,
                        display: `${ma5} + ${mdivd1} Ã· ${mdiv1} = ?`
                    };

                case 'subtract_divide':  // a - b Ã· c
                    const mdiv2 = random(2, 9);
                    const mquot2 = random(1, 12);
                    const mdivd2 = mdiv2 * mquot2;
                    let ma6 = random(mquot2 + 1, getGradeMax(grade));
                    return {
                        type: 'oral',
                        question: `${ma6} - ${mdivd2} Ã· ${mdiv2}`,
                        answer: ma6 - mquot2,
                        display: `${ma6} - ${mdivd2} Ã· ${mdiv2} = ?`
                    };

                case 'divide_add':  // a Ã· b + c
                    const mdiv3 = random(2, 9);
                    const mquot3 = random(1, 12);
                    const mdivd3 = mdiv3 * mquot3;
                    const mc7 = random(1, getGradeMax(grade) - mquot3);
                    return {
                        type: 'oral',
                        question: `${mdivd3} Ã· ${mdiv3} + ${mc7}`,
                        answer: mquot3 + mc7,
                        display: `${mdivd3} Ã· ${mdiv3} + ${mc7} = ?`
                    };

                case 'divide_subtract':  // a Ã· b - c
                    const mdiv4 = random(2, 9);
                    const mquot4 = random(1, 12);
                    const mdivd4 = mdiv4 * mquot4;
                    const mc8 = random(1, mquot4 - 1);
                    return {
                        type: 'oral',
                        question: `${mdivd4} Ã· ${mdiv4} - ${mc8}`,
                        answer: mquot4 - mc8,
                        display: `${mdivd4} Ã· ${mdiv4} - ${mc8} = ?`
                    };
            }
        }

        // è·å–å¹´çº§å¯¹åº”çš„æœ€å¤§å€¼
        function getGradeMax(grade) {
            const maxValues = { 3: 100, 4: 500, 5: 1000, 6: 5000 };
            return maxValues[grade] || 100;
        }

        // ç”Ÿæˆç«–å¼é¢˜
        function generateVerticalQuestion(grade, difficulty, operation) {
            const { min, max } = getNumberRange(grade);

            switch(operation) {
                case 'add':
                    let va1, vb1;
                    // æ ¹æ®å¹´çº§å’Œéš¾åº¦ç”Ÿæˆæ•°å­—ï¼Œæ‰©å¤§èŒƒå›´é¿å…é‡å¤
                    if (grade <= 2) {
                        // 1-2å¹´çº§ï¼šæ··ç”¨ä¸€ä½æ•°ã€ä¸¤ä½æ•°ï¼Œå¢åŠ å¤šæ ·æ€§
                        if (difficulty === 'easy' && random(0, 1) === 0) {
                            // 30%æ¦‚ç‡ç”Ÿæˆä¸€ä½æ•°åŠ æ³•
                            va1 = random(1, 9);
                            vb1 = random(1, 9);
                        } else {
                            // 70%æ¦‚ç‡ç”Ÿæˆä¸¤ä½æ•°åŠ æ³•
                            va1 = random(10, Math.min(99, max));
                            vb1 = random(10, Math.min(99, max));
                        }
                    } else if (grade === 3) {
                        // 3å¹´çº§ï¼šä¸¤ä½æ•°ä¸ºä¸»ï¼Œå¶å°”ä¸‰ä½æ•°
                        if (random(0, 4) === 0) {
                            // 20%æ¦‚ç‡ç”Ÿæˆä¸‰ä½æ•°+ä¸¤ä½æ•°
                            va1 = random(100, Math.min(999, max));
                            vb1 = random(10, 99);
                        } else {
                            va1 = random(10, Math.min(99, max));
                            vb1 = random(10, Math.min(99, max));
                        }
                    } else {
                        // 4-6å¹´çº§ï¼šä»¥ä¸‰ä½æ•°ä¸ºä¸»
                        if (random(0, 3) === 0) {
                            // 25%æ¦‚ç‡ç”Ÿæˆå››ä½æ•°
                            va1 = random(1000, Math.min(9999, max));
                            vb1 = random(100, Math.min(999, max));
                        } else {
                            va1 = random(100, Math.min(999, max));
                            vb1 = random(100, Math.min(999, max));
                        }
                    }
                    return {
                        type: 'vertical',
                        num1: va1,
                        num2: vb1,
                        operator: '+',
                        answer: va1 + vb1,
                        display: `${va1} + ${vb1}`
                    };

                case 'subtract':
                    let va_sub, vb_sub, vans;
                    if (grade <= 2) {
                        // 1-2å¹´çº§ï¼šæ··ç”¨ä¸€ä½æ•°ã€ä¸¤ä½æ•°å‡æ³•
                        if (difficulty === 'easy' && random(0, 1) === 0) {
                            vans = random(1, 9);
                            vb_sub = random(1, vans);
                        } else {
                            vans = random(10, Math.min(99, max));
                            vb_sub = random(1, vans);
                        }
                    } else if (grade === 3) {
                        // 3å¹´çº§ï¼šä¸¤ä½æ•°å‡æ³•ä¸ºä¸»ï¼Œå¶å°”ä¸‰ä½æ•°
                        if (random(0, 4) === 0) {
                            vans = random(100, Math.min(999, max));
                            vb_sub = random(10, vans);
                        } else {
                            vans = random(10, Math.min(99, max));
                            vb_sub = random(1, vans);
                        }
                    } else {
                        // 4-6å¹´çº§ï¼šä¸‰ä½æ•°å‡æ³•ä¸ºä¸»
                        if (random(0, 3) === 0) {
                            vans = random(1000, Math.min(9999, max));
                            vb_sub = random(100, vans);
                        } else {
                            vans = random(100, Math.min(999, max));
                            vb_sub = random(1, vans);
                        }
                    }
                    va_sub = vans + vb_sub;
                    return {
                        type: 'vertical',
                        num1: va_sub,
                        num2: vb_sub,
                        operator: '-',
                        answer: vans,
                        display: `${va_sub} - ${vb_sub}`
                    };

                case 'multiply':
                    let vma, vmb;
                    if (grade <= 3) {
                        // 1-3å¹´çº§ï¼šä¸¤ä½æ•°Ã—ä¸€ä½æ•°
                        vma = random(11, 99);
                        vmb = random(2, 9);
                    } else {
                        // 4-6å¹´çº§ï¼šæ··ç”¨ä¸¤ä½æ•°Ã—ä¸¤ä½æ•°å’Œä¸‰ä½æ•°Ã—ä¸€ä½æ•°
                        if (random(0, 2) === 0) {
                            // ä¸¤ä½æ•°Ã—ä¸¤ä½æ•°
                            vma = random(11, 99);
                            vmb = random(11, 99);
                        } else {
                            // ä¸‰ä½æ•°Ã—ä¸€ä½æ•°
                            vma = random(100, 999);
                            vmb = random(2, 9);
                        }
                    }
                    return {
                        type: 'vertical',
                        num1: vma,
                        num2: vmb,
                        operator: 'Ã—',
                        answer: vma * vmb,
                        display: `${vma} Ã— ${vmb}`
                    };

                case 'divide':
                    let vdb, vdans;
                    if (grade <= 3) {
                        // 1-3å¹´çº§ï¼šä¸€ä½æ•°æˆ–ä¸¤ä½æ•°é™¤æ³•
                        if (random(0, 1) === 0) {
                            // ä¸€ä½æ•°é™¤æ³•
                            vdb = random(2, 9);
                            vdans = random(10, 50);
                        } else {
                            // ä¸¤ä½æ•°é™¤ä»¥ä¸€ä½æ•°
                            vdb = random(2, 9);
                            vdans = random(10, 99);
                        }
                    } else {
                        // 4-6å¹´çº§ï¼šæ··ç”¨ä¸åŒä½æ•°
                        if (random(0, 2) === 0) {
                            // ä¸¤ä½æ•°é™¤æ³•
                            vdb = random(10, 20);
                            vdans = random(10, 99);
                        } else {
                            // ä¸‰ä½æ•°é™¤ä»¥ä¸€ä½æ•°
                            vdb = random(2, 9);
                            vdans = random(100, 999);
                        }
                    }
                    const vda = vdb * vdans;
                    return {
                        type: 'vertical',
                        num1: vda,
                        num2: vdb,
                        operator: 'Ã·',
                        answer: vdans,
                        display: `${vda} Ã· ${vdb}`
                    };

                default:
                    return {
                        type: 'vertical',
                        num1: 123,
                        num2: 45,
                        operator: '+',
                        answer: 168,
                        display: '123 + 45'
                    };
            }
        }

        // ç”Ÿæˆåº”ç”¨é¢˜
        function generateWordProblem(grade, difficulty, operation) {
            const templates = {
                add: [
                    // æ°´æœé£Ÿç‰©ç±»
                    (a, b) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå¦ˆå¦ˆåˆç»™ä»–ä¹°äº†${b}ä¸ªï¼Œå°æ˜ç°åœ¨ä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                    (a, b) => `ç›˜å­é‡Œæœ‰${a}ä¸ªæ©˜å­ï¼Œåˆæ”¾äº†${b}ä¸ªæ©˜å­ï¼Œç›˜å­é‡Œä¸€å…±æœ‰å¤šå°‘ä¸ªæ©˜å­ï¼Ÿ`,
                    (a, b) => `å†°ç®±é‡Œæœ‰${a}ç“¶ç‰›å¥¶ï¼Œåˆä¹°äº†${b}ç“¶ï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘ç“¶ç‰›å¥¶ï¼Ÿ`,
                    (a, b) => `è›‹ç³•åº—ä¸Šåˆå–äº†${a}ä¸ªè›‹ç³•ï¼Œä¸‹åˆå–äº†${b}ä¸ªï¼Œå…¨å¤©ä¸€å…±å–äº†å¤šå°‘ä¸ªè›‹ç³•ï¼Ÿ`,
                    // å­¦ä¹ ç”¨å“ç±»
                    (a, b) => `å›¾ä¹¦é¦†æœ‰${a}æœ¬æ•…äº‹ä¹¦ï¼Œåˆæ–°ä¹°äº†${b}æœ¬ï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘æœ¬æ•…äº‹ä¹¦ï¼Ÿ`,
                    (a, b) => `å°çº¢æ”¶é›†äº†${a}æšé‚®ç¥¨ï¼Œå“¥å“¥åˆé€ç»™å¥¹${b}æšï¼Œå°çº¢ç°åœ¨æœ‰å¤šå°‘æšé‚®ç¥¨ï¼Ÿ`,
                    (a, b) => `æ–‡å…·æœ‰${a}æ”¯é“…ç¬”ï¼Œåˆè¿›è´§${b}æ”¯ï¼Œä¸€å…±æœ‰å¤šå°‘æ”¯é“…ç¬”ï¼Ÿ`,
                    (a, b) => `å°åæœ‰${a}å—æ©¡çš®ï¼Œåˆä¹°äº†${b}å—ï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘å—æ©¡çš®ï¼Ÿ`,
                    // äº¤é€šå·¥å…·ç±»
                    (a, b) => `åœè½¦åœºåŸæ¥æœ‰${a}è¾†æ±½è½¦ï¼Œåˆå¼€æ¥äº†${b}è¾†ï¼Œç°åœ¨åœè½¦åœºæœ‰å¤šå°‘è¾†æ±½è½¦ï¼Ÿ`,
                    (a, b) => `å…¬äº¤è½¦ç«™æœ‰${a}äººåœ¨ç­‰è½¦ï¼Œåˆæ¥äº†${b}äººï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘äººåœ¨ç­‰è½¦ï¼Ÿ`,
                    // åŠ¨ç‰©æ¤ç‰©ç±»
                    (a, b) => `æ± å¡˜é‡Œæœ‰${a}åªé¸­å­ï¼Œåˆæ¸¸æ¥${b}åªï¼Œç°åœ¨æ± å¡˜é‡Œæœ‰å¤šå°‘åªé¸­å­ï¼Ÿ`,
                    (a, b) => `èŠ±å›­é‡Œæœ‰${a}åªè´è¶ï¼Œåˆé£æ¥${b}åªï¼ŒèŠ±å›­é‡Œä¸€å…±æœ‰å¤šå°‘åªè´è¶ï¼Ÿ`,
                    (a, b) => `æ ‘ä¸Šæœ‰${a}ä¸ªæœå­ï¼Œåˆé•¿äº†${b}ä¸ªï¼Œæ ‘ä¸Šä¸€å…±æœ‰å¤šå°‘ä¸ªæœå­ï¼Ÿ`,
                    // è¿åŠ¨æ¸¸æˆç±»
                    (a, b) => `å°æ˜æŠ•ç¯®è¿›äº†${a}ä¸ªï¼ŒåˆæŠ•è¿›${b}ä¸ªï¼Œä¸€å…±æŠ•è¿›äº†å¤šå°‘ä¸ªçƒï¼Ÿ`,
                    (a, b) => `å°çº¢è·³ç»³ç¬¬ä¸€æ¬¡è·³äº†${a}ä¸‹ï¼Œç¬¬äºŒæ¬¡è·³äº†${b}ä¸‹ï¼Œä¸€å…±è·³äº†å¤šå°‘ä¸‹ï¼Ÿ`,
                    // å…¶ä»–ç”Ÿæ´»åœºæ™¯
                    (a, b) => `å…»é¸¡åœºæœ‰${a}åªæ¯é¸¡ï¼Œ${b}åªå…¬é¸¡ï¼Œå…»é¸¡åœºä¸€å…±æœ‰å¤šå°‘åªé¸¡ï¼Ÿ`,
                    (a, b) => `å­¦æ ¡ä¸Šåˆæ¥äº†${a}ä¸ªå­¦ç”Ÿï¼Œä¸‹åˆæ¥äº†${b}ä¸ªå­¦ç”Ÿï¼Œä»Šå¤©ä¸€å…±æ¥äº†å¤šå°‘ä¸ªå­¦ç”Ÿï¼Ÿ`,
                    (a, b) => `è¶…å¸‚è´§æ¶ä¸Šæœ‰${a}ç›’é¥¼å¹²ï¼Œåˆæ‘†ä¸Š${b}ç›’ï¼Œè´§æ¶ä¸Šç°åœ¨æœ‰å¤šå°‘ç›’é¥¼å¹²ï¼Ÿ`
                ],
                subtract: [
                    // è´­ç‰©æ¶ˆè´¹ç±»
                    (a, b) => `å•†åº—æœ‰${a}ä¸ªç¯®çƒï¼Œå–å‡ºäº†${b}ä¸ªï¼Œè¿˜å‰©å¤šå°‘ä¸ªç¯®çƒï¼Ÿ`,
                    (a, b) => `å°æ˜æœ‰${a}å…ƒé’±ï¼Œä¹°æ–‡å…·ç”¨å»äº†${b}å…ƒï¼Œè¿˜å‰©ä¸‹å¤šå°‘å…ƒï¼Ÿ`,
                    (a, b) => `é¢åŒ…æˆ¿æœ‰${a}ä¸ªé¢åŒ…ï¼Œå–æ‰äº†${b}ä¸ªï¼Œè¿˜å‰©å¤šå°‘ä¸ªé¢åŒ…ï¼Ÿ`,
                    (a, b) => `è¶…å¸‚æœ‰${a}ç“¶æœæ±ï¼Œå–å‡ºäº†${b}ç“¶ï¼Œè¿˜å‰©å¤šå°‘ç“¶æœæ±ï¼Ÿ`,
                    // å‡ºè¡Œç¦»å¼€ç±»
                    (a, b) => `å…¬äº¤è½¦ä¸Šæœ‰${a}äººï¼Œåˆ°ç«™ä¸‹å»äº†${b}äººï¼Œè½¦ä¸Šè¿˜æœ‰å¤šå°‘äººï¼Ÿ`,
                    (a, b) => `æ ‘ä¸Šæœ‰${a}åªå°é¸Ÿï¼Œé£èµ°äº†${b}åªï¼Œè¿˜å‰©ä¸‹å¤šå°‘åªå°é¸Ÿï¼Ÿ`,
                    (a, b) => `åœè½¦åœºæœ‰${a}è¾†è½¦ï¼Œå¼€èµ°äº†${b}è¾†ï¼Œè¿˜å‰©å¤šå°‘è¾†è½¦ï¼Ÿ`,
                    (a, b) => `æ“åœºä¸Šæœ‰${a}ä¸ªåŒå­¦ï¼Œèµ°äº†${b}ä¸ªï¼Œè¿˜å‰©å¤šå°‘ä¸ªåŒå­¦ï¼Ÿ`,
                    // æŸå¤±ä¸¢å¤±ç±»
                    (a, b) => `é±¼ç¼¸é‡Œæœ‰${a}æ¡é‡‘é±¼ï¼Œæ­»äº†${b}æ¡ï¼Œè¿˜å‰©ä¸‹å¤šå°‘æ¡é‡‘é±¼ï¼Ÿ`,
                    (a, b) => `å°åæœ‰${a}å¼ è´´çº¸ï¼Œä¸¢äº†${b}å¼ ï¼Œè¿˜å‰©å¤šå°‘å¼ è´´çº¸ï¼Ÿ`,
                    (a, b) => `å›¾ä¹¦é¦†æœ‰${a}æœ¬ä¹¦ï¼Œå€Ÿå‡ºå»äº†${b}æœ¬ï¼Œè¿˜å‰©å¤šå°‘æœ¬ï¼Ÿ`,
                    // å€Ÿå‡ºé€å‡ºç±»
                    (a, b) => `å°æ˜æœ‰${a}æ”¯é“…ç¬”ï¼Œå€Ÿç»™åŒå­¦${b}æ”¯ï¼Œè¿˜å‰©å¤šå°‘æ”¯ï¼Ÿ`,
                    (a, b) => `å°çº¢æœ‰${a}é¢—ç³–ï¼Œåˆ†ç»™å¼Ÿå¼Ÿ${b}é¢—ï¼Œè¿˜å‰©å¤šå°‘é¢—ï¼Ÿ`,
                    (a, b) => `å•†åº—æœ‰${a}ä»¶è¡£æœï¼Œå–å‡ºäº†${b}ä»¶ï¼Œè¿˜å‰©å¤šå°‘ä»¶ï¼Ÿ`,
                    // åƒæ‰ç”¨æ‰ç±»
                    (a, b) => `ç›˜å­é‡Œæœ‰${a}å—é¥¼å¹²ï¼Œåƒäº†${b}å—ï¼Œè¿˜å‰©å¤šå°‘å—ï¼Ÿ`,
                    (a, b) => `ç“¶å­é‡Œæœ‰${a}é¢—è¯ï¼Œåƒäº†${b}é¢—ï¼Œè¿˜å‰©å¤šå°‘é¢—ï¼Ÿ`
                ],
                multiply: [
                    // è´­ç‰©è®¡ç®—ç±»
                    (a, b) => `ä¸€æ”¯é’¢ç¬”${a}å…ƒï¼Œä¹°${b}æ”¯é’¢ç¬”éœ€è¦å¤šå°‘é’±ï¼Ÿ`,
                    (a, b) => `ä¸€ä¸ªä¹¦åŒ…${a}å…ƒï¼Œä¹°${b}ä¸ªä¹¦åŒ…éœ€è¦å¤šå°‘é’±ï¼Ÿ`,
                    (a, b) => `ä¸€æœ¬ç¬”è®°æœ¬${a}å…ƒï¼Œä¹°${b}æœ¬ç¬”è®°æœ¬éœ€è¦å¤šå°‘é’±ï¼Ÿ`,
                    (a, b) => `ä¸€ä¸ªæ–‡å…·ç›’${a}å…ƒï¼Œä¹°${b}ä¸ªæ–‡å…·ç›’éœ€è¦å¤šå°‘é’±ï¼Ÿ`,
                    // åˆ†ç»„è£…ä¸œè¥¿ç±»
                    (a, b) => `æ¯ä¸ªç›’å­è£…${a}ä¸ªé¸¡è›‹ï¼Œ${b}ä¸ªç›’å­ä¸€å…±å¯ä»¥è£…å¤šå°‘ä¸ªé¸¡è›‹ï¼Ÿ`,
                    (a, b) => `æ¯ä¸ªè¢‹å­è£…${a}ä¸ªè‹¹æœï¼Œ${b}ä¸ªè¢‹å­ä¸€å…±å¯ä»¥è£…å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                    (a, b) => `æ¯ç®±æœ‰${a}ç“¶ç‰›å¥¶ï¼Œ${b}ç®±ä¸€å…±æœ‰å¤šå°‘ç“¶ç‰›å¥¶ï¼Ÿ`,
                    (a, b) => `æ¯ç›’æœ‰${a}å—å·§å…‹åŠ›ï¼Œ${b}ç›’ä¸€å…±æœ‰å¤šå°‘å—å·§å…‹åŠ›ï¼Ÿ`,
                    // é‡å¤ç´¯ç§¯ç±»
                    (a, b) => `å°æ˜æ¯å¤©è¯»${a}é¡µä¹¦ï¼Œ${b}å¤©ä¸€å…±è¯»äº†å¤šå°‘é¡µï¼Ÿ`,
                    (a, b) => `å°çº¢æ¯å¤©å­˜${a}å…ƒé’±ï¼Œ${b}å¤©ä¸€å…±å­˜äº†å¤šå°‘é’±ï¼Ÿ`,
                    (a, b) => `ä¸€è¾†æ±½è½¦æ¯å°æ—¶è¡Œé©¶${a}åƒç±³ï¼Œè¡Œé©¶${b}å°æ—¶èƒ½è¡Œé©¶å¤šå°‘åƒç±³ï¼Ÿ`,
                    (a, b) => `å°æ˜æ¯åˆ†é’Ÿè·‘${a}ç±³ï¼Œè·‘äº†${b}åˆ†é’Ÿï¼Œä¸€å…±è·‘äº†å¤šå°‘ç±³ï¼Ÿ`,
                    // æ’åˆ—åº§ä½ç±»
                    (a, b) => `æ¯æ’å${a}ä¸ªå­¦ç”Ÿï¼Œ${b}æ’ä¸€å…±åå¤šå°‘ä¸ªå­¦ç”Ÿï¼Ÿ`,
                    (a, b) => `æ¯è¡Œç§${a}æ£µæ ‘ï¼Œ${b}è¡Œä¸€å…±ç§å¤šå°‘æ£µæ ‘ï¼Ÿ`,
                    (a, b) => `ä¸€å¼ æ¡Œå­${a}å…ƒï¼Œä¹°${b}å¼ æ¡Œå­éœ€è¦å¤šå°‘é’±ï¼Ÿ`,
                    // èº«ä½“éƒ¨ä½ç±»
                    (a, b) => `ä¸€åªæ‰‹æœ‰${a}ä¸ªæ‰‹æŒ‡ï¼Œ${b}åªæ‰‹ä¸€å…±æœ‰å¤šå°‘ä¸ªæ‰‹æŒ‡ï¼Ÿ`,
                    (a, b) => `ä¸€å¤©æœ‰${a}èŠ‚è¯¾ï¼Œ${b}å¤©ä¸€å…±æœ‰å¤šå°‘èŠ‚è¯¾ï¼Ÿ`
                ],
                divide: [
                    // å¹³å‡åˆ†é…ç±»
                    (a, b) => `æœ‰${a}ä¸ªè‹¹æœï¼Œå¹³å‡åˆ†ç»™${b}ä¸ªå°æœ‹å‹ï¼Œæ¯ä¸ªå°æœ‹å‹èƒ½åˆ†åˆ°å‡ ä¸ªï¼Ÿ`,
                    (a, b) => `æœ‰${a}é¢—ç³–ï¼Œå¹³å‡åˆ†ç»™${b}ä¸ªå­©å­ï¼Œæ¯ä¸ªå­©å­åˆ†åˆ°å‡ é¢—ï¼Ÿ`,
                    (a, b) => `æœ‰${a}æ”¯é“…ç¬”ï¼Œå¹³å‡åˆ†ç»™${b}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦åˆ†å‡ æ”¯ï¼Ÿ`,
                    (a, b) => `æœ‰${a}æœ¬ä½œä¸šæœ¬ï¼Œå¹³å‡åˆ†ç»™${b}ä¸ªå°ç»„ï¼Œæ¯ä¸ªå°ç»„åˆ†å‡ æœ¬ï¼Ÿ`,
                    // è´­ç‰©è®¡ç®—ç±»
                    (a, b) => `å°æ˜æœ‰${a}å…ƒé’±ï¼Œä¹°é“…ç¬”æ¯æ”¯${b}å…ƒï¼Œå¯ä»¥ä¹°å¤šå°‘æ”¯é“…ç¬”ï¼Ÿ`,
                    (a, b) => `æœ‰${a}å…ƒé’±ï¼Œä¹°æ©¡çš®æ¯å—${b}å…ƒï¼Œå¯ä»¥ä¹°å¤šå°‘å—æ©¡çš®ï¼Ÿ`,
                    (a, b) => `å°çº¢æœ‰${a}å…ƒï¼Œä¹°ç¬”è®°æœ¬æ¯æœ¬${b}å…ƒï¼Œå¯ä»¥ä¹°å¤šå°‘æœ¬ï¼Ÿ`,
                    // åŒ…å«æµ‹é‡ç±»
                    (a, b) => `ä¸€æœ¬ä¹¦æœ‰${a}é¡µï¼Œæ¯å¤©è¯»${b}é¡µï¼Œå¤šå°‘å¤©å¯ä»¥è¯»å®Œï¼Ÿ`,
                    (a, b) => `ä¸€æ ¹ç»³å­é•¿${a}ç±³ï¼Œå‰ªæˆæ¯æ®µ${b}ç±³ï¼Œå¯ä»¥å‰ªæˆå¤šå°‘æ®µï¼Ÿ`,
                    (a, b) => `ä¸€æ ¹ç»³å­é•¿${a}å˜ç±³ï¼Œå‰ªæˆæ¯æ®µ${b}å˜ç±³ï¼Œå¯ä»¥å‰ªæˆå¤šå°‘æ®µï¼Ÿ`,
                    // è£…ç®±åŒ…è£…ç±»
                    (a, b) => `æœ‰${a}ä¸ªé¸¡è›‹ï¼Œæ¯ç›’è£…${b}ä¸ªï¼Œéœ€è¦å¤šå°‘ä¸ªç›’å­ï¼Ÿ`,
                    (a, b) => `æœ‰${a}å—é¥¼å¹²ï¼Œæ¯è¢‹è£…${b}å—ï¼Œéœ€è¦å¤šå°‘ä¸ªè¢‹å­ï¼Ÿ`,
                    (a, b) => `æœ‰${a}æœ¬ä¹¦ï¼Œæ¯å±‚æ”¾${b}æœ¬ï¼Œéœ€è¦æ”¾å¤šå°‘å±‚ï¼Ÿ`,
                    // æ—¶é—´é€Ÿåº¦ç±»
                    (a, b) => `å°æ˜è¦è·‘${a}ç±³ï¼Œæ¯åˆ†é’Ÿè·‘${b}ç±³ï¼Œéœ€è¦å‡ åˆ†é’Ÿï¼Ÿ`,
                    (a, b) => `ä¸€è¾†æ±½è½¦è¡Œé©¶${a}åƒç±³ï¼Œæ¯å°æ—¶è¡Œé©¶${b}åƒç±³ï¼Œéœ€è¦å‡ å°æ—¶ï¼Ÿ`,
                    (a, b) => `å°çº¢è¦åš${a}é“é¢˜ï¼Œæ¯åˆ†é’Ÿåš${b}é“ï¼Œéœ€è¦å‡ åˆ†é’Ÿï¼Ÿ`
                ],
                compare: [
                    // æ¯”å¤šé—®é¢˜ï¼ˆAæ¯”Bå¤šï¼Œæ±‚Aï¼‰
                    (a, b) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå°çº¢æ¯”å°æ˜å¤š${b}ä¸ªï¼Œå°çº¢æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                    (a, b) => `å›¾ä¹¦é¦†æœ‰${a}æœ¬æ•…äº‹ä¹¦ï¼Œç§‘æŠ€ä¹¦æ¯”æ•…äº‹ä¹¦å¤š${b}æœ¬ï¼Œç§‘æŠ€ä¹¦æœ‰å¤šå°‘æœ¬ï¼Ÿ`,
                    (a, b) => `åœè½¦åœºæœ‰${a}è¾†æ±½è½¦ï¼Œæ‘©æ‰˜è½¦æ¯”æ±½è½¦å¤š${b}è¾†ï¼Œæ‘©æ‰˜è½¦æœ‰å¤šå°‘è¾†ï¼Ÿ`,
                    (a, b) => `å°åæœ‰${a}å¼ è´´çº¸ï¼Œå°ä¸½æ¯”å°åå¤š${b}å¼ ï¼Œå°ä¸½æœ‰å¤šå°‘å¼ è´´çº¸ï¼Ÿ`,
                    (a, b) => `å…¬é¸¡æœ‰${a}åªï¼Œæ¯é¸¡æ¯”å…¬é¸¡å¤š${b}åªï¼Œæ¯é¸¡æœ‰å¤šå°‘åªï¼Ÿ`,
                    (a, b) => `äºŒå¹´çº§æœ‰${a}äººï¼Œä¸‰å¹´çº§æ¯”äºŒå¹´çº§å¤š${b}äººï¼Œä¸‰å¹´çº§æœ‰å¤šå°‘äººï¼Ÿ`,
                    (a, b) => `å°ç‹—æœ‰${a}æ¡ï¼Œå¤§ç‹—æ¯”å°ç‹—å¤š${b}æ¡ï¼Œå¤§ç‹—æœ‰å¤šå°‘æ¡ï¼Ÿ`,
                    // æ¯”å¤šé—®é¢˜ï¼ˆAæ¯”Bå¤šï¼Œæ±‚æ€»æ•°ï¼‰
                    (a, b) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå°çº¢æ¯”å°æ˜å¤š${b}ä¸ªï¼Œä¸¤äººä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                    (a, b) => `ä¸€ç­æœ‰${a}äººï¼ŒäºŒç­æ¯”ä¸€ç­å¤š${b}äººï¼Œä¸¤ä¸ªç­ä¸€å…±æœ‰å¤šå°‘äººï¼Ÿ`,
                    (a, b) => `é»‘æ¿ä¸Šæœ‰${a}ä¸ªäº”è§’æ˜Ÿï¼Œåˆæ¯”å®ƒå¤š${b}ä¸ªé¢—çº¢æ˜Ÿæ˜Ÿï¼Œä¸€å…±æœ‰å¤šå°‘é¢—æ˜Ÿæ˜Ÿï¼Ÿ`,
                    (a, b) => `èŠ±å›é‡Œæœ‰${a}æœµçº¢èŠ±ï¼Œé»„èŠ±æ¯”çº¢èŠ±å¤š${b}æœµï¼Œä¸€å…±æœ‰å¤šå°‘æœµèŠ±ï¼Ÿ`,
                    // æ¯”å°‘é—®é¢˜ï¼ˆAæ¯”Bå°‘ï¼Œæ±‚Aï¼‰
                    (a, b) => `å•†åº—æœ‰${a}ä¸ªç¯®çƒï¼Œè¶³çƒæ¯”ç¯®çƒå°‘${b}ä¸ªï¼Œè¶³çƒæœ‰å¤šå°‘ä¸ªï¼Ÿ`,
                    (a, b) => `å°æ˜æœ‰${a}å…ƒé’±ï¼Œå°çº¢æ¯”å°æ˜å°‘${b}å…ƒï¼Œå°çº¢æœ‰å¤šå°‘é’±ï¼Ÿ`,
                    (a, b) => `åŠ¨ç‰©å›­æœ‰${a}åªçŒ´å­ï¼Œè€è™æ¯”çŒ´å­å°‘${b}åªï¼Œè€è™æœ‰å¤šå°‘åªï¼Ÿ`,
                    (a, b) => `å¤§å¡è½¦æœ‰${a}è¾†ï¼Œå°æ±½è½¦æ¯”å¤§å¡è½¦å°‘${b}è¾†ï¼Œå°æ±½è½¦æœ‰å¤šå°‘è¾†ï¼Ÿ`,
                    (a, b) => `å“¥å“¥æœ‰${a}é¢—ç³–ï¼Œå¼Ÿå¼Ÿæ¯”å“¥å“¥å°‘${b}é¢—ï¼Œå¼Ÿå¼Ÿæœ‰å¤šå°‘é¢—ç³–ï¼Ÿ`,
                    (a, b) => `ä¸Šåˆæœ‰${a}ä¸ªå­¦ç”Ÿï¼Œä¸‹åˆæ¯”ä¸Šåˆå°‘${b}ä¸ªï¼Œä¸‹åˆæœ‰å¤šå°‘ä¸ªå­¦ç”Ÿï¼Ÿ`,
                    // æ¯”å°‘é—®é¢˜ï¼ˆAæ¯”Bå°‘ï¼Œæ±‚æ€»æ•°ï¼‰
                    (a, b) => `å•†åº—æœ‰${a}ä¸ªç¯®çƒï¼Œè¶³çƒæ¯”ç¯®çƒå°‘${b}ä¸ªï¼Œç¯®çƒå’Œè¶³çƒä¸€å…±æœ‰å¤šå°‘ä¸ªï¼Ÿ`,
                    (a, b) => `å°çº¢æœ‰${a}æœµèŠ±ï¼Œå°ä¸½æ¯”å°çº¢å°‘${b}æœµï¼Œä¸¤äººä¸€å…±æœ‰å¤šå°‘æœµèŠ±ï¼Ÿ`,
                    (a, b) => `é¸­æœ‰${a}åªï¼Œé¸¡æ¯”é¸­å°‘${b}åªï¼Œé¸¡å’Œé¸­ä¸€å…±æœ‰å¤šå°‘åªï¼Ÿ`,
                    // ä¸€æ ·å¤šé—®é¢˜ï¼ˆAå’ŒBä¸€æ ·å¤šï¼Œæ±‚æ€»æ•°ï¼‰
                    (num) => {
                        const n = random(1, Math.floor(num * 0.3));
                        const answer = n * 2;
                        return {
                            question: `å°æ˜æœ‰${n}ä¸ªè‹¹æœï¼Œå°çº¢çš„è‹¹æœå’Œå°æ˜ä¸€æ ·å¤šï¼Œä¸¤äººä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                            answer: answer,
                            num1: n,
                            num2: n
                        };
                    },
                    (num) => {
                        const pages = random(1, Math.floor(num * 0.3));
                        const answer = pages * 2;
                        return {
                            question: `ä¸€æœ¬ä¹¦æœ‰${pages}é¡µï¼Œç¬¬äºŒå¤©çœ‹çš„å’Œç¬¬ä¸€å¤©ä¸€æ ·å¤šï¼Œä¸¤å¤©ä¸€å…±çœ‹äº†å¤šå°‘é¡µï¼Ÿ`,
                            answer: answer,
                            num1: pages,
                            num2: pages
                        };
                    },
                    (a, b) => `é“…ç¬”ç›’é‡Œæœ‰${a}æ”¯é“…ç¬”ï¼Œé’¢ç¬”å’Œé“…ç¬”ä¸€æ ·å¤šï¼Œé“…ç¬”å’Œé’¢ç¬”ä¸€å…±æœ‰å¤šå°‘æ”¯ï¼Ÿ`,
                    (a, b) => `å·¦è¾¹æœ‰${a}ä¸ªä¸‰è§’å½¢ï¼Œå³è¾¹å’Œå·¦è¾¹ä¸€æ ·å¤šï¼Œä¸€å…±æœ‰å¤šå°‘ä¸ªä¸‰è§’å½¢ï¼Ÿ`,
                    // å€æ•°æ¯”è¾ƒï¼ˆAæ˜¯Bçš„å‡ å€ï¼Œæ±‚Aï¼‰
                    (a, b) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå°çº¢çš„è‹¹æœæ˜¯å°æ˜çš„${b}å€ï¼Œå°çº¢æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                    (a, b) => `ç™½å…”æœ‰${a}åªï¼Œé»‘å…”æ˜¯ç™½å…”çš„${b}å€ï¼Œé»‘å…”æœ‰å¤šå°‘åªï¼Ÿ`,
                    (a, b) => `é’¢ç¬”${a}å…ƒï¼Œä¹¦åŒ…çš„ä»·æ ¼æ˜¯é’¢ç¬”çš„${b}å€ï¼Œä¹¦åŒ…å¤šå°‘å…ƒï¼Ÿ`,
                    (a, b) => `å°çŒ«æœ‰${a}æ¡ï¼Œå¤§çŒ«çš„æ¡æ•°æ˜¯å°çŒ«çš„${b}å€ï¼Œå¤§çŒ«æœ‰å¤šå°‘æ¡ï¼Ÿ`,
                    // æ±‚å·®é—®é¢˜ï¼ˆAå’ŒBï¼Œæ±‚ç›¸å·®ï¼‰
                    (a, b) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå°çº¢æœ‰${b}ä¸ªè‹¹æœï¼Œå°æ˜æ¯”å°çº¢å¤šå‡ ä¸ªï¼Ÿ`,
                    (a, b) => `ç¬¼å­é‡Œæœ‰${a}åªç™½å…”ï¼Œ${b}åªé»‘å…”ï¼Œç™½å…”æ¯”é»‘å…”å¤šå‡ åªï¼Ÿ`,
                    (a, b) => `ç¬¬ä¸€æ¡ç»³å­é•¿${a}ç±³ï¼Œç¬¬äºŒæ¡ç»³å­é•¿${b}ç±³ï¼Œç¬¬ä¸€æ¡ç»³å­æ¯”ç¬¬äºŒæ¡é•¿å¤šå°‘ç±³ï¼Ÿ`,
                    (a, b) => `å°ååšäº†${a}é“é¢˜ï¼Œå°æ˜åšäº†${b}é“é¢˜ï¼Œå°åæ¯”å°æ˜å¤šåšå‡ é“ï¼Ÿ`,
                    (a, b) => `ä¸Šåˆæ¥äº†${a}ä¸ªå­¦ç”Ÿï¼Œä¸‹åˆæ¥äº†${b}ä¸ªï¼Œä¸Šåˆæ¯”ä¸‹åˆå¤šå‡ ä¸ªï¼Ÿ`
                ],
                mixed: [
                    // ä¹˜æ³• + åŠ æ³•ï¼ˆå…ˆä¹˜ååŠ ï¼‰
                    (a, b, c) => `å°æ˜ä¹°äº†${b}æ”¯é“…ç¬”ï¼Œæ¯æ”¯${c}å…ƒï¼Œåˆä¹°äº†ä¸€ä¸ª${a}å…ƒçš„æ©¡çš®ï¼Œå°æ˜ä¸€å…±èŠ±äº†å¤šå°‘é’±ï¼Ÿ`,
                    (a, b, c) => `å›¾ä¹¦é¦†ä¹°äº†${b}å¥—ä¹¦ï¼Œæ¯å¥—${c}æœ¬ï¼Œåˆä¹°äº†${a}æœ¬æ•…äº‹ä¹¦ï¼Œå›¾ä¹¦é¦†ä¸€å…±ä¹°äº†å¤šå°‘æœ¬ä¹¦ï¼Ÿ`,
                    (a, b, c) => `è¶…å¸‚è¿æ¥${b}ç®±ç‰›å¥¶ï¼Œæ¯ç®±${c}ç›’ï¼Œåˆè¿æ¥${a}ç›’é…¸å¥¶ï¼Œè¶…å¸‚ä¸€å…±è¿æ¥å¤šå°‘ç›’é¥®å“ï¼Ÿ`,
                    (a, b, c) => `å¦ˆå¦ˆä¹°äº†${b}ä¸ªè¥¿ç“œï¼Œæ¯ä¸ª${c}å…ƒï¼Œåˆä¹°äº†${a}å…ƒçš„è‹¹æœï¼Œä¸€å…±èŠ±äº†å¤šå°‘å…ƒï¼Ÿ`,
                    (a, b, c) => `ç­çº§æœ‰${b}ç»„å­¦ç”Ÿï¼Œæ¯ç»„${c}äººï¼Œåˆæ¥äº†${a}ä¸ªè½¬å­¦ç”Ÿï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘ä¸ªå­¦ç”Ÿï¼Ÿ`,
                    (a, b, c) => `æœ‰${b}æ’æ¡Œå­ï¼Œæ¯æ’${c}å¼ ï¼Œåˆæ¬æ¥${a}å¼ ï¼Œä¸€å…±æœ‰å¤šå°‘å¼ æ¡Œå­ï¼Ÿ`,
                    // åŠ æ³• + ä¹˜æ³•ï¼ˆå…ˆåŠ åä¹˜ï¼‰
                    (a, b, c) => `å°çº¢æœ‰${a}æ”¯é“…ç¬”ï¼Œå°æ˜æœ‰${b}æ”¯ï¼Œå°ä¸½çš„é“…ç¬”æ˜¯ä»–ä»¬æ€»å’Œçš„${c}å€ï¼Œå°ä¸½æœ‰å¤šå°‘æ”¯é“…ç¬”ï¼Ÿ`,
                    // ä¹˜æ³• - å‡æ³•ï¼ˆå…ˆä¹˜åå‡ï¼‰
                    (a, b, c) => `å•†åº—æœ‰${a}ä¸ªç©å…·ï¼Œå–å‡º${b}ç›’ï¼Œæ¯ç›’${c}ä¸ªï¼Œè¿˜å‰©å¤šå°‘ä¸ªç©å…·ï¼Ÿ`,
                    (a, b, c) => `å°æ˜æœ‰${a}é¢—ç³–ï¼Œåˆ†ç»™${b}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦${c}é¢—ï¼Œè¿˜å‰©å¤šå°‘é¢—ç³–ï¼Ÿ`,
                    (a, b, c) => `å›¾ä¹¦é¦†æœ‰${a}æœ¬ä¹¦ï¼Œå€Ÿå‡ºå»äº†${b}åŒ…ï¼Œæ¯åŒ…${c}æœ¬ï¼Œè¿˜å‰©å¤šå°‘æœ¬ï¼Ÿ`,
                    (a, b, c) => `å¦ˆå¦ˆä¹°äº†${a}ä¸ªè‹¹æœï¼Œåƒæ‰äº†${b}ç›˜ï¼Œæ¯ç›˜${c}ä¸ªï¼Œè¿˜å‰©å¤šå°‘ä¸ªï¼Ÿ`,
                    (a, b, c) => `æœ‰${a}æœµèŠ±ï¼Œæ‰æˆ${b}æŸï¼Œæ¯æŸ${c}æœµï¼Œè¿˜å‰©å¤šå°‘æœµï¼Ÿ`,
                    // å‡æ³• + ä¹˜æ³•ï¼ˆå…ˆå‡åä¹˜ï¼‰
                    (a, b, c) => `å°çº¢æœ‰${a}å…ƒï¼Œä¹°æ–‡å…·èŠ±å»${b}å…ƒï¼Œå‰©ä¸‹çš„é’±ä¹°${c}æ”¯é“…ç¬”ï¼Œæ¯æ”¯é“…ç¬”å¤šå°‘é’±ï¼Ÿ`,
                    // é™¤æ³• + åŠ æ³•ï¼ˆå…ˆé™¤ååŠ ï¼‰
                    (a, b, c) => `è€å¸ˆæŠŠ${a}æ”¯é“…ç¬”å¹³å‡åˆ†ç»™${b}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦åˆ†åˆ°çš„å†åŠ ${c}æ”¯ï¼Œæ¯ä¸ªåŒå­¦ä¸€å…±æœ‰å¤šå°‘æ”¯ï¼Ÿ`,
                    (a, b, c) => `æœ‰${a}æœµèŠ±ï¼Œæ¯${b}æœµæ‰æˆä¸€æŸï¼Œæ‰å¥½ååˆä¹°äº†${c}æœµï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘æœµèŠ±ï¼Ÿ`,
                    (a, b, c) => `å¦ˆå¦ˆæŠŠ${a}å—ç³–å¹³å‡åˆ†ç»™${b}ä¸ªå­©å­ï¼Œæ¯ä¸ªå­©å­å†ç»™${c}å—ï¼Œæ¯ä¸ªå­©å­ä¸€å…±æœ‰å¤šå°‘å—ï¼Ÿ`,
                    // åŠ æ³• + é™¤æ³•ï¼ˆå…ˆåŠ åé™¤ï¼‰
                    (a, b, c) => `å°æ˜æœ‰${a}æ”¯é“…ç¬”ï¼Œå°çº¢åˆç»™äº†ä»–${b}æ”¯ï¼Œè¿™äº›é“…ç¬”å¹³å‡åˆ†ç»™${c}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦åˆ†å‡ æ”¯ï¼Ÿ`,
                    // é™¤æ³• - å‡æ³•ï¼ˆå…ˆé™¤åå‡ï¼‰
                    (a, b, c) => `å¦ˆå¦ˆæŠŠ${a}ä¸ªè‹¹æœå¹³å‡æ”¾åœ¨${b}ä¸ªç›˜å­é‡Œï¼Œæ¯ä¸ªç›˜å­åƒæ‰${c}ä¸ªï¼Œæ¯ä¸ªç›˜å­è¿˜å‰©å‡ ä¸ªï¼Ÿ`,
                    (a, b, c) => `æœ‰${a}é¢—ç å­ï¼Œæ¯${b}é¢—ä¸²æˆä¸€ä¸²ï¼Œä¸²å¥½åé€äºº${c}ä¸²ï¼Œè¿˜å‰©å¤šå°‘ä¸²ï¼Ÿ`,
                    (a, b, c) => `è€å¸ˆæœ‰${a}å¼ è´´çº¸ï¼Œå¹³å‡åˆ†ç»™${b}ä¸ªå°ç»„ï¼Œæ¯ä¸ªå°ç»„åˆç”¨äº†${c}å¼ ï¼Œæ¯ä¸ªå°ç»„è¿˜å‰©å¤šå°‘å¼ ï¼Ÿ`,
                    // å‡æ³• + é™¤æ³•ï¼ˆå…ˆå‡åé™¤ï¼‰
                    (a, b, c) => `å°æ˜æœ‰${a}å…ƒï¼ŒèŠ±å»${b}å…ƒä¹°ä¹¦ï¼Œå‰©ä¸‹çš„é’±ä¹°${c}æ”¯é“…ç¬”ï¼Œæ¯æ”¯é“…ç¬”å¤šå°‘é’±ï¼Ÿ`,
                    (a, b, c) => `ä¹¦æ¶æœ‰${a}æœ¬ä¹¦ï¼Œå€Ÿå‡ºå»${b}æœ¬ï¼Œå‰©ä¸‹çš„å¹³å‡åˆ†ç»™${c}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦åˆ†å‡ æœ¬ï¼Ÿ`,
                    // åŠ æ³• + å‡æ³•
                    (a, b, c) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå¦ˆå¦ˆåˆç»™äº†${b}ä¸ªï¼Œä»–åƒäº†${c}ä¸ªï¼Œç°åœ¨æœ‰å¤šå°‘ä¸ªï¼Ÿ`,
                    (a, b, c) => `å…¬äº¤è½¦ä¸ŠåŸæœ‰${a}äººï¼Œç¬¬ä¸€ç«™ä¸Šæ¥${b}äººï¼Œä¸‹å»${c}äººï¼Œç°åœ¨è½¦ä¸Šæœ‰å¤šå°‘äººï¼Ÿ`,
                    // è¿ä¹˜
                    (a, b, c) => `æœ‰${a}ç›’é¥¼å¹²ï¼Œæ¯ç›’${b}è¢‹ï¼Œæ¯è¢‹${c}å—ï¼Œä¸€å…±æœ‰å¤šå°‘å—é¥¼å¹²ï¼Ÿ`,
                    (a, b, c) => `æ•™å®¤æœ‰${a}æ’åº§ä½ï¼Œæ¯æ’${b}åº§ï¼Œæ¯åº§å${c}äººï¼Œä¸€å…±èƒ½åå¤šå°‘äººï¼Ÿ`,
                    // ä¹˜é™¤æ··åˆ
                    (a, b, c) => `æœ‰${a}æ”¯é“…ç¬”ï¼Œæ¯${b}æ”¯è£…ä¸€ç›’ï¼Œå¹³å‡åˆ†ç»™${c}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦åˆ†å‡ ç›’ï¼Ÿ`
                ]
            };

            const { min, max } = getNumberRange(grade);
            let num1, num2, answer;

            // æ ¹æ®è¿ç®—ç±»å‹ç”Ÿæˆæ•°å­—
            switch(operation) {
                case 'add':
                    num1 = random(min, Math.floor(max * 0.5));
                    num2 = random(min, Math.floor(max * 0.5));
                    answer = num1 + num2;
                    break;
                case 'subtract':
                    answer = random(min, Math.floor(max * 0.6));
                    num2 = random(1, Math.floor(answer * 0.7));  // ç¡®ä¿è‡³å°‘å‡å»1
                    num1 = answer + num2;
                    break;
                case 'multiply':
                    if (grade <= 3) {
                        num1 = random(2, 9);
                        num2 = random(2, 9);
                    } else {
                        num1 = random(2, 20);
                        num2 = random(2, 20);
                    }
                    answer = num1 * num2;
                    break;
                case 'divide':
                    num2 = random(2, grade <= 3 ? 9 : 15);
                    answer = random(2, grade <= 3 ? 12 : 20);
                    num1 = num2 * answer;
                    break;
                case 'compare':
                    // æ¯”è¾ƒç±»åº”ç”¨é¢˜ï¼šç›´æ¥è¿”å› generateCompareWordProblem
                    return generateCompareWordProblem(grade);
                case 'mixed':
                    // ä¼ é€’ operations æ•°ç»„ï¼ˆè¿‡æ»¤æ‰ 'mixed' æœ¬èº«ï¼‰
                    const baseOpsForWord = operations.filter(op => op !== 'mixed');
                    // å¦‚æœæ²¡æœ‰é€‰æ‹©åŸºç¡€è¿ç®—ï¼Œä½¿ç”¨é»˜è®¤çš„åŠ æ³•å’Œä¹˜æ³•
                    const effectiveOpsForWord = baseOpsForWord.length > 0 ? baseOpsForWord : ['add', 'multiply'];
                    return generateMixedWordProblem(grade, effectiveOpsForWord);
                default:
                    return null;
            }

            // éšæœºé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
            const operationTemplates = templates[operation];
            const template = operationTemplates[random(0, operationTemplates.length - 1)];
            const question = template(num1, num2);

            return {
                type: 'wordProblem',
                question: question,
                operation: operation,
                num1: num1,
                num2: num2,
                answer: answer,
                display: `${operation}: ${question.substring(0, 20)}...`
            };
        }

        // ç”Ÿæˆæ¯”è¾ƒç±»åº”ç”¨é¢˜
        function generateCompareWordProblem(grade) {
            const { min, max } = getNumberRange(grade);

            const compareTemplates = [
                // æ¯”å¤šé—®é¢˜ï¼ˆAæ¯”Bå¤šï¼Œæ±‚Aï¼‰
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const answer = num1 + num2;
                    return {
                        question: `å°æ˜æœ‰${num1}ä¸ªè‹¹æœï¼Œå°çº¢æ¯”å°æ˜å¤š${num2}ä¸ªï¼Œå°çº¢æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const answer = num1 + num2;
                    return {
                        question: `å›¾ä¹¦é¦†æœ‰${num1}æœ¬æ•…äº‹ä¹¦ï¼Œç§‘æŠ€ä¹¦æ¯”æ•…äº‹ä¹¦å¤š${num2}æœ¬ï¼Œç§‘æŠ€ä¹¦æœ‰å¤šå°‘æœ¬ï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const answer = num1 + num2;
                    return {
                        question: `åœè½¦åœºæœ‰${num1}è¾†æ±½è½¦ï¼Œæ‘©æ‰˜è½¦æ¯”æ±½è½¦å¤š${num2}è¾†ï¼Œæ‘©æ‰˜è½¦æœ‰å¤šå°‘è¾†ï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const answer = num1 + num2;
                    return {
                        question: `å°åæœ‰${num1}å¼ è´´çº¸ï¼Œå°ä¸½æ¯”å°åå¤š${num2}å¼ ï¼Œå°ä¸½æœ‰å¤šå°‘å¼ è´´çº¸ï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const answer = num1 + num2;
                    return {
                        question: `å…¬é¸¡æœ‰${num1}åªï¼Œæ¯é¸¡æ¯”å…¬é¸¡å¤š${num2}åªï¼Œæ¯é¸¡æœ‰å¤šå°‘åªï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const answer = num1 + num2;
                    return {
                        question: `äºŒå¹´çº§æœ‰${num1}äººï¼Œä¸‰å¹´çº§æ¯”äºŒå¹´çº§å¤š${num2}äººï¼Œä¸‰å¹´çº§æœ‰å¤šå°‘äººï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                // æ¯”å¤šé—®é¢˜ï¼ˆAæ¯”Bå¤šï¼Œæ±‚æ€»æ•°ï¼‰
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const other = num1 + num2;
                    const answer = num1 + other;
                    return {
                        question: `å°æ˜æœ‰${num1}ä¸ªè‹¹æœï¼Œå°çº¢æ¯”å°æ˜å¤š${num2}ä¸ªï¼Œä¸¤äººä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const other = num1 + num2;
                    const answer = num1 + other;
                    return {
                        question: `ä¸€ç­æœ‰${num1}äººï¼ŒäºŒç­æ¯”ä¸€ç­å¤š${num2}äººï¼Œä¸¤ä¸ªç­ä¸€å…±æœ‰å¤šå°‘äººï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.3));
                    const num2 = random(1, Math.floor(max * 0.2));
                    const other = num1 + num2;
                    const answer = num1 + other;
                    return {
                        question: `é»‘æ¿ä¸Šæœ‰${num1}ä¸ªäº”è§’æ˜Ÿï¼Œçº¢æ˜Ÿæ˜Ÿæ¯”äº”è§’æ˜Ÿå¤š${num2}ä¸ªï¼Œä¸€å…±æœ‰å¤šå°‘é¢—æ˜Ÿæ˜Ÿï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                // æ¯”å°‘é—®é¢˜ï¼ˆAæ¯”Bå°‘ï¼Œæ±‚Aï¼‰
                (a, b) => {
                    const num2 = random(1, Math.floor(max * 0.2));
                    const larger = random(num2 + 1, Math.floor(max * 0.4));
                    const answer = larger - num2;
                    return {
                        question: `å•†åº—æœ‰${larger}ä¸ªç¯®çƒï¼Œè¶³çƒæ¯”ç¯®çƒå°‘${num2}ä¸ªï¼Œè¶³çƒæœ‰å¤šå°‘ä¸ªï¼Ÿ`,
                        answer: answer,
                        num1: larger,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num2 = random(1, Math.floor(max * 0.2));
                    const larger = random(num2 + 1, Math.floor(max * 0.4));
                    const answer = larger - num2;
                    return {
                        question: `å°æ˜æœ‰${larger}å…ƒé’±ï¼Œå°çº¢æ¯”å°æ˜å°‘${num2}å…ƒï¼Œå°çº¢æœ‰å¤šå°‘é’±ï¼Ÿ`,
                        answer: answer,
                        num1: larger,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num2 = random(1, Math.floor(max * 0.2));
                    const larger = random(num2 + 1, Math.floor(max * 0.4));
                    const answer = larger - num2;
                    return {
                        question: `åŠ¨ç‰©å›­æœ‰${larger}åªçŒ´å­ï¼Œè€è™æ¯”çŒ´å­å°‘${num2}åªï¼Œè€è™æœ‰å¤šå°‘åªï¼Ÿ`,
                        answer: answer,
                        num1: larger,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num2 = random(1, Math.floor(max * 0.2));
                    const larger = random(num2 + 1, Math.floor(max * 0.4));
                    const answer = larger - num2;
                    return {
                        question: `å¤§å¡è½¦æœ‰${larger}è¾†ï¼Œå°æ±½è½¦æ¯”å¤§å¡è½¦å°‘${num2}è¾†ï¼Œå°æ±½è½¦æœ‰å¤šå°‘è¾†ï¼Ÿ`,
                        answer: answer,
                        num1: larger,
                        num2: num2
                    };
                },
                // æ¯”å°‘é—®é¢˜ï¼ˆAæ¯”Bå°‘ï¼Œæ±‚æ€»æ•°ï¼‰
                (a, b) => {
                    const num2 = random(1, Math.floor(max * 0.2));
                    const larger = random(num2 + 1, Math.floor(max * 0.4));
                    const smaller = larger - num2;
                    const answer = larger + smaller;
                    return {
                        question: `å•†åº—æœ‰${larger}ä¸ªç¯®çƒï¼Œè¶³çƒæ¯”ç¯®çƒå°‘${num2}ä¸ªï¼Œç¯®çƒå’Œè¶³çƒä¸€å…±æœ‰å¤šå°‘ä¸ªï¼Ÿ`,
                        answer: answer,
                        num1: larger,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num2 = random(1, Math.floor(max * 0.2));
                    const larger = random(num2 + 1, Math.floor(max * 0.4));
                    const smaller = larger - num2;
                    const answer = larger + smaller;
                    return {
                        question: `å°çº¢æœ‰${larger}æœµèŠ±ï¼Œå°ä¸½æ¯”å°çº¢å°‘${num2}æœµï¼Œä¸¤äººä¸€å…±æœ‰å¤šå°‘æœµèŠ±ï¼Ÿ`,
                        answer: answer,
                        num1: larger,
                        num2: num2
                    };
                },
                // ä¸€æ ·å¤šé—®é¢˜
                (a, b) => {
                    const num = random(min, Math.floor(max * 0.3));
                    const answer = num * 2;
                    return {
                        question: `å°æ˜æœ‰${num}ä¸ªè‹¹æœï¼Œå°çº¢çš„è‹¹æœå’Œå°æ˜ä¸€æ ·å¤šï¼Œä¸¤äººä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ`,
                        answer: answer,
                        num1: num,
                        num2: num
                    };
                },
                (a, b) => {
                    const pages = random(min, Math.floor(max * 0.3));
                    const answer = pages * 2;
                    return {
                        question: `ä¸€æœ¬ä¹¦æœ‰${pages}é¡µï¼Œç¬¬äºŒå¤©çœ‹çš„å’Œç¬¬ä¸€å¤©ä¸€æ ·å¤šï¼Œä¸¤å¤©ä¸€å…±çœ‹äº†å¤šå°‘é¡µï¼Ÿ`,
                        answer: answer,
                        num1: pages,
                        num2: pages
                    };
                },
                (a, b) => {
                    const num = random(min, Math.floor(max * 0.3));
                    const answer = num * 2;
                    return {
                        question: `é“…ç¬”ç›’é‡Œæœ‰${num}æ”¯é“…ç¬”ï¼Œé’¢ç¬”å’Œé“…ç¬”ä¸€æ ·å¤šï¼Œé“…ç¬”å’Œé’¢ç¬”ä¸€å…±æœ‰å¤šå°‘æ”¯ï¼Ÿ`,
                        answer: answer,
                        num1: num,
                        num2: num
                    };
                },
                // æ±‚å·®é—®é¢˜
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.4));
                    const num2 = random(min, Math.floor(max * 0.4));
                    const answer = Math.abs(num1 - num2);
                    return {
                        question: `å°æ˜æœ‰${num1}ä¸ªè‹¹æœï¼Œå°çº¢æœ‰${num2}ä¸ªè‹¹æœï¼Œå°æ˜æ¯”å°çº¢å¤šå‡ ä¸ªï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.4));
                    const num2 = random(min, Math.floor(max * 0.4));
                    const answer = Math.abs(num1 - num2);
                    return {
                        question: `ç¬¼å­é‡Œæœ‰${num1}åªç™½å…”ï¼Œ${num2}åªé»‘å…”ï¼Œç™½å…”æ¯”é»‘å…”å¤šå‡ åªï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.4));
                    const num2 = random(min, Math.floor(max * 0.4));
                    const answer = Math.abs(num1 - num2);
                    return {
                        question: `ç¬¬ä¸€æ¡ç»³å­é•¿${num1}ç±³ï¼Œç¬¬äºŒæ¡ç»³å­é•¿${num2}ç±³ï¼Œç¬¬ä¸€æ¡ç»³å­æ¯”ç¬¬äºŒæ¡é•¿å¤šå°‘ç±³ï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                },
                (a, b) => {
                    const num1 = random(min, Math.floor(max * 0.4));
                    const num2 = random(min, Math.floor(max * 0.4));
                    const answer = Math.abs(num1 - num2);
                    return {
                        question: `å°ååšäº†${num1}é“é¢˜ï¼Œå°æ˜åšäº†${num2}é“é¢˜ï¼Œå°åæ¯”å°æ˜å¤šåšå‡ é“ï¼Ÿ`,
                        answer: answer,
                        num1: num1,
                        num2: num2
                    };
                }
            ];

            // éšæœºé€‰æ‹©ä¸€ä¸ªæ¨¡æ¿
            const template = compareTemplates[random(0, compareTemplates.length - 1)];
            const result = template(min, max);

            return {
                type: 'wordProblem',
                question: result.question,
                operation: 'compare',
                num1: result.num1,
                num2: result.num2,
                answer: result.answer,
                display: `æ¯”è¾ƒ: ${result.question.substring(0, 20)}...`
            };
        }

        // ç”Ÿæˆæ··åˆè¿ç®—åº”ç”¨é¢˜
        function generateMixedWordProblem(grade, selectedOperations) {
            // æ ¹æ®ç”¨æˆ·é€‰æ‹©çš„è¿ç®—ç±»å‹ç”Ÿæˆæ··åˆè¿ç®—ç»„åˆ
            const hasAdd = selectedOperations.includes('add');
            const hasSubtract = selectedOperations.includes('subtract');
            const hasMultiply = selectedOperations.includes('multiply');
            const hasDivide = selectedOperations.includes('divide');

            // ç”Ÿæˆæ‰€æœ‰å¯èƒ½çš„æ··åˆè¿ç®—ç±»å‹ï¼ˆåŸºäºç”¨æˆ·é€‰æ‹©çš„è¿ç®—ï¼‰
            const possibleTypes = [];

            // åŠ æ³• + å‡æ³•ï¼ˆé€‚åˆä½å¹´çº§ï¼‰
            if (hasAdd && hasSubtract) {
                possibleTypes.push('add_subtract', 'subtract_add');
                possibleTypes.push('add_subtract_add', 'add_subtract_subtract', 'subtract_add_add');
            }
            // åŠ æ³• + ä¹˜æ³•
            if (hasAdd && hasMultiply) {
                possibleTypes.push('multiply_add');
            }
            // å‡æ³• + ä¹˜æ³•
            if (hasSubtract && hasMultiply) {
                possibleTypes.push('multiply_subtract');
            }
            // åŠ æ³• + é™¤æ³•
            if (hasAdd && hasDivide) {
                possibleTypes.push('divide_add');
            }
            // å‡æ³• + é™¤æ³•
            if (hasSubtract && hasDivide) {
                possibleTypes.push('divide_subtract');
            }

            if (possibleTypes.length === 0) {
                // å¦‚æœæ²¡æœ‰å¯ä»¥ç»„åˆçš„è¿ç®—ç±»å‹ï¼Œè¿”å›é»˜è®¤åº”ç”¨é¢˜
                return {
                    type: 'wordProblem',
                    question: 'å°æ˜æœ‰5ä¸ªè‹¹æœï¼Œå¦ˆå¦ˆåˆç»™ä»–ä¹°äº†3ä¸ªï¼Œå°æ˜ç°åœ¨ä¸€å…±æœ‰å¤šå°‘ä¸ªè‹¹æœï¼Ÿ',
                    operation: 'add',
                    num1: 5,
                    num2: 3,
                    answer: 8,
                    display: 'åŠ æ³•: å°æ˜æœ‰5ä¸ªè‹¹æœ...'
                };
            }

            const type = possibleTypes[random(0, possibleTypes.length - 1)];
            let question, answer, num1, num2, num3;

            switch(type) {
                case 'add_subtract':  // å…ˆåŠ åå‡ï¼ˆä¸‰ä¸ªæ•°ï¼‰
                    num1 = random(1, 20);  // ç¬¬ä¸€ä¸ªæ•°
                    num2 = random(1, 15);  // åŠ ä¸Šçš„æ•°
                    num3 = random(1, Math.min(num2, 10));  // å‡å»çš„æ•°ï¼ˆä¸è¶…è¿‡åŠ ä¸Šçš„æ•°ï¼Œç¡®ä¿æœ‰æ„ä¹‰ï¼‰
                    answer = num1 + num2 - num3;

                    const asTemplates = [
                        (a, b, c) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå¦ˆå¦ˆåˆç»™äº†ä»–${b}ä¸ªï¼Œåæ¥åƒæ‰äº†${c}ä¸ªï¼Œç°åœ¨æœ‰å‡ ä¸ªè‹¹æœï¼Ÿ`,
                        (a, b, c) => `åœè½¦åœºæœ‰${a}è¾†è½¦ï¼Œå…ˆå¼€æ¥äº†${b}è¾†ï¼Œåæ¥å¼€èµ°äº†${c}è¾†ï¼Œç°åœ¨æœ‰å¤šå°‘è¾†è½¦ï¼Ÿ`,
                        (a, b, c) => `å›¾ä¹¦è§’æœ‰${a}æœ¬ä¹¦ï¼Œåˆä¹°æ¥äº†${b}æœ¬ï¼Œå€Ÿå‡ºå»äº†${c}æœ¬ï¼Œç°åœ¨æœ‰å¤šå°‘æœ¬ä¹¦ï¼Ÿ`,
                        (a, b, c) => `å°çº¢æœ‰${a}æœµèŠ±ï¼Œè€å¸ˆåˆç»™äº†å¥¹${b}æœµï¼Œé€ç»™äº†åŒå­¦${c}æœµï¼Œç°åœ¨æœ‰å‡ æœµèŠ±ï¼Ÿ`
                    ];
                    const asTemplate = asTemplates[random(0, asTemplates.length - 1)];
                    question = asTemplate(num1, num2, num3);
                    break;

                case 'subtract_add':  // å…ˆå‡ååŠ ï¼ˆä¸‰ä¸ªæ•°ï¼‰
                    num1 = random(10, 30);  // ç¬¬ä¸€ä¸ªæ•°ï¼ˆå¤Ÿå‡ï¼‰
                    num2 = random(1, num1 - 1);  // å‡å»çš„æ•°
                    num3 = random(1, 15);  // åŠ ä¸Šçš„æ•°
                    answer = num1 - num2 + num3;

                    const saTemplates = [
                        (a, b, c) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œåƒæ‰äº†${b}ä¸ªï¼Œåæ¥å¦ˆå¦ˆåˆç»™äº†ä»–${c}ä¸ªï¼Œç°åœ¨æœ‰å‡ ä¸ªè‹¹æœï¼Ÿ`,
                        (a, b, c) => `åœè½¦åœºæœ‰${a}è¾†è½¦ï¼Œå¼€èµ°äº†${b}è¾†ï¼Œåæ¥åˆå¼€æ¥äº†${c}è¾†ï¼Œç°åœ¨æœ‰å¤šå°‘è¾†è½¦ï¼Ÿ`,
                        (a, b, c) => `å°çº¢æœ‰${a}å…ƒé’±ï¼Œä¹°æ–‡å…·èŠ±äº†${b}å…ƒï¼Œåæ¥å¦ˆå¦ˆåˆç»™äº†å¥¹${c}å…ƒï¼Œç°åœ¨æœ‰å¤šå°‘é’±ï¼Ÿ`,
                        (a, b, c) => `æ ‘ä¸Šæœ‰${a}åªå°é¸Ÿï¼Œé£èµ°äº†${b}åªï¼Œåˆé£æ¥äº†${c}åªï¼Œç°åœ¨æœ‰å‡ åªå°é¸Ÿï¼Ÿ`
                    ];
                    const saTemplate = saTemplates[random(0, saTemplates.length - 1)];
                    question = saTemplate(num1, num2, num3);
                    break;

                case 'add_subtract_add':  // åŠ -å‡-åŠ ï¼ˆå››ä¸ªæ•°ï¼‰
                    num1 = random(1, 15);  // ç¬¬ä¸€ä¸ªæ•°
                    num2 = random(1, 10);  // ç¬¬ä¸€ä¸ªåŠ ä¸Šçš„æ•°
                    num3 = random(1, Math.min(num1 + num2 - 1, 8));  // å‡å»çš„æ•°
                    const num4 = random(1, 10);  // ç¬¬äºŒä¸ªåŠ ä¸Šçš„æ•°
                    answer = num1 + num2 - num3 + num4;

                    const asaTemplates = [
                        (a, b, c, d) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå¦ˆå¦ˆç»™äº†${b}ä¸ªï¼Œåƒæ‰äº†${c}ä¸ªï¼Œå¥¶å¥¶åˆç»™äº†${d}ä¸ªï¼Œç°åœ¨æœ‰å‡ ä¸ªè‹¹æœï¼Ÿ`,
                        (a, b, c, d) => `åœè½¦åœºæœ‰${a}è¾†è½¦ï¼Œå…ˆå¼€æ¥${b}è¾†ï¼Œå¼€èµ°${c}è¾†ï¼Œåˆå¼€æ¥${d}è¾†ï¼Œç°åœ¨æœ‰å¤šå°‘è¾†è½¦ï¼Ÿ`,
                        (a, b, c, d) => `å°çº¢æœ‰${a}å…ƒé›¶èŠ±é’±ï¼ŒæŒ£äº†${b}å…ƒï¼ŒèŠ±äº†${c}å…ƒï¼ŒåˆæŒ£äº†${d}å…ƒï¼Œç°åœ¨æœ‰å¤šå°‘é’±ï¼Ÿ`
                    ];
                    const asaTemplate = asaTemplates[random(0, asaTemplates.length - 1)];
                    question = asaTemplate(num1, num2, num3, num4);
                    break;

                case 'add_subtract_subtract':  // åŠ -å‡-å‡ï¼ˆå››ä¸ªæ•°ï¼‰
                    num1 = random(5, 25);  // ç¬¬ä¸€ä¸ªæ•°ï¼ˆè¦å¤Ÿå‡ï¼‰
                    num2 = random(1, 10);  // åŠ ä¸Šçš„æ•°
                    num3 = random(1, 8);  // ç¬¬ä¸€æ¬¡å‡å»çš„æ•°
                    const num4_sub = random(1, 8);  // ç¬¬äºŒæ¬¡å‡å»çš„æ•°
                    // ç¡®ä¿ç»“æœéè´Ÿ
                    while (num1 + num2 - num3 - num4_sub < 0) {
                        num1 = random(num3 + num4_sub - num2 + 1, 30);
                    }
                    answer = num1 + num2 - num3 - num4_sub;

                    const assTemplates = [
                        (a, b, c, d) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œå¦ˆå¦ˆç»™äº†${b}ä¸ªï¼Œæ—©ä¸Šåƒæ‰äº†${c}ä¸ªï¼Œä¸‹åˆåƒæ‰äº†${d}ä¸ªï¼Œç°åœ¨æœ‰å‡ ä¸ªè‹¹æœï¼Ÿ`,
                        (a, b, c, d) => `åœè½¦åœºæœ‰${a}è¾†è½¦ï¼Œå…ˆå¼€æ¥${b}è¾†ï¼Œå¼€èµ°${c}è¾†ï¼Œåˆå¼€èµ°${d}è¾†ï¼Œç°åœ¨æœ‰å¤šå°‘è¾†è½¦ï¼Ÿ`,
                        (a, b, c, d) => `å•†åº—æœ‰${a}ä»¶å•†å“ï¼Œè¿›è´§${b}ä»¶ï¼Œä¸Šåˆå–å‡º${c}ä»¶ï¼Œä¸‹åˆå–å‡º${d}ä»¶ï¼Œè¿˜å‰©å¤šå°‘ä»¶ï¼Ÿ`
                    ];
                    const assTemplate = assTemplates[random(0, assTemplates.length - 1)];
                    question = assTemplate(num1, num2, num3, num4_sub);
                    break;

                case 'subtract_add_add':  // å‡-åŠ -åŠ ï¼ˆå››ä¸ªæ•°ï¼‰
                    num1 = random(15, 40);  // ç¬¬ä¸€ä¸ªæ•°ï¼ˆè¦å¤Ÿå‡ï¼‰
                    num2 = random(1, 15);  // å‡å»çš„æ•°
                    num3 = random(1, 10);  // ç¬¬ä¸€ä¸ªåŠ ä¸Šçš„æ•°
                    const num4_saa = random(1, 10);  // ç¬¬äºŒä¸ªåŠ ä¸Šçš„æ•°
                    answer = num1 - num2 + num3 + num4_saa;

                    const saaTemplates = [
                        (a, b, c, d) => `å°æ˜æœ‰${a}ä¸ªè‹¹æœï¼Œåƒæ‰äº†${b}ä¸ªï¼Œå¦ˆå¦ˆç»™äº†${c}ä¸ªï¼Œçˆ¸çˆ¸åˆç»™äº†${d}ä¸ªï¼Œç°åœ¨æœ‰å‡ ä¸ªè‹¹æœï¼Ÿ`,
                        (a, b, c, d) => `åœè½¦åœºæœ‰${a}è¾†è½¦ï¼Œå¼€èµ°${b}è¾†ï¼Œå¼€æ¥${c}è¾†ï¼Œåˆå¼€æ¥${d}è¾†ï¼Œç°åœ¨æœ‰å¤šå°‘è¾†è½¦ï¼Ÿ`,
                        (a, b, c, d) => `å°çº¢æœ‰${a}å…ƒé›¶èŠ±é’±ï¼ŒèŠ±äº†${b}å…ƒï¼ŒæŒ£äº†${c}å…ƒï¼ŒåˆæŒ£äº†${d}å…ƒï¼Œç°åœ¨æœ‰å¤šå°‘é’±ï¼Ÿ`
                    ];
                    const saaTemplate = saaTemplates[random(0, saaTemplates.length - 1)];
                    question = saaTemplate(num1, num2, num3, num4_saa);
                    break;

                case 'multiply_add':  // å…ˆä¹˜ååŠ 
                    num1 = random(1, 20);  // åŠ æ•°
                    num2 = random(2, 9);   // ä¹˜æ•°1
                    num3 = random(2, 9);   // ä¹˜æ•°2
                    answer = num1 + num2 * num3;

                    const maTemplates = [
                        (a, b, c) => `å°æ˜ä¹°äº†${b}æ”¯é“…ç¬”ï¼Œæ¯æ”¯${c}å…ƒï¼Œåˆä¹°äº†ä¸€ä¸ª${a}å…ƒçš„æ©¡çš®ï¼Œå°æ˜ä¸€å…±èŠ±äº†å¤šå°‘é’±ï¼Ÿ`,
                        (a, b, c) => `å›¾ä¹¦é¦†ä¹°äº†${b}å¥—ä¹¦ï¼Œæ¯å¥—${c}æœ¬ï¼Œåˆä¹°äº†${a}æœ¬æ•…äº‹ä¹¦ï¼Œå›¾ä¹¦é¦†ä¸€å…±ä¹°äº†å¤šå°‘æœ¬ä¹¦ï¼Ÿ`,
                        (a, b, c) => `è¶…å¸‚è¿æ¥${b}ç®±ç‰›å¥¶ï¼Œæ¯ç®±${c}ç›’ï¼Œåˆè¿æ¥${a}ç›’é…¸å¥¶ï¼Œè¶…å¸‚ä¸€å…±è¿æ¥å¤šå°‘ç›’é¥®å“ï¼Ÿ`
                    ];
                    const maTemplate = maTemplates[random(0, maTemplates.length - 1)];
                    question = maTemplate(num1, num2, num3);
                    break;

                case 'multiply_subtract':  // å…ˆä¹˜åå‡
                    num1 = random(20, 100);  // è¢«å‡æ•°ï¼ˆæ€»æ•°ï¼‰
                    num2 = random(2, 9);     // ä¹˜æ•°1
                    num3 = random(2, 9);     // ä¹˜æ•°2
                    // ç¡®ä¿ç»“æœéè´Ÿ
                    while (num1 < num2 * num3) {
                        num1 = random(num2 * num3 + 1, 100);
                    }
                    answer = num1 - num2 * num3;

                    const msTemplates = [
                        (a, b, c) => `å•†åº—æœ‰${a}ä¸ªç©å…·ï¼Œå–å‡º${b}ç›’ï¼Œæ¯ç›’${c}ä¸ªï¼Œè¿˜å‰©å¤šå°‘ä¸ªç©å…·ï¼Ÿ`,
                        (a, b, c) => `å°æ˜æœ‰${a}é¢—ç³–ï¼Œåˆ†ç»™${b}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦${c}é¢—ï¼Œè¿˜å‰©å¤šå°‘é¢—ç³–ï¼Ÿ`
                    ];
                    const msTemplate = msTemplates[random(0, msTemplates.length - 1)];
                    question = msTemplate(num1, num2, num3);
                    break;

                case 'divide_add':  // å…ˆé™¤ååŠ 
                    num3 = random(2, 9);     // é™¤æ•°
                    num2 = random(1, 12);    // å•†
                    num1 = num3 * num2;      // è¢«é™¤æ•°
                    const addNum = random(1, 20);  // åŠ æ•°
                    answer = num2 + addNum;

                    const daTemplates = [
                        (a, b, c) => `è€å¸ˆæŠŠ${a}æ”¯é“…ç¬”å¹³å‡åˆ†ç»™${b}ä¸ªåŒå­¦ï¼Œæ¯ä¸ªåŒå­¦åˆ†åˆ°çš„å†åŠ ${c}æ”¯ï¼Œæ¯ä¸ªåŒå­¦ä¸€å…±æœ‰å¤šå°‘æ”¯ï¼Ÿ`,
                        (a, b, c) => `æœ‰${a}æœµèŠ±ï¼Œæ¯${b}æœµæ‰æˆä¸€æŸï¼Œæ‰å¥½ååˆä¹°äº†${c}æœµï¼Œç°åœ¨ä¸€å…±æœ‰å¤šå°‘æœµèŠ±ï¼Ÿ`
                    ];
                    const daTemplate = daTemplates[random(0, daTemplates.length - 1)];
                    question = daTemplate(num1, num3, addNum);
                    break;

                case 'divide_subtract':  // å…ˆé™¤åå‡
                    num3 = random(2, 9);     // é™¤æ•°
                    num2 = random(5, 20);    // å•†ï¼ˆè¦å¤Ÿå‡ï¼‰
                    num1 = num3 * num2;      // è¢«é™¤æ•°
                    const subNum = random(1, num2 - 1);  // å‡æ•°
                    answer = num2 - subNum;

                    const dsTemplates = [
                        (a, b, c) => `å¦ˆå¦ˆæŠŠ${a}ä¸ªè‹¹æœå¹³å‡æ”¾åœ¨${b}ä¸ªç›˜å­é‡Œï¼Œæ¯ä¸ªç›˜å­åƒæ‰${c}ä¸ªï¼Œæ¯ä¸ªç›˜å­è¿˜å‰©å‡ ä¸ªï¼Ÿ`,
                        (a, b, c) => `æœ‰${a}é¢—ç å­ï¼Œæ¯${b}é¢—ä¸²æˆä¸€ä¸²ï¼Œä¸²å¥½åé€äºº${c}ä¸²ï¼Œè¿˜å‰©å¤šå°‘ä¸²ï¼Ÿ`
                    ];
                    const dsTemplate = dsTemplates[random(0, dsTemplates.length - 1)];
                    question = dsTemplate(num1, num3, subNum);
                    break;
            }

            return {
                type: 'wordProblem',
                question: question,
                operation: type,
                num1: num1,
                num2: num2,
                num3: num3,
                answer: answer,
                display: `æ··åˆè¿ç®—: ${question.substring(0, 20)}...`
            };
        }

        // è·å–é¢˜ç›®æ ¸å¿ƒæ ‡è¯†ç¬¦ï¼ˆç”¨äºå»é‡ï¼‰
        function getQuestionKey(question) {
            if (question.type === 'oral') {
                return `oral_${question.question}`;
            } else if (question.type === 'vertical') {
                // ç«–å¼é¢˜ä½¿ç”¨ operator å­—æ®µï¼ˆå¦‚ '+'ï¼‰ï¼Œä¸æ˜¯ operation
                return `vertical_${question.num1}_${question.operator}_${question.num2}`;
            } else if (question.type === 'wordProblem') {
                // åº”ç”¨é¢˜ä½¿ç”¨é¢˜ç›®å‰50ä¸ªå­—ç¬¦ä½œä¸ºæ ‡è¯†
                return `word_${question.question.substring(0, 50)}`;
            }
            return JSON.stringify(question);
        }

        // ç”Ÿæˆå”¯ä¸€é¢˜ç›®ï¼ˆå¸¦å»é‡ï¼‰
        function generateUniqueQuestion(generatorFunc, maxAttempts = 50) {
            let question;
            let attempts = 0;
            do {
                question = generatorFunc();
                const key = getQuestionKey(question);
                if (!currentQuestionKeys.has(key)) {
                    currentQuestionKeys.add(key);
                    return question;
                }
                attempts++;
            } while (attempts < maxAttempts);
            // å¦‚æœå°è¯•å¤šæ¬¡ä»é‡å¤ï¼Œç›´æ¥è¿”å›ï¼ˆé¿å…æ— é™å¾ªç¯ï¼‰
            return question;
        }

        // ç”Ÿæˆæ‰€æœ‰é¢˜ç›®
        function generateQuestions() {
            const grade = parseInt(document.getElementById('gradeSelect').value);
            const difficulty = document.getElementById('difficultySelect').value;

            const operationCheckboxes = document.querySelectorAll('.checkbox-item input[type="checkbox"]:checked');
            const operations = Array.from(operationCheckboxes).map(cb => cb.value).filter(op => ['add', 'subtract', 'multiply', 'divide', 'mixed', 'compare'].includes(op));

            const oralChecked = document.getElementById('oralCheck').checked;
            const verticalChecked = document.getElementById('verticalCheck').checked;
            const wordProblemChecked = document.getElementById('wordProblemCheck').checked;

            // éªŒè¯è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹
            if (!oralChecked && !verticalChecked && !wordProblemChecked) {
                showToast('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ç§é¢˜å‹', 'error');
                return false;
            }

            if (operations.length === 0) {
                showToast('âš ï¸ è¯·è‡³å°‘é€‰æ‹©ä¸€ç§è¿ç®—ç±»å‹', 'error');
                return false;
            }

            questions = [];
            currentQuestionKeys = new Set();  // é‡ç½®é¢˜ç›®è®°å½•

            // ç”Ÿæˆå£ç®—é¢˜ï¼ˆå¸¦å»é‡ï¼‰
            if (oralChecked) {
                const oralCount = parseInt(document.getElementById('oralCount').value);
                for (let i = 0; i < oralCount; i++) {
                    questions.push(generateUniqueQuestion(() => {
                        // æ¯æ¬¡é‡è¯•æ—¶éƒ½éšæœºé€‰æ‹©è¿ç®—ç±»å‹ï¼Œé¿å…å›ºå®šè¿ç®—å¯¼è‡´é‡å¤
                        const op = operations[random(0, operations.length - 1)];
                        if (op === 'mixed') {
                            const baseOps = operations.filter(o => o !== 'mixed');
                            const effectiveOps = baseOps.length > 0 ? baseOps : ['add', 'multiply'];
                            return generateMixedOralQuestion(grade, difficulty, effectiveOps);
                        } else {
                            return generateOralQuestion(grade, difficulty, op);
                        }
                    }));
                }
            }

            // ç”Ÿæˆç«–å¼é¢˜ï¼ˆå¸¦å»é‡ï¼‰
            if (verticalChecked) {
                const verticalCount = parseInt(document.getElementById('verticalCount').value);
                for (let i = 0; i < verticalCount; i++) {
                    questions.push(generateUniqueQuestion(() => {
                        // æ¯æ¬¡é‡è¯•æ—¶éƒ½éšæœºé€‰æ‹©è¿ç®—ç±»å‹
                        const op = operations[random(0, operations.length - 1)];
                        return generateVerticalQuestion(grade, difficulty, op);
                    }));
                }
            }

            // ç”Ÿæˆåº”ç”¨é¢˜ï¼ˆå¸¦å»é‡ï¼‰
            if (wordProblemChecked) {
                const wordProblemCount = parseInt(document.getElementById('wordProblemCount').value);
                for (let i = 0; i < wordProblemCount; i++) {
                    questions.push(generateUniqueQuestion(() => {
                        // æ¯æ¬¡é‡è¯•æ—¶éƒ½éšæœºé€‰æ‹©è¿ç®—ç±»å‹
                        const op = operations[random(0, operations.length - 1)];
                        if (op === 'mixed') {
                            const baseOps = operations.filter(o => o !== 'mixed');
                            const effectiveOps = baseOps.length > 0 ? baseOps : ['add', 'multiply'];
                            return generateMixedWordProblem(grade, effectiveOps);
                        } else {
                            return generateWordProblem(grade, difficulty, op);
                        }
                    }));
                }
            }

 // ä¸æ‰“ä¹±é¡ºåºï¼Œä¿æŒé¢˜ç›®é¡ºåºï¼šå£ç®— â†’ ç«–å¼ â†’ åº”ç”¨é¢˜

            // è®°å½•å„éƒ¨åˆ†çš„é¢˜ç›®æ•°é‡
            const oralCount = oralChecked ? parseInt(document.getElementById('oralCount').value) : 0;
            const verticalCount = verticalChecked ? parseInt(document.getElementById('verticalCount').value) : 0;
            const wordProblemCount2 = wordProblemChecked ? parseInt(document.getElementById('wordProblemCount').value) : 0;

            settings = { grade, difficulty, oralChecked, verticalChecked, wordProblemChecked, oralCount, verticalCount, wordProblemCount: wordProblemCount2 };

            return true;
        }

        // å¼€å§‹ç»ƒä¹ 
        function startPractice() {
            if (!generateQuestions()) return;

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');
            focusInput();
        }

        // è®¡æ—¶æµ‹è¯•
        function startTimedTest() {
            startPractice();
        }

        // è·å–å½“å‰éƒ¨åˆ†ä¿¡æ¯
        function getSectionInfo() {
            const oralCount = settings.oralCount || 0;
            const verticalCount = settings.verticalCount || 0;
            const wordProblemCount = settings.wordProblemCount || 0;

            if (currentQuestionIndex < oralCount) {
                return {
                    section: 'å£ç®—é¢˜',
                    current: currentQuestionIndex + 1,
                    total: oralCount,
                    globalIndex: currentQuestionIndex + 1
                };
            } else if (currentQuestionIndex < oralCount + verticalCount) {
                return {
                    section: 'ç«–å¼é¢˜',
                    current: currentQuestionIndex - oralCount + 1,
                    total: verticalCount,
                    globalIndex: currentQuestionIndex + 1
                };
            } else {
                return {
                    section: 'åº”ç”¨é¢˜',
                    current: currentQuestionIndex - oralCount - verticalCount + 1,
                    total: wordProblemCount,
                    globalIndex: currentQuestionIndex + 1
                };
            }
        }

        // æ˜¾ç¤ºé¢˜ç›®
        function showQuestion() {
            const q = questions[currentQuestionIndex];
            const sectionInfo = getSectionInfo();

            // æ˜¾ç¤ºéƒ¨åˆ†ä¿¡æ¯
            document.getElementById('currentQ').textContent = sectionInfo.globalIndex;
            document.getElementById('totalQ').textContent = questions.length;
            document.getElementById('sectionInfo').textContent = `${sectionInfo.section} - ç¬¬${sectionInfo.current}/${sectionInfo.total}é¢˜`;

            const progress = ((currentQuestionIndex) / questions.length) * 100;
            document.getElementById('progressFill').style.width = progress + '%';

            // æ˜¾ç¤ºæˆ–éšè—æ··åˆè¿ç®—æç¤º
            const isMixedQuestion = q.question && (q.question.includes('Ã—') || q.question.includes('Ã·')) &&
                                   (q.question.includes('+') || q.question.includes('-'));
            document.getElementById('mixedOperationHint').style.display = isMixedQuestion ? 'block' : 'none';

            // æ£€æŸ¥æ˜¯å¦åˆšåˆšåˆ‡æ¢åˆ°æ–°éƒ¨åˆ†ï¼Œæ˜¾ç¤ºæç¤º
            if (currentQuestionIndex > 0) {
                const prevQ = questions[currentQuestionIndex - 1];
                if (prevQ.type !== q.type) {
                    showToast(`ğŸ¯ è¿›å…¥${sectionInfo.section}ï¼š${sectionInfo.sectionName}`, 'success');
                }
            }

            if (q.type === 'oral') {
                // æ˜¾ç¤ºå£ç®—é¢˜
                document.getElementById('oralQuestionArea').style.display = 'block';
                document.getElementById('verticalQuestionArea').style.display = 'none';
                document.getElementById('wordProblemArea').style.display = 'none';
                document.getElementById('questionText').textContent = q.display;
                document.getElementById('answerInput').value = '';
                document.getElementById('questionTypeBadge').className = 'question-type-badge type-oral';
                document.getElementById('questionTypeBadge').textContent = 'ğŸ“ å£ç®—é¢˜';
            } else if (q.type === 'vertical') {
                // æ˜¾ç¤ºç«–å¼é¢˜
                document.getElementById('oralQuestionArea').style.display = 'none';
                document.getElementById('verticalQuestionArea').style.display = 'block';
                document.getElementById('wordProblemArea').style.display = 'none';
                document.getElementById('verticalNum1').textContent = q.num1;
                document.getElementById('verticalNum2').textContent = q.num2;
                document.getElementById('verticalOperator').textContent = q.operator;
                document.getElementById('verticalAnswerInput').value = '';
                document.getElementById('verticalHorizontalDisplay').textContent = `${q.display} = ?`;
                document.getElementById('questionTypeBadge').className = 'question-type-badge type-vertical';
                document.getElementById('questionTypeBadge').textContent = 'âœï¸ ç«–å¼é¢˜';
            } else if (q.type === 'wordProblem') {
                // æ˜¾ç¤ºåº”ç”¨é¢˜
                document.getElementById('oralQuestionArea').style.display = 'none';
                document.getElementById('verticalQuestionArea').style.display = 'none';
                document.getElementById('wordProblemArea').style.display = 'block';
                document.getElementById('wordProblemText').textContent = q.question;
                document.getElementById('wordProblemAnswerInput').value = '';
                document.getElementById('questionTypeBadge').className = 'question-type-badge type-word-problem';
                document.getElementById('questionTypeBadge').textContent = 'ğŸ“– åº”ç”¨é¢˜';
            }

            focusInput();
        }

        // èšç„¦è¾“å…¥æ¡†
        function focusInput() {
            setTimeout(() => {
                const q = questions[currentQuestionIndex];
                if (q.type === 'oral') {
                    document.getElementById('answerInput').focus();
                } else if (q.type === 'vertical') {
                    document.getElementById('verticalAnswerInput').focus();
                } else if (q.type === 'wordProblem') {
                    document.getElementById('wordProblemAnswerInput').focus();
                }
            }, 100);
        }

        // æ›´æ–°è®¡æ—¶å™¨
        function updateTimer() {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            document.getElementById('timer').textContent = formatTime(elapsed);
        }

        // æäº¤ç­”æ¡ˆ
        function submitAnswer() {
            const q = questions[currentQuestionIndex];
            let userAnswer;

            if (q.type === 'oral') {
                userAnswer = parseInt(document.getElementById('answerInput').value);
            } else if (q.type === 'vertical') {
                userAnswer = parseInt(document.getElementById('verticalAnswerInput').value);
            } else if (q.type === 'wordProblem') {
                userAnswer = parseInt(document.getElementById('wordProblemAnswerInput').value);
            }

            if (isNaN(userAnswer)) {
                showToast('è¯·è¾“å…¥ç­”æ¡ˆ', 'error');
                return;
            }

            const isCorrect = userAnswer === q.answer;

            if (isCorrect) {
                correctCount++;
                streak++;
                showToast('âœ… æ­£ç¡®ï¼', 'success');
            } else {
                wrongAnswers.push({
                    question: q.type === 'wordProblem' ? q.question : q.display,
                    correctAnswer: q.answer,
                    userAnswer: userAnswer,
                    type: q.type
                });
                streak = 0;
                showToast('âŒ é”™è¯¯ï¼', 'error');
            }

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // è·³è¿‡é¢˜ç›®
        function skipQuestion() {
            const q = questions[currentQuestionIndex];
            wrongAnswers.push({
                question: q.display,
                correctAnswer: q.answer,
                userAnswer: 'è·³è¿‡',
                type: q.type
            });

            currentQuestionIndex++;

            if (currentQuestionIndex >= questions.length) {
                showResult();
            } else {
                showQuestion();
            }
        }

        // æ˜¾ç¤ºç»“æœ
        function showResult() {
            clearInterval(timerInterval);

            const totalTime = Math.floor((Date.now() - startTime) / 1000);
            const accuracy = Math.round((correctCount / questions.length) * 100);

            document.getElementById('finalScore').textContent = accuracy;
            document.getElementById('resultTotal').textContent = questions.length;
            document.getElementById('resultCorrect').textContent = correctCount;
            document.getElementById('resultWrong').textContent = questions.length - correctCount;
            document.getElementById('resultTime').textContent = formatTime(totalTime);

            // è®¡ç®—å„éƒ¨åˆ†æˆç»©
            const oralCount = settings.oralCount || 0;
            const verticalCount = settings.verticalCount || 0;
            const wordProblemCount = settings.wordProblemCount || 0;

            let oralCorrect = 0;
            let verticalCorrect = 0;
            let wordProblemCorrect = 0;

            wrongAnswers.forEach(w => {
                if (w.type === 'oral') {
                    // é”™é¢˜
                } else if (w.type === 'vertical') {
                    // é”™é¢˜
                } else if (w.type === 'wordProblem') {
                    // é”™é¢˜
                }
            });

            // ç»Ÿè®¡å„éƒ¨åˆ†æ­£ç¡®æ•°
            for (let i = 0; i < oralCount; i++) {
                const q = questions[i];
                const isWrong = wrongAnswers.some(w => w.question === q.display);
                if (!isWrong) oralCorrect++;
            }

            for (let i = 0; i < verticalCount; i++) {
                const q = questions[oralCount + i];
                if (q) {
                    const isWrong = wrongAnswers.some(w => w.question === q.display);
                    if (!isWrong) verticalCorrect++;
                }
            }

            for (let i = 0; i < wordProblemCount; i++) {
                const q = questions[oralCount + verticalCount + i];
                if (q) {
                    const isWrong = wrongAnswers.some(w => w.question === q.question);
                    if (!isWrong) wordProblemCorrect++;
                }
            }

            // æ˜¾ç¤ºå„éƒ¨åˆ†æˆç»©
            const sectionCount = (oralCount > 0 ? 1 : 0) + (verticalCount > 0 ? 1 : 0) + (wordProblemCount > 0 ? 1 : 0);
            const gridCols = sectionCount === 3 ? 'repeat(3, 1fr)' : 'repeat(2, 1fr)';
            let sectionStatsHTML = `<div style="display: grid; grid-template-columns: ${gridCols}; gap: 10px;">`;

            if (oralCount > 0) {
                const oralAccuracy = oralCount > 0 ? Math.round((oralCorrect / oralCount) * 100) : 0;
                sectionStatsHTML += `
                    <div style="padding: 10px; background: white; border-radius: 8px; border-left: 3px solid var(--primary-color);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">å£ç®—é¢˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--primary-color);">${oralCorrect}/${oralCount}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">æ­£ç¡®ç‡ï¼š${oralAccuracy}%</div>
                    </div>
                `;
            }

            if (verticalCount > 0) {
                const verticalAccuracy = verticalCount > 0 ? Math.round((verticalCorrect / verticalCount) * 100) : 0;
                sectionStatsHTML += `
                    <div style="padding: 10px; background: white; border-radius: 8px; border-left: 3px solid var(--secondary-color);">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">ç«–å¼é¢˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: var(--secondary-color);">${verticalCorrect}/${verticalCount}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">æ­£ç¡®ç‡ï¼š${verticalAccuracy}%</div>
                    </div>
                `;
            }

            if (wordProblemCount > 0) {
                const wordProblemAccuracy = wordProblemCount > 0 ? Math.round((wordProblemCorrect / wordProblemCount) * 100) : 0;
                sectionStatsHTML += `
                    <div style="padding: 10px; background: white; border-radius: 8px; border-left: 3px solid #8b5cf6;">
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">åº”ç”¨é¢˜</div>
                        <div style="font-size: 1.2rem; font-weight: bold; color: #8b5cf6;">${wordProblemCorrect}/${wordProblemCount}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary);">æ­£ç¡®ç‡ï¼š${wordProblemAccuracy}%</div>
                    </div>
                `;
            }

            sectionStatsHTML += '</div>';
            document.getElementById('sectionStatsContent').innerHTML = sectionStatsHTML;
            const hasMultipleSections = (oralCount > 0 ? 1 : 0) + (verticalCount > 0 ? 1 : 0) + (wordProblemCount > 0 ? 1 : 0) > 1;
            document.getElementById('sectionStats').style.display = hasMultipleSections ? 'block' : 'none';

            // è¯„ä»·
            let title = '';
            if (accuracy >= 95) title = 'ğŸ† å¤ªæ£’äº†ï¼';
            else if (accuracy >= 85) title = 'ğŸ‰ å¾ˆä¼˜ç§€ï¼';
            else if (accuracy >= 70) title = 'ğŸ‘ ç»§ç»­åŠ æ²¹ï¼';
            else if (accuracy >= 60) title = 'ğŸ’ª éœ€è¦åŠªåŠ›ï¼';
            else title = 'ğŸ“š å¤šå¤šç»ƒä¹ ï¼';

            document.getElementById('resultTitle').textContent = title;

            // æ˜¾ç¤ºé”™é¢˜
            if (wrongAnswers.length > 0) {
                document.getElementById('wrongAnswersSection').style.display = 'block';
                document.getElementById('wrongAnswersList').innerHTML = wrongAnswers.map(w => `
                    <div class="wrong-item">
                        <div class="wrong-question">
                            <span style="font-size: 0.85rem; padding: 3px 8px; border-radius: 4px; margin-right: 8px; ${w.type === 'oral' ? 'background: #dbeafe; color: #1e40af;' : 'background: #fce7f3; color: #9d174d;'}">${w.type === 'oral' ? 'å£ç®—' : 'ç«–å¼'}</span>
                            ${w.question}
                        </div>
                        <div class="wrong-answer-info">
                            æ­£ç¡®ç­”æ¡ˆï¼š<span style="color: var(--success-color); font-weight: 600;">${w.correctAnswer}</span>
                            ä½ çš„ç­”æ¡ˆï¼š<span style="color: var(--danger-color);">${w.userAnswer}</span>
                        </div>
                    </div>
                `).join('');
            } else {
                document.getElementById('wrongAnswersSection').style.display = 'none';
            }

            // ä¿å­˜è®°å½•
            saveHistory(accuracy, totalTime);

            showSection('resultSection');
        }

        // é‡æ–°ç»ƒä¹ 
        function restart() {
            startPractice();
        }

        // é‡ç»ƒé”™é¢˜
        function practiceWrong() {
            if (wrongAnswers.length === 0) {
                showToast('æ²¡æœ‰é”™é¢˜éœ€è¦é‡ç»ƒ', 'error');
                return;
            }

            questions = wrongAnswers.map(w => {
                if (w.type === 'oral') {
                    return {
                        type: 'oral',
                        question: w.question,
                        answer: w.correctAnswer,
                        display: w.question
                    };
                } else {
                    // ä» display è§£æç«–å¼é¢˜
                    const parts = w.question.split(' ');
                    const num1 = parseInt(parts[0]);
                    const operator = parts[1];
                    const num2 = parseInt(parts[2]);
                    return {
                        type: 'vertical',
                        num1: num1,
                        num2: num2,
                        operator: operator,
                        answer: w.correctAnswer,
                        display: w.question
                    };
                }
            });

            currentQuestionIndex = 0;
            correctCount = 0;
            wrongAnswers = [];
            streak = 0;

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 1000);

            showQuestion();
            showSection('practiceSection');
        }

        // è¿”å›ä¸»é¡µ
        function goHome() {
            clearInterval(timerInterval);
            loadStats();
            showSection('homeSection');
        }

        // æ˜¾ç¤ºæ‰“å°è®¾ç½®å¯¹è¯æ¡†
        function showPrintDialog() {
            // é¢„å…ˆåˆå§‹åŒ– settingsï¼ˆå¦‚æœè¿˜æ²¡æœ‰åˆå§‹åŒ–ï¼‰
            if (!settings.grade || Object.keys(settings).length === 0) {
                const success = generateQuestions();
                if (!success) return;
            }

            const dialog = document.getElementById('printDialog');
            dialog.style.display = 'flex';
            // å¼ºåˆ¶é‡ç»˜ï¼Œç¡®ä¿æ˜¾ç¤ºç”Ÿæ•ˆ
            dialog.offsetHeight;
        }

        // å…³é—­æ‰“å°è®¾ç½®å¯¹è¯æ¡†
        function closePrintDialog() {
            document.getElementById('printDialog').style.display = 'none';
        }

        // ç¡®è®¤ç”Ÿæˆè¯•å·
        function confirmGeneratePrint() {
            const copies = parseInt(document.getElementById('printCopies').value);
            const sameQuestions = document.getElementById('sameQuestions').checked;

            // ç«‹å³å…³é—­å¯¹è¯æ¡†
            const dialog = document.getElementById('printDialog');
            dialog.style.display = 'none';

            // ä½¿ç”¨ setTimeout ç¡®ä¿å¯¹è¯æ¡†å…³é—­åå†ç”Ÿæˆï¼Œé¿å…äº‹ä»¶å†²çª
            setTimeout(() => {
                generatePrint(copies, sameQuestions);
            }, 100);
        }

        // ç”Ÿæˆæ‰“å°è¯•å·
        function generatePrint(copies = 1, sameQuestions = true) {
            // ç¡®ä¿ settings å·²åˆå§‹åŒ–ï¼ˆå¦‚æœç”¨æˆ·ç›´æ¥ç‚¹å‡»ç”Ÿæˆè¯•å·æŒ‰é’®ï¼‰
            if (!settings.grade || Object.keys(settings).length === 0) {
                const success = generateQuestions();
                if (!success) return;
            }

            const printContent = document.getElementById('printContent');
            let html = '';

            // ä¿å­˜åŸå§‹è®¾ç½®
            const originalSettings = {...settings};

            for (let copyIndex = 0; copyIndex < copies; copyIndex++) {
                // ç¬¬ä¸€ä»½è¯•å·ï¼Œéœ€è¦å…ˆç”Ÿæˆé¢˜ç›®
                if (copyIndex === 0) {
                    if (!generateQuestions()) {
                        showToast('âš ï¸ ç”Ÿæˆè¯•å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®', 'error');
                        return;
                    }
                } else if (!sameQuestions) {
                    // ä¸ä½¿ç”¨ç›¸åŒé¢˜ç›®ï¼Œé‡æ–°ç”Ÿæˆ
                    if (!generateQuestions()) {
                        showToast('âš ï¸ ç”Ÿæˆè¯•å·å¤±è´¥ï¼Œè¯·æ£€æŸ¥è®¾ç½®', 'error');
                        return;
                    }
                }
                // å¦‚æœ sameQuestions = true ä¸” copyIndex > 0ï¼Œä½¿ç”¨ç›¸åŒçš„é¢˜ç›®ï¼Œä¸éœ€è¦é‡æ–°ç”Ÿæˆ

                const oralCount = settings.oralCount || 0;
                const verticalCount = settings.verticalCount || 0;
                const wordProblemCount = settings.wordProblemCount || 0;

                // æ¯ä»½è¯•å·ç”¨ä¸€ä¸ªwrapperåŒ…è£¹ï¼Œé¿å…å†…éƒ¨å…ƒç´ è¢«åˆ†é¡µè§„åˆ™å½±å“
                html += '<div class="print-copy-wrapper">';

                // æ¯ä»½è¯•å·éƒ½æ·»åŠ æŠ¬å¤´
                html += '<div class="print-header">';
                html += '<h1>å°å­¦æ•°å­¦ç»ƒä¹ é¢˜</h1>';
                html += '</div>';
                html += '<div class="print-info">';
                html += '<div>å§“åï¼š__________</div>';
                html += '<div>æ—¥æœŸï¼š__________</div>';
                html += '<div>ç”¨æ—¶ï¼š__________</div>';
                html += '<div>å¾—åˆ†ï¼š__________</div>';
                html += '</div>';

                // æ‰“å°å£ç®—é¢˜
                if (oralCount > 0) {
                    html += '<div class="print-section">';
                    html += '<div class="print-section-title">å£ç®—é¢˜ï¼ˆæ¯é¢˜2åˆ†ï¼Œå…±' + (oralCount * 2) + 'åˆ†ï¼‰</div>';
                    html += '<div style="display: flex; flex-wrap: wrap; align-items: center;">';

                    for (let i = 0; i < oralCount; i++) {
                        const q = questions[i];
                        const questionText = q.question.toString();
                        html += `
                            <div class="print-oral">${questionText}&nbsp;=&nbsp;____</div>
                        `;
                    }

                    html += '</div></div>';
                }

                // æ‰“å°ç«–å¼é¢˜ - åŒ…å«æ¨ªå¼å’Œç«–å¼
                if (verticalCount > 0) {
                    html += '<div class="print-section">';
                    html += '<div class="print-section-title">ç«–å¼é¢˜ï¼ˆç”¨ç«–å¼è®¡ç®—ï¼Œæ¯é¢˜2åˆ†ï¼Œå…±' + (verticalCount * 2) + 'åˆ†ï¼‰</div>';
                    html += '<div style="display: flex; flex-wrap: wrap;">';

                    for (let i = 0; i < verticalCount; i++) {
                        const q = questions[oralCount + i];
                        const num1Str = q.num1.toString();
                        const num2Str = q.num2.toString();
                        const maxLength = Math.max(num1Str.length, num2Str.length);

                        html += `
                            <div class="print-vertical">
                                <div class="print-vertical-horizontal">${q.display}&nbsp;=&nbsp;____</div>
                                <div class="print-vertical-calculation">
                                    <div class="print-vertical-numbers">
                                        <div>${'&nbsp;'.repeat(maxLength - num1Str.length)}${num1Str}</div>
                                        <div>${q.operator}&nbsp;${'&nbsp;'.repeat(maxLength - num2Str.length)}${num2Str}</div>
                                    </div>
                                    <div class="print-vertical-line"></div>
                                    <div class="print-vertical-answer"></div>
                                </div>
                            </div>
                        `;
                    }

                    html += '</div></div>';
                }

                // æ‰“å°åº”ç”¨é¢˜
                if (wordProblemCount > 0) {
                    html += '<div class="print-section">';
                    html += '<div class="print-section-title">åº”ç”¨é¢˜ï¼ˆæ¯é¢˜5åˆ†ï¼Œå…±' + (wordProblemCount * 5) + 'åˆ†ï¼‰</div>';
                    html += '<div style="display: flex; flex-direction: column; gap: 12px;">';

                    for (let i = 0; i < wordProblemCount; i++) {
                        const q = questions[oralCount + verticalCount + i];
                        html += `
                            <div style="padding: 8px; background: #f9f9f9; border-left: 3px solid #8b5cf6; page-break-inside: avoid;">
                                <div style="font-size: 0.9rem; line-height: 1.5; margin-bottom: 8px;">${i + 1}. ${q.question}</div>
                                <div style="border: 1px dashed #ccc; padding: 8px; min-height: 60px; background: white;">
                                    <div style="font-size: 0.7rem; color: #999; margin-bottom: 3px;">ğŸ“ è§£ç­”åŒºåŸŸ</div>
                                </div>
                            </div>
                        `;
                    }

                    html += '</div></div>';
                }

                // æ·»åŠ è‰ç¨¿åŒºåŸŸï¼ˆæ™ºèƒ½åˆ¤æ–­æ˜¯å¦ä¼šè·¨é¡µï¼‰
                const totalQuestions = oralCount + verticalCount + wordProblemCount;

                // æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦è‰ç¨¿åŒº
                const hasVertical = verticalCount > 0;
                const hasWordProblem = wordProblemCount > 0;
                const needsDraft = hasVertical || hasWordProblem || totalQuestions <= 25;

                // ä¼°ç®—é¡µé¢å ç”¨é«˜åº¦ï¼ˆå•ä½ï¼šmmï¼‰
                // A4é¡µé¢å¯ç”¨é«˜åº¦çº¦ 270mmï¼ˆå‡å»é¡µè¾¹è·ï¼‰
                const pageHeight = 270;
                const headerHeight = 30; // è¯•å·å¤´éƒ¨
                const oralHeight = oralCount * 10; // æ¯é“å£ç®—é¢˜çº¦10mm
                const verticalHeight = verticalCount * 30; // æ¯é“ç«–å¼é¢˜çº¦30mm
                const wordProblemHeight = wordProblemCount * 40; // æ¯é“åº”ç”¨é¢˜çº¦40mmï¼ˆç¼©å°åï¼‰

                // è‰ç¨¿åŒºé«˜åº¦ä¼°ç®—
                let draftLinesPerCol = 4;
                if (hasVertical && hasWordProblem) {
                    draftLinesPerCol = 3;
                } else if (hasWordProblem) {
                    draftLinesPerCol = 5;
                } else if (totalQuestions <= 15) {
                    draftLinesPerCol = 6;
                }
                const draftHeight = 20 + draftLinesPerCol * 2 * 8; // æ ‡é¢˜20mm + æ¯è¡Œ8mm

                // è®¡ç®—æ€»é«˜åº¦
                const currentHeight = headerHeight + oralHeight + verticalHeight + wordProblemHeight;
                const totalHeight = currentHeight + draftHeight;

                // åªæœ‰åœ¨ä¸è·¨é¡µçš„æƒ…å†µä¸‹æ‰æ·»åŠ è‰ç¨¿åŒº
                if (needsDraft && totalQuestions <= 50 && totalHeight <= pageHeight) {
                    html += '<div class="print-draft-area">';
                    html += '<div class="print-draft-title">ğŸ“ è‰ç¨¿åŒºï¼ˆåˆ—ç«–å¼è®¡ç®—ï¼‰</div>';
                    html += '<div class="print-draft-lines">';

                    // å·¦å³ä¸¤åˆ—ï¼Œæ¯åˆ—è‹¥å¹²è¡Œ
                    for (let col = 0; col < 2; col++) {
                        html += '<div class="print-draft-column">';
                        for (let line = 0; line < draftLinesPerCol; line++) {
                            html += '<div class="print-draft-item"></div>';
                        }
                        html += '</div>';
                    }

                    html += '</div></div>';
                }

                html += '</div>'; // ç»“æŸ print-copy-wrapper
            }

            // æ¢å¤åŸå§‹è®¾ç½®
            settings = originalSettings;

            printContent.innerHTML = html;

            // æ˜¾ç¤ºæç¤º
            if (copies > 1) {
                showToast(`âœ… å·²ç”Ÿæˆ${copies}ä»½è¯•å·ï¼Œå‡†å¤‡æ‰“å°...`, 'success');
                setTimeout(() => {
                    window.print();
                }, 500);
            } else {
                window.print();
            }
        }

        // ä¿å­˜å†å²è®°å½•
        function saveHistory(accuracy, time) {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');

            history.unshift({
                date: new Date().toLocaleString('zh-CN'),
                grade: settings.grade,
                difficulty: settings.difficulty,
                count: questions.length,
                correct: correctCount,
                total: questions.length,
                accuracy: accuracy,
                time: time,
                types: settings.oralChecked && settings.verticalChecked ? 'æ··åˆ' : (settings.oralChecked ? 'å£ç®—' : 'ç«–å¼')
            });

            if (history.length > 50) history.pop();

            localStorage.setItem('mathPracticeHistory', JSON.stringify(history));
            loadStats();
        }

        // åŠ è½½å†å²è®°å½•
        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');
            const historyList = document.getElementById('historyList');

            if (history.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— ç»ƒä¹ è®°å½•</p>';
                return;
            }

            historyList.innerHTML = history.map((h, i) => `
                <div class="history-item">
                    <div class="history-date">${h.date} | ${h.types || 'æ··åˆ'}</div>
                    <div class="history-stats">
                        <span>æ­£ç¡®ç‡ï¼š${h.accuracy}%</span>
                        <span>é¢˜ç›®ï¼š${h.correct}/${h.total}</span>
                        <span>ç”¨æ—¶ï¼š${formatTime(h.time)}</span>
                    </div>
                </div>
            `).join('');
        }

        // æ˜¾ç¤ºå†å²è®°å½•
        function showHistory() {
            loadHistory();
            showSection('historySection');
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰ç»ƒä¹ è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('mathPracticeHistory');
                loadHistory();
                loadStats();
                showToast('è®°å½•å·²æ¸…ç©º');
            }
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        function loadStats() {
            const history = JSON.parse(localStorage.getItem('mathPracticeHistory') || '[]');

            const today = new Date().toDateString();
            const todayCount = history.filter(h => new Date(h.date).toDateString() === today).length;
            document.getElementById('todayCount').textContent = todayCount;

            if (history.length > 0) {
                const avgAcc = Math.round(history.reduce((sum, h) => sum + h.accuracy, 0) / history.length);
                document.getElementById('avgAccuracy').textContent = avgAcc + '%';
            }

            const totalQuestions = history.reduce((sum, h) => sum + h.total, 0);
            document.getElementById('totalQuestions').textContent = totalQuestions;

            const bestStreak = parseInt(localStorage.getItem('mathPracticeBestStreak') || '0');
            document.getElementById('bestStreak').textContent = bestStreak;
        }

        // è¯»é¢˜
        function readQuestion() {
            const q = questions[currentQuestionIndex];
            let text;

            if (q.type === 'oral') {
                text = q.question.replace('Ã—', 'ä¹˜ä»¥').replace('Ã·', 'é™¤ä»¥').replace('+', 'åŠ ').replace('-', 'å‡');
                text += 'ç­‰äºå‡ ';
            } else {
                text = `${q.num1} ${q.operator === '+' ? 'åŠ ' : q.operator === '-' ? 'å‡' : q.operator === 'Ã—' ? 'ä¹˜ä»¥' : 'é™¤ä»¥'} ${q.num2}ï¼Œç«–å¼è®¡ç®—`;
            }

            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'zh-CN';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            } else {
                showToast('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åŠŸèƒ½', 'error');
            }
        }

        // é”®ç›˜äº‹ä»¶
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                submitAnswer();
            }
        }

        // ç‰ˆæœ¬ä¿¡æ¯
        console.log('å°å­¦æ•°å­¦å¿«é€Ÿå‡ºé¢˜å™¨ v1.2.2');
        console.log('æ›´æ–°æ—¶é—´ï¼š2026å¹´2æœˆ6æ—¥');
        console.log('æ–°åŠŸèƒ½ï¼šæ··åˆè¿ç®— + æ¯”è¾ƒç±»åº”ç”¨é¢˜ï¼ˆæ¯”å¤šæ¯”å°‘ï¼‰');
    </script>
</body>
</html>
