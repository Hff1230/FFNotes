<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å°çŒ«é’“é±¼ - æ‰‘å…‹ç‰Œæ¸¸æˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
        }

        body {
            font-family: 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #1a5f2a 0%, #2d8f4a 50%, #1a5f2a 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
            overflow: hidden;
        }

        .game-container {
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* æ ‡é¢˜ */
        .title {
            text-align: center;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            font-size: clamp(24px, 5vw, 36px);
            font-weight: bold;
            letter-spacing: 4px;
        }

        .title::before, .title::after {
            content: 'ğŸŸ';
            margin: 0 10px;
        }

        /* ä¿¡æ¯æ  */
        .info-bar {
            display: flex;
            justify-content: space-between;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
        }

        .player-info {
            text-align: center;
        }

        .player-info.computer {
            color: #ff6b6b;
        }

        .player-info.player {
            color: #4ecdc4;
        }

        .player-name {
            font-size: 14px;
            opacity: 0.8;
        }

        .card-count {
            font-size: 24px;
            font-weight: bold;
        }

        /* æ¸¸æˆåŒºåŸŸ */
        .game-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 15px;
            min-height: 300px;
        }

        /* ç‰Œå †åŒº */
        .card-area {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .deck {
            position: relative;
            width: 70px;
            height: 100px;
        }

        .deck-stack {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 8px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }

        .deck-stack:nth-child(2) { transform: translate(2px, 2px); }
        .deck-stack:nth-child(3) { transform: translate(4px, 4px); }

        .deck-back {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2563eb, #1d4ed8);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            border: 2px solid #3b82f6;
        }

        .deck-count {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.6);
            color: white;
            padding: 2px 10px;
            border-radius: 10px;
            font-size: 12px;
        }

        /* å…¬å…±ç‰Œå † - ç«–å‘å æ”¾ */
        .pile-area {
            min-width: 100px;
            min-height: 180px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            border: 2px dashed rgba(255,255,255,0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            position: relative;
        }

        .pile-label {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.6);
            font-size: 12px;
            white-space: nowrap;
        }

        .pile-count {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(0,0,0,0.5);
            color: #ffd700;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: bold;
        }

        .pile-stack {
            position: relative;
            width: 60px;
            min-height: 84px;
            margin-top: 10px;
        }

        .pile-stack .card {
            position: absolute;
            left: 0;
        }

        /* æ‰‘å…‹ç‰Œ */
        .card {
            width: 60px;
            height: 84px;
            background: white;
            border-radius: 6px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
            position: relative;
            cursor: default;
            padding: 3px;
        }

        .card.red { color: #dc2626; }
        .card.black { color: #1f2937; }

        /* å·¦ä¸Šè§’ */
        .card-corner-top {
            position: absolute;
            top: 3px;
            left: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
        }

        /* å³ä¸‹è§’ï¼ˆæ—‹è½¬180åº¦ï¼‰ */
        .card-corner-bottom {
            position: absolute;
            bottom: 3px;
            right: 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1;
            transform: rotate(180deg);
        }

        .card-rank {
            font-size: 14px;
            line-height: 1;
        }

        .card-suit {
            font-size: 12px;
            line-height: 1;
        }

        .card.highlight {
            animation: pulse 0.5s ease infinite;
            box-shadow: 0 0 15px #ffd700;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .card.new-card {
            animation: dealCard 0.3s ease;
        }

        @keyframes dealCard {
            from {
                transform: translateY(-50px) rotate(-10deg);
                opacity: 0;
            }
            to {
                transform: translateY(0) rotate(0);
                opacity: 1;
            }
        }

        .card.collect-card {
            animation: collectCard 0.5s ease forwards;
        }

        @keyframes collectCard {
            to {
                transform: scale(0) rotate(180deg);
                opacity: 0;
            }
        }

        /* ç©å®¶åŒºåŸŸ */
        .player-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }

        .player-deck {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .player-deck-label {
            color: white;
            font-size: 12px;
            opacity: 0.8;
        }

        /* æŒ‰é’® */
        .btn {
            padding: 12px 30px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-play {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .btn-play:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.6);
        }

        .btn-play:active:not(:disabled) {
            transform: translateY(0);
        }

        .btn-play:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-restart {
            background: linear-gradient(135deg, #6366f1, #4f46e5);
            color: white;
            padding: 8px 20px;
            font-size: 14px;
        }

        .btn-restart:hover {
            transform: scale(1.05);
        }

        /* æ¶ˆæ¯ */
        .message {
            text-align: center;
            color: #ffd700;
            font-size: 16px;
            min-height: 24px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .message.success {
            animation: bounce 0.5s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* æ¸¸æˆç»“æŸé®ç½© */
        .game-over {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .game-over.show {
            display: flex;
        }

        .game-over-content {
            text-align: center;
            color: white;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        .game-over-title {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .game-over-title.win { color: #ffd700; }
        .game-over-title.lose { color: #ff6b6b; }

        .game-over-text {
            font-size: 24px;
            margin-bottom: 30px;
        }

        /* è§„åˆ™æç¤º */
        .rules {
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            color: rgba(255,255,255,0.8);
            font-size: 12px;
            line-height: 1.6;
        }

        .rules-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 8px;
        }

        /* å“åº”å¼ */
        @media (max-width: 400px) {
            .card {
                width: 50px;
                height: 70px;
            }
            .card-rank { font-size: 12px; }
            .card-suit { font-size: 10px; }
            .deck { width: 55px; height: 78px; }
            .pile-area { min-height: 120px; }
            .pile-stack { width: 50px; min-height: 70px; }
        }

        /* è‡ªåŠ¨è¿›è¡ŒæŒ‡ç¤º */
        .auto-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: #4ecdc4;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
        }

        .auto-indicator.show {
            display: block;
            animation: blink 1s ease infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Agentå¯è§†åŒ–é¢æ¿ */
        .agent-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            width: 280px;
            max-height: 90vh;
            background: rgba(0,0,0,0.85);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-size: 12px;
            overflow-y: auto;
            z-index: 50;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.1);
        }

        .agent-panel::-webkit-scrollbar {
            width: 6px;
        }

        .agent-panel::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
        }

        .agent-panel::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .agent-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .agent-title {
            font-size: 14px;
            font-weight: bold;
            color: #4ecdc4;
        }

        .agent-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 11px;
        }

        .agent-toggle:hover {
            background: rgba(255,255,255,0.3);
        }

        .agent-section {
            margin-bottom: 12px;
        }

        .agent-section-title {
            color: #ffd700;
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .agent-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .agent-stat {
            background: rgba(255,255,255,0.1);
            padding: 8px;
            border-radius: 8px;
            text-align: center;
        }

        .agent-stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #4ecdc4;
        }

        .agent-stat-label {
            font-size: 10px;
            opacity: 0.7;
            margin-top: 2px;
        }

        .agent-decision {
            background: rgba(78, 205, 196, 0.2);
            border-left: 3px solid #4ecdc4;
            padding: 10px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 10px;
        }

        .agent-decision-title {
            color: #4ecdc4;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .agent-decision-text {
            line-height: 1.5;
            opacity: 0.9;
        }

        .agent-memory {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            max-height: 80px;
            overflow-y: auto;
        }

        .memory-card {
            width: 28px;
            height: 38px;
            background: white;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
        }

        .memory-card.red { color: #dc2626; }
        .memory-card.black { color: #1f2937; }
        .memory-card.highlight {
            box-shadow: 0 0 8px #ffd700;
            transform: scale(1.1);
        }

        .agent-log {
            max-height: 100px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 8px;
        }

        .log-entry {
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 11px;
            line-height: 1.4;
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.win {
            color: #4ecdc4;
        }

        .log-entry.lose {
            color: #ff6b6b;
        }

        .log-entry.info {
            color: #ffd700;
        }

        .probability-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ecdc4, #44a08d);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            font-size: 10px;
            font-weight: bold;
        }

        .probability-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 3px;
        }

        .agent-collapsed {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Agentå¯è§†åŒ–é¢æ¿ -->
    <div class="agent-panel" id="agentPanel">
        <div class="agent-header">
            <span class="agent-title">ğŸ± Agent å¯è§†åŒ–</span>
            <button class="agent-toggle" onclick="toggleAgentPanel()">æ”¶èµ·</button>
        </div>

        <div id="agentContent">
            <div class="agent-section">
                <div class="agent-section-title">ğŸ“Š çŠ¶æ€ç»Ÿè®¡</div>
                <div class="agent-stats">
                    <div class="agent-stat">
                        <div class="agent-stat-value" id="agentCardCount">26</div>
                        <div class="agent-stat-label">æ‰‹ç‰Œæ•°</div>
                    </div>
                    <div class="agent-stat">
                        <div class="agent-stat-value" id="agentWinRate">50%</div>
                        <div class="agent-stat-label">èƒœç‡é¢„ä¼°</div>
                    </div>
                    <div class="agent-stat">
                        <div class="agent-stat-value" id="agentMemoryCount">0</div>
                        <div class="agent-stat-label">è®°å¿†ç‰Œæ•°</div>
                    </div>
                    <div class="agent-stat">
                        <div class="agent-stat-value" id="agentCollects">0</div>
                        <div class="agent-stat-label">æ”¶ç‰Œæ¬¡æ•°</div>
                    </div>
                </div>
            </div>

            <div class="agent-section">
                <div class="agent-section-title">ğŸ§  å½“å‰å†³ç­–</div>
                <div class="agent-decision" id="agentDecision">
                    <div class="agent-decision-title">ç­‰å¾…å‡ºç‰Œ...</div>
                    <div class="agent-decision-text">æ¸¸æˆå¼€å§‹åï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºAIçš„å†³ç­–åˆ†æ</div>
                </div>
            </div>

            <div class="agent-section">
                <div class="agent-section-title">
                    <span>ğŸ“ å·²è®°å¿†çš„ç‰Œ</span>
                    <span style="float:right; opacity:0.7;">å¯åŒ¹é…çš„ç‰Œ</span>
                </div>
                <div class="agent-memory" id="agentMemory"></div>
            </div>

            <div class="agent-section">
                <div class="agent-section-title">ğŸ“ˆ æ”¶ç‰Œæ¦‚ç‡</div>
                <div class="probability-label">
                    <span>åŸºäºå…¬å…±ç‰Œå †åˆ†æ</span>
                    <span id="probValue">0%</span>
                </div>
                <div class="probability-bar">
                    <div class="probability-fill" id="probBar" style="width: 0%"></div>
                </div>
            </div>

            <div class="agent-section">
                <div class="agent-section-title">ğŸ“œ å†³ç­–æ—¥å¿—</div>
                <div class="agent-log" id="agentLog">
                    <div class="log-entry info">æ¸¸æˆåˆå§‹åŒ–å®Œæˆ</div>
                </div>
            </div>
        </div>

        <div id="agentCollapsed" class="agent-collapsed">
            <div style="text-align:center; opacity:0.7;">é¢æ¿å·²æ”¶èµ·</div>
        </div>
    </div>

    <div class="auto-indicator" id="autoIndicator">ç”µè„‘æ€è€ƒä¸­...</div>

    <div class="game-container">
        <h1 class="title">å°çŒ«é’“é±¼</h1>

        <div class="info-bar">
            <div class="player-info computer">
                <div class="player-name">ğŸ± ç”µè„‘</div>
                <div class="card-count" id="computerCount">26</div>
            </div>
            <div class="player-info">
                <div class="player-name">å›åˆ</div>
                <div class="card-count" id="turnCount">1</div>
            </div>
            <div class="player-info player">
                <div class="player-name">ğŸ‘¤ ç©å®¶</div>
                <div class="card-count" id="playerCount">26</div>
            </div>
        </div>

        <div class="game-area">
            <div class="player-area">
                <div class="player-deck">
                    <div class="deck">
                        <div class="deck-stack"></div>
                        <div class="deck-stack"></div>
                        <div class="deck-stack"></div>
                        <div class="deck-back">ğŸ±</div>
                    </div>
                    <span class="deck-count" id="computerDeckCount">26å¼ </span>
                </div>

                <div class="pile-area" id="pileArea">
                    <span class="pile-count" id="pileCount">0å¼ </span>
                    <div class="pile-stack" id="pileStack"></div>
                    <span class="pile-label">å…¬å…±ç‰Œå †</span>
                </div>

                <div class="player-deck">
                    <div class="deck">
                        <div class="deck-stack"></div>
                        <div class="deck-stack"></div>
                        <div class="deck-stack"></div>
                        <div class="deck-back">ğŸ‘¤</div>
                    </div>
                    <span class="deck-count" id="playerDeckCount">26å¼ </span>
                </div>
            </div>

            <div class="message" id="message">ç‚¹å‡»"å‡ºç‰Œ"å¼€å§‹æ¸¸æˆï¼</div>

            <div style="display: flex; gap: 10px;">
                <button class="btn btn-play" id="playBtn" onclick="playerPlay()">å‡º ç‰Œ</button>
                <button class="btn btn-restart" onclick="initGame()">é‡æ–°å¼€å§‹</button>
            </div>
        </div>

        <div class="rules">
            <div class="rules-title">ğŸ“œ æ¸¸æˆè§„åˆ™</div>
            è½®æµå‡ºç‰Œåˆ°å…¬å…±ç‰Œå †ï¼Œå½“å‡ºçš„ç‰Œä¸ç‰Œå †ä¸­æŸå¼ ç‰Œ<b>ç‚¹æ•°ç›¸åŒ</b>æ—¶ï¼Œæ”¶èµ°ä¸¤å¼ ç›¸åŒç‰Œä¹‹é—´çš„æ‰€æœ‰ç‰Œã€‚å…ˆå‡ºå®Œç‰Œçš„ä¸€æ–¹è¾“æ‰æ¸¸æˆï¼
        </div>
    </div>

    <div class="game-over" id="gameOver">
        <div class="game-over-content">
            <div class="game-over-title" id="gameOverTitle">ğŸ‰ èƒœåˆ©ï¼</div>
            <div class="game-over-text" id="gameOverText">æ­å–œä½ èµ¢å¾—äº†æ¯”èµ›ï¼</div>
            <button class="btn btn-play" onclick="initGame()">å†æ¥ä¸€å±€</button>
        </div>
    </div>

    <script>
        // èŠ±è‰²å®šä¹‰
        const SUITS = ['â™ ', 'â™¥', 'â™¦', 'â™£'];
        const SUIT_COLORS = {'â™ ': 'black', 'â™¥': 'red', 'â™¦': 'red', 'â™£': 'black'};
        const RANKS = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K'];

        // æ¸¸æˆçŠ¶æ€
        let playerDeck = [];
        let computerDeck = [];
        let pile = [];
        let isPlayerTurn = true;
        let gameOver = false;
        let turnCount = 1;
        let isAnimating = false;

        // AgentçŠ¶æ€
        let agentMemory = new Map(); // è®°å¿†å·²å‡ºçš„ç‰Œ
        let agentCollects = 0; // æ”¶ç‰Œæ¬¡æ•°
        let agentLog = []; // å†³ç­–æ—¥å¿—
        let isPanelCollapsed = false;

        // åˆ›å»ºä¸€å‰¯ç‰Œ
        function createDeck() {
            const deck = [];
            for (let suit of SUITS) {
                for (let i = 0; i < RANKS.length; i++) {
                    deck.push({
                        suit: suit,
                        rank: RANKS[i],
                        value: i + 1,
                        color: SUIT_COLORS[suit]
                    });
                }
            }
            return deck;
        }

        // æ´—ç‰Œ
        function shuffle(deck) {
            for (let i = deck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [deck[i], deck[j]] = [deck[j], deck[i]];
            }
            return deck;
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        function initGame() {
            const deck = shuffle(createDeck());
            playerDeck = deck.slice(0, 26);
            computerDeck = deck.slice(26);
            pile = [];
            isPlayerTurn = true;
            gameOver = false;
            turnCount = 1;
            isAnimating = false;

            // é‡ç½®AgentçŠ¶æ€
            agentMemory = new Map();
            agentCollects = 0;
            agentLog = [];

            updateUI();
            updatePileDisplay();
            updateAgentPanel();
            addAgentLog('info', 'æ¸¸æˆåˆå§‹åŒ–å®Œæˆï¼Œå¼€å§‹æ–°æ¸¸æˆ');
            document.getElementById('gameOver').classList.remove('show');
            document.getElementById('autoIndicator').classList.remove('show');
            document.getElementById('playBtn').disabled = false;
            showMessage('ç‚¹å‡»"å‡ºç‰Œ"å¼€å§‹æ¸¸æˆï¼');
        }

        // åˆ›å»ºå¡ç‰Œå…ƒç´ 
        function createCardElement(card, isNew = false) {
            const div = document.createElement('div');
            div.className = `card ${card.color}${isNew ? ' new-card' : ''}`;
            div.innerHTML = `
                <div class="card-corner-top">
                    <span class="card-rank">${card.rank}</span>
                    <span class="card-suit">${card.suit}</span>
                </div>
                <div class="card-corner-bottom">
                    <span class="card-rank">${card.rank}</span>
                    <span class="card-suit">${card.suit}</span>
                </div>
            `;
            div.dataset.value = card.value;
            return div;
        }

        // æ›´æ–°UI
        function updateUI() {
            document.getElementById('playerCount').textContent = playerDeck.length;
            document.getElementById('computerCount').textContent = computerDeck.length;
            document.getElementById('playerDeckCount').textContent = playerDeck.length + 'å¼ ';
            document.getElementById('computerDeckCount').textContent = computerDeck.length + 'å¼ ';
            document.getElementById('turnCount').textContent = turnCount;
        }

        // æ›´æ–°å…¬å…±ç‰Œå †æ˜¾ç¤º - ç«–å‘å æ”¾
        function updatePileDisplay() {
            const pileArea = document.getElementById('pileArea');
            pileArea.innerHTML = `
                <span class="pile-count" id="pileCount">${pile.length}å¼ </span>
                <div class="pile-stack" id="pileStack"></div>
                <span class="pile-label">å…¬å…±ç‰Œå †</span>
            `;

            const pileStack = document.getElementById('pileStack');

            if (pile.length === 0) return;

            // è®¡ç®—å æ”¾ï¼šå‘ä¸‹åç§»
            const cardOffsetY = 20;  // æ¯å¼ ç‰Œçš„å‚ç›´åç§»ï¼ˆéœ²å‡ºå·¦ä¸Šè§’æ•°å­—ï¼‰
            const maxVisible = 10;   // æœ€å¤šæ˜¾ç¤ºçš„ç‰Œæ•°
            const showCount = Math.min(pile.length, maxVisible);
            const startIndex = Math.max(0, pile.length - showCount);

            for (let i = startIndex; i < pile.length; i++) {
                const cardEl = createCardElement(pile[i]);
                const offsetY = (i - startIndex) * cardOffsetY;
                cardEl.style.top = offsetY + 'px';
                cardEl.style.zIndex = i;

                if (i === pile.length - 1) {
                    cardEl.classList.add('new-card');
                }

                pileStack.appendChild(cardEl);
            }

            // åŠ¨æ€è°ƒæ•´ç‰Œå †å°ºå¯¸
            pileStack.style.height = (84 + (showCount - 1) * cardOffsetY) + 'px';
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(msg, isSuccess = false) {
            const msgEl = document.getElementById('message');
            msgEl.textContent = msg;
            msgEl.className = 'message' + (isSuccess ? ' success' : '');
        }

        // ç©å®¶å‡ºç‰Œ
        function playerPlay() {
            if (gameOver || !isPlayerTurn || isAnimating || playerDeck.length === 0) return;

            isAnimating = true;
            document.getElementById('playBtn').disabled = true;

            const card = playerDeck.shift();
            pile.push(card);
            updatePileDisplay();
            updateUI();

            // æ£€æŸ¥æ˜¯å¦æ”¶ç‰Œ
            setTimeout(() => {
                const collectResult = checkCollect(card, playerDeck);

                if (collectResult.collected) {
                    animateCollect(collectResult.indices, () => {
                        playerDeck = collectResult.newDeck;
                        pile = collectResult.newPile;
                        updateUI();
                        updatePileDisplay();
                        showMessage(`ğŸ‰ æ”¶åˆ° ${collectResult.count} å¼ ç‰Œï¼`, true);
                        checkGameOver();

                        if (!gameOver) {
                            isPlayerTurn = false;
                            setTimeout(computerPlay, 800);
                        } else {
                            isAnimating = false;
                        }
                    });
                } else {
                    showMessage('');
                    isPlayerTurn = false;
                    turnCount++;
                    setTimeout(computerPlay, 800);
                }
            }, 300);
        }

        // ç”µè„‘å‡ºç‰Œ
        function computerPlay() {
            if (gameOver || computerDeck.length === 0) {
                isAnimating = false;
                document.getElementById('playBtn').disabled = false;
                return;
            }

            document.getElementById('autoIndicator').classList.add('show');

            // Agentå†³ç­–åˆ†æ
            const pileValues = new Set(pile.map(c => c.value));
            const matchingCards = computerDeck.filter(c => pileValues.has(c.value));

            // æ›´æ–°å†³ç­–é¢æ¿
            let decisionTitle = 'ğŸ¤” åˆ†æä¸­...';
            let decisionText = `æ‰‹ç‰Œ: ${computerDeck.length}å¼  | å…¬å…±ç‰Œå †: ${pile.length}å¼ `;

            if (matchingCards.length > 0) {
                decisionTitle = 'ğŸ˜Š å‘ç°æœºä¼šï¼';
                decisionText = `æ‰‹ä¸­æœ‰ ${matchingCards.length} å¼ ç‰Œå¯èƒ½åŒ¹é…å…¬å…±ç‰Œå †ä¸­çš„ç‰Œã€‚`;
            } else if (pile.length > 5) {
                decisionTitle = 'ğŸ˜ ç­‰å¾…æœºä¼š';
                decisionText = `å…¬å…±ç‰Œå †æœ‰ ${pile.length} å¼ ç‰Œï¼Œç­‰å¾…åŒ¹é…æœºä¼šã€‚`;
            } else {
                decisionTitle = 'ğŸƒ æ­£å¸¸å‡ºç‰Œ';
                decisionText = `æŒ‰é¡ºåºå‡ºç‰Œï¼ŒæœŸå¾…å¥½è¿ã€‚`;
            }
            updateDecision(decisionTitle, decisionText);

            setTimeout(() => {
                document.getElementById('autoIndicator').classList.remove('show');

                const card = computerDeck.shift();

                // åˆ†æè¿™å¼ ç‰Œ
                const analysis = analyzePlay(card, computerDeck);
                addAgentLog('info', `å‡ºç‰Œ: ${card.rank}${card.suit}`);

                pile.push(card);
                updatePileDisplay();
                updateUI();

                setTimeout(() => {
                    const collectResult = checkCollect(card, computerDeck);

                    if (collectResult.collected) {
                        agentCollects++;
                        addAgentLog('win', `ğŸ‰ æ”¶åˆ° ${collectResult.count} å¼ ç‰Œï¼`);
                        updateDecision('ğŸ‰ æ”¶ç‰ŒæˆåŠŸï¼', `æ”¶åˆ° ${collectResult.count} å¼ ç‰Œï¼Œæ‰‹ç‰Œå¢åŠ åˆ° ${computerDeck.length + collectResult.count} å¼ `);

                        animateCollect(collectResult.indices, () => {
                            computerDeck = collectResult.newDeck;
                            pile = collectResult.newPile;
                            updateUI();
                            updatePileDisplay();
                            updateAgentPanel();
                            showMessage(`ğŸ± ç”µè„‘æ”¶åˆ° ${collectResult.count} å¼ ç‰Œï¼`, true);
                            checkGameOver();

                            if (!gameOver) {
                                isPlayerTurn = true;
                                turnCount++;
                                isAnimating = false;
                                document.getElementById('playBtn').disabled = false;
                            }
                        });
                    } else {
                        addAgentLog('info', `æœªåŒ¹é…ï¼Œè½®åˆ°ç©å®¶`);
                        updateDecision('æœªåŒ¹é…', `å‡ºçš„ç‰Œ ${card.rank}${card.suit} æ²¡æœ‰åŒ¹é…ï¼Œè½®åˆ°ç©å®¶`);

                        isPlayerTurn = true;
                        turnCount++;
                        isAnimating = false;
                        document.getElementById('playBtn').disabled = false;
                        updateAgentPanel();
                    }
                }, 300);
            }, 500);
        }

        // æ£€æŸ¥æ”¶ç‰Œ
        function checkCollect(card, deck) {
            const matchIndex = pile.slice(0, -1).findIndex(c => c.value === card.value);

            if (matchIndex !== -1) {
                // æ‰¾åˆ°åŒ¹é…ï¼Œæ”¶ç‰Œ
                const collectedCards = pile.slice(matchIndex);
                return {
                    collected: true,
                    indices: Array.from({length: pile.length - matchIndex}, (_, i) => matchIndex + i),
                    count: collectedCards.length,
                    newDeck: [...deck, ...collectedCards],
                    newPile: pile.slice(0, matchIndex)
                };
            }

            return { collected: false };
        }

        // æ”¶ç‰ŒåŠ¨ç”»
        function animateCollect(indices, callback) {
            const pileStack = document.getElementById('pileStack');
            if (!pileStack) {
                callback();
                return;
            }
            const cards = pileStack.querySelectorAll('.card');

            // indices æ˜¯è¦æ”¶èµ°çš„ç‰Œåœ¨ pile ä¸­çš„ç´¢å¼•
            // æ˜¾ç¤ºçš„ç‰Œæ˜¯ä» startIndex å¼€å§‹çš„
            const maxVisible = 12;
            const showCount = Math.min(pile.length, maxVisible);
            const startIndex = Math.max(0, pile.length - showCount);

            indices.forEach((idx, i) => {
                // è®¡ç®—è¿™å¼ ç‰Œåœ¨æ˜¾ç¤ºçš„ cards ä¸­çš„ä½ç½®
                const displayIdx = idx - startIndex;
                if (displayIdx >= 0 && displayIdx < cards.length) {
                    setTimeout(() => {
                        cards[displayIdx].classList.add('collect-card');
                    }, i * 50);
                }
            });

            setTimeout(callback, indices.length * 50 + 500);
        }

        // æ£€æŸ¥æ¸¸æˆç»“æŸ
        function checkGameOver() {
            if (playerDeck.length === 0) {
                gameOver = true;
                showGameOver(false);
            } else if (computerDeck.length === 0) {
                gameOver = true;
                showGameOver(true);
            }
        }

        // æ˜¾ç¤ºæ¸¸æˆç»“æŸ
        function showGameOver(playerWin) {
            const overlay = document.getElementById('gameOver');
            const title = document.getElementById('gameOverTitle');
            const text = document.getElementById('gameOverText');

            if (playerWin) {
                title.textContent = 'ğŸ‰ èƒœåˆ©ï¼';
                title.className = 'game-over-title win';
                text.textContent = 'æ­å–œä½ èµ¢å¾—äº†æ¯”èµ›ï¼';
            } else {
                title.textContent = 'ğŸ˜¢ å¤±è´¥';
                title.className = 'game-over-title lose';
                text.textContent = 'ç”µè„‘èµ¢å¾—äº†æ¯”èµ›ï¼Œå†æ¥å†å‰ï¼';
            }

            overlay.classList.add('show');
            document.getElementById('playBtn').disabled = true;
        }

        // é”®ç›˜æ”¯æŒ
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                playerPlay();
            }
        });

        // ===== Agentå¯è§†åŒ–åŠŸèƒ½ =====

        // åˆ‡æ¢é¢æ¿æ˜¾ç¤º
        function toggleAgentPanel() {
            isPanelCollapsed = !isPanelCollapsed;
            document.getElementById('agentContent').style.display = isPanelCollapsed ? 'none' : 'block';
            document.getElementById('agentCollapsed').style.display = isPanelCollapsed ? 'block' : 'none';
            document.querySelector('.agent-toggle').textContent = isPanelCollapsed ? 'å±•å¼€' : 'æ”¶èµ·';
        }

        // æ›´æ–°Agenté¢æ¿
        function updateAgentPanel() {
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('agentCardCount').textContent = computerDeck.length;
            document.getElementById('agentMemoryCount').textContent = agentMemory.size;
            document.getElementById('agentCollects').textContent = agentCollects;

            // è®¡ç®—èƒœç‡é¢„ä¼°
            const winRate = calculateWinRate();
            document.getElementById('agentWinRate').textContent = winRate + '%';

            // æ›´æ–°è®°å¿†çš„ç‰Œ
            updateAgentMemory();

            // æ›´æ–°æ¦‚ç‡
            updateProbability();
        }

        // è®¡ç®—èƒœç‡é¢„ä¼°
        function calculateWinRate() {
            const total = computerDeck.length + playerDeck.length + pile.length;
            if (total === 0) return 50;
            const ratio = computerDeck.length / (computerDeck.length + playerDeck.length);
            return Math.round(ratio * 100);
        }

        // æ›´æ–°è®°å¿†çš„ç‰Œæ˜¾ç¤º
        function updateAgentMemory() {
            const container = document.getElementById('agentMemory');
            container.innerHTML = '';

            // æ˜¾ç¤ºå…¬å…±ç‰Œå †ä¸­å¯åŒ¹é…çš„ç‰Œ
            const pileValues = new Map();
            pile.forEach(card => {
                if (!pileValues.has(card.value)) {
                    pileValues.set(card.value, []);
                }
                pileValues.get(card.value).push(card);
            });

            // æ˜¾ç¤ºè®°å¿†çš„ç‰Œï¼ˆå·²å‡ºè¿‡çš„ç‰Œå€¼ï¼‰
            agentMemory.forEach((count, value) => {
                if (pileValues.has(value)) {
                    // å…¬å…±ç‰Œå †ä¸­æœ‰å¯åŒ¹é…çš„ç‰Œ
                    pileValues.get(value).forEach(card => {
                        const div = document.createElement('div');
                        div.className = `memory-card ${card.color} highlight`;
                        div.innerHTML = `<span>${card.rank}</span><span>${card.suit}</span>`;
                        div.title = `å¯åŒ¹é…ï¼å…¬å…±ç‰Œå †ä¸­æœ‰è¿™å¼ ç‰Œ`;
                        container.appendChild(div);
                    });
                }
            });

            if (container.children.length === 0) {
                container.innerHTML = '<div style="opacity:0.5; padding:10px;">æš‚æ— å¯åŒ¹é…çš„ç‰Œ</div>';
            }
        }

        // æ›´æ–°æ”¶ç‰Œæ¦‚ç‡
        function updateProbability() {
            if (pile.length === 0) {
                document.getElementById('probBar').style.width = '0%';
                document.getElementById('probValue').textContent = '0%';
                return;
            }

            // è®¡ç®—ç”µè„‘æ‰‹ä¸­ç‰Œèƒ½åŒ¹é…å…¬å…±ç‰Œå †çš„æ¦‚ç‡
            const pileValues = new Set(pile.map(c => c.value));
            const matchCount = computerDeck.filter(c => pileValues.has(c.value)).length;
            const probability = computerDeck.length > 0 ? Math.round((matchCount / computerDeck.length) * 100) : 0;

            document.getElementById('probBar').style.width = probability + '%';
            document.getElementById('probValue').textContent = probability + '%';
        }

        // æ·»åŠ å†³ç­–æ—¥å¿—
        function addAgentLog(type, message) {
            agentLog.unshift({ type, message, time: new Date().toLocaleTimeString() });
            if (agentLog.length > 20) agentLog.pop();

            const container = document.getElementById('agentLog');
            container.innerHTML = agentLog.map(log =>
                `<div class="log-entry ${log.type}">[${log.time}] ${log.message}</div>`
            ).join('');
        }

        // æ›´æ–°å†³ç­–æ˜¾ç¤º
        function updateDecision(title, text) {
            document.getElementById('agentDecision').innerHTML = `
                <div class="agent-decision-title">${title}</div>
                <div class="agent-decision-text">${text}</div>
            `;
        }

        // åˆ†æå‡ºç‰Œ
        function analyzePlay(card, deck) {
            const pileValues = pile.slice(0, -1).map(c => c.value);
            const canMatch = pileValues.includes(card.value);

            // è®°å½•åˆ°è®°å¿†
            agentMemory.set(card.value, (agentMemory.get(card.value) || 0) + 1);

            let analysis = {
                card: card,
                canMatch: canMatch,
                matchCount: pileValues.filter(v => v === card.value).length,
                pileSize: pile.length,
                deckSize: deck.length
            };

            return analysis;
        }

        // ===== åˆå§‹åŒ– =====
        initGame();
    </script>
</body>
</html>
