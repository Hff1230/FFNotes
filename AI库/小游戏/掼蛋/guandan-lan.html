<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>æ¼è›‹ - å±€åŸŸç½‘ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #1a472a 0%, #0d2818 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }


        /* ç·»åŠ é¡¶éƒ¨ä¿¡æ¯æ æ ·å¼ */
        #topBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .game-info {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .info-item {
            text-align: center;
            margin-bottom: 5px;
        }

        .info-label {
            font-size: 12px;
            color: #90ee90;
            opacity: 0.8;
        }

        .info-value {
            font-size: 20px;
            color: #ffd700;
            font-weight: bold;
        }

        #connectionStatus {
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: bold;
        }

        #connectionStatus.connected {
            background: rgba(144, 238, 144, 0.2);
            color: #90ee90;
            border: 1px solid #90ee90;
        }

        #connectionStatus.disconnected {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
            border: 1px solid #ff6b6b;
        }

        /* ç™»å½•ç•Œé¢æ ·å¼ä¿æŒä¸å˜ */
        #loginScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 40, 24, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            border-radius: 10px;
        }

        #loginScreen h1 {
            font-size: 48px;
            color: #ffd700;
            text-shadow: 0 0 20px #ffd700;
            margin-bottom: 10px;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 10px #ffd700, 0 0 20px #ffd700; }
            to { text-shadow: 0 0 20px #ffd700, 0 0 40px #ffd700, 0 0 60px #ff8c00; }
        }

        #loginScreen .subtitle {
            color: #90ee90;
            font-size: 18px;
            margin-bottom: 40px;
        }

        .input-group {
            margin: 15px 0;
            text-align: center;
        }

        .input-group label {
            display: block;
            color: #ffd700;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .input-group input {
            width: 280px;
            padding: 12px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            text-align: center;
        }

        .input-group input:focus {
            outline: none;
            box-shadow: 0 0 15px #ffd700;
        }

        .btn-group {
            display: flex;
            gap: 20px;
            margin-top: 25px;
        }

        .btn {
            background: linear-gradient(180deg, #2d5a3d, #1a3d2a);
            border: 2px solid #ffd700;
            color: #ffd700;
            padding: 14px 35px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            text-transform: uppercase;
            font-weight: bold;
        }

        .btn:hover {
            background: linear-gradient(180deg, #ffd700, #ff8c00);
            color: #1a3d2a;
            transform: scale(1.05);
            box-shadow: 0 0 20px #ffd700;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: transparent;
            border-color: #90ee90;
            color: #90ee90;
        }

        .btn-secondary:hover {
            background: #90ee90;
            color: #1a3d2a;
        }

        /* ç­‰å¾…æˆ¿é—´ */
        #waitingRoom {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(13, 40, 24, 0.95);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 150;
            border-radius: 10px;
        }

        #waitingRoom h2 {
            color: #ffd700;
            font-size: 32px;
            margin-bottom: 20px;
        }

        .room-info {
            background: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #ffd700;
            margin-bottom: 20px;
            text-align: center;
        }

        .room-info p {
            color: #90ee90;
            margin: 10px 0;
            font-size: 16px;
        }

        .room-info .room-id {
            font-size: 36px;
            font-weight: bold;
            letter-spacing: 3px;
        }

        .team-container {
            display: flex;
            gap: 30px;
            margin: 20px 0;
        }

        .team-box {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            border: 2px solid;
            min-width: 200px;
        }

        .team-box.team1 {
            border-color: #ff6b6b;
        }

        .team-box.team2 {
            border-color: #4dabf7;
        }

        .team-box h3 {
            font-size: 18px;
            margin-bottom: 15px;
            text-align: center;
        }

        .team-box.team1 h3 {
            color: #ff6b6b;
        }

        .team-box.team2 h3 {
            color: #4dabf7;
        }

        .player-slot {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            margin: 8px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-slot .player-name {
            color: #fff;
            font-weight: bold;
        }

        .player-slot .player-status {
            font-size: 12px;
            color: #888;
        }

        .player-slot.ready .player-status {
            color: #90ee90;
        }

        /* æ¸¸æˆç•Œé¢ */
        #gameArea {
            display: none;
        }

        /* é¡¶éƒ¨ä¿¡æ¯æ  */
        #topBar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .game-info {
            display: flex;
            gap: 30px;
        }

        .info-item {
            text-align: center;
        }

        .info-item .info-label {
            font-size: 12px;
            color: #90ee90;
            opacity: 0.8;
        }

        .info-item .info-value {
            font-size: 18px;
            color: #ffd700;
            font-weight: bold;
        }

        /* æ¸¸æˆæ¡Œé¢ */
        #gameTable {
            background: linear-gradient(135deg, #1e5631 0%, #0d2818 100%);
            border-radius: 15px;
            padding: 20px;
            min-height: 500px;
            position: relative;
            border: 3px solid #2d5a3d;
            box-shadow: inset 0 0 50px rgba(0, 0, 0, 0.5);
        }

        /* å¯¹æ‰‹åŒºåŸŸ */
        .opponents-area {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            min-height: 120px;
        }

        .opponent {
            text-align: center;
            padding: 10px;
            min-width: 200px;
        }

        .opponent-name {
            color: #fff;
            font-weight: bold;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .opponent-name.team1 {
            color: #ff6b6b;
        }

        .opponent-name.team2 {
            color: #4dabf7;
        }

        .opponent-cards {
            display: flex;
            justify-content: center;
            gap: 2px;
            margin: 10px 0;
        }

        .card-back {
            width: 30px;
            height: 42px;
            background: linear-gradient(135deg, #1a3d6e 0%, #0d1f30 100%);
            border: 1px solid #2d5a8e;
            border-radius: 3px;
        }

        .card-count {
            color: #ffd700;
            font-size: 14px;
        }

        .opponent-play {
            min-height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3px;
            flex-wrap: wrap;
        }

        .turn-indicator {
            color: #ffd700;
            font-size: 12px;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ä¸­å¤®å‡ºç‰ŒåŒº */
        #centerPlayArea {
            display: flex;
            align-items: center;
            min-height: 100px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        #centerPlayArea .played-cards {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: wrap;
        }

        /* ç©å®¶åŒºåŸŸ */
        #playerArea {
            position: relative;
        }

        #myPlayArea {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 80px;
            padding: 10px 15px;
            background: rgba(255, 215, 0, 0.1);
            border: 2px dashed #ffd700;
            border-radius: 10px;
        }

        #handContainer {
            display: flex;
            justify-content: center;
            padding: 10px;
            overflow-x: auto;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
        }

        #myHand {
            display: flex;
            justify-content: center;
            gap: 5px;
            flex-wrap: nowrap;
        }

        .card {
            width: 60px;
            height: 84px;
            background: #fff;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
            border: 2px solid #ddd;
            box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
        }

        .card:hover {
            transform: translateY(-10px);
            box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.3);
        }

        .card.selected {
            transform: translateY(-20px);
            border-color: #ffd700;
            box-shadow: 0 0 15px #ffd700;
        }

        .card.red {
            color: #dc3545;
        }

        .card.black {
            color: #212529;
        }

        .card.joker-red {
            background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
            color: #fff;
        }

        .card.joker-black {
            background: linear-gradient(135deg, #495057 0%, #212529 100%);
            color: #fff;
        }

        .card .suit {
            font-size: 24px;
        }

        .card .rank {
            font-size: 16px;
            margin-top: 2px;
        }

        .card.trump {
            border-color: #ff8c00;
            box-shadow: 0 0 10px #ff8c00;
        }

        .card-small {
            width: 40px;
            height: 56px;
            font-size: 12px;
        }

        .card-small .suit {
            font-size: 16px;
        }

        .card-small .rank {
            font-size: 11px;
        }

        /* æ“ä½œæŒ‰é’® */
        #actionButtons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }

        #actionButtons .btn {
            padding: 12px 30px;
            font-size: 16px;
        }

        /* èŠå¤©æ¡† */
        #chatBox {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 280px;
            height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #ffd700;
            border-radius: 10px;
            display: none;
            flex-direction: column;
            z-index: 100;
        }

        #chatMessages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 12px;
        }

        .chat-message {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-message .sender {
            color: #ffd700;
            font-weight: bold;
        }

        .chat-message .text {
            color: #fff;
        }

        #chatInput {
            display: flex;
            border-top: 1px solid #ffd700;
        }

        #chatInput input {
            flex: 1;
            padding: 10px;
            background: transparent;
            border: none;
            color: #fff;
            font-size: 12px;
        }

        #chatInput input:focus {
            outline: none;
        }

        #chatInput button {
            padding: 10px 15px;
            background: transparent;
            border: none;
            color: #ffd700;
            cursor: pointer;
        }

        /* æç¤ºä¿¡æ¯ */
        #notification {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 215, 0, 0.95);
            color: #1a3d2a;
            padding: 15px 30px;
            border-radius: 8px;
            font-weight: bold;
            display: none;
            z-index: 200;
        }

        /* å›åˆç»“æŸå¼¹çª— */
        #roundEndModal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 180;
        }

        #roundEndModal h2 {
            color: #ffd700;
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 0 0 20px #ffd700;
        }

        .rank-list {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 40px;
            border-radius: 10px;
            margin-bottom: 35px;
        }

        .rank-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            min-width: 200px;
        }

        .rank-item .name {
            color: #fff;
            font-weight: bold;
        }

        .rank-item .rank {
            color: #ffd700;
        }

        #gameOverModal h2 {
            color: #ffd700;
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 0 20px #ffd700;
        }

        .score-board {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            min-width: 200px;
        }

        .score-item .name {
            color: #fff;
            font-weight: bold;
        }

        .score-item .score {
            color: #ffd700;
        }

        /* ç‰Œæ¡Œåˆ—è¡¨æ ·å¼ */
        .lobby-container {
            width: 90%;
            max-width: 800px;
            margin-top: 20px;
        }

        .lobby-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 0 10px;
        }

        .lobby-header h2 {
            color: #ffd700;
            font-size: 24px;
        }

        .table-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .table-card {
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #2d5a3d;
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .table-card:hover {
            border-color: #ffd700;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.2);
        }

        .table-card.full {
            border-color: #ff6b6b;
            opacity: 0.7;
        }

        .table-card.full:hover {
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .table-card.playing {
            border-color: #4dabf7;
        }

        .table-id {
            color: #ffd700;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 15px;
        }

        .table-seats {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 15px;
        }

        .seat {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            cursor: default;
            transition: all 0.2s;
        }

        .seat:not(.occupied) {
            cursor: pointer;
            border-style: dashed;
        }

        .seat:not(.occupied):hover {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.1);
        }

        .seat.occupied {
            border-color: #ffd700;
            background: rgba(255, 215, 0, 0.2);
            cursor: default;
        }

        .seat.occupied.red {
            border-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.2);
        }

        .seat.occupied.blue {
            border-color: #4dabf7;
            background: rgba(77, 171, 247, 0.2);
        }

        .table-status {
            text-align: center;
            font-size: 12px;
            color: #90ee90;
        }

        .table-status.full {
            color: #ff6b6b;
        }

        .table-status.playing {
            color: #4dabf7;
        }

        .table-players {
            margin-top: 10px;
            font-size: 11px;
            color: #888;
            text-align: center;
        }

        .create-table-card {
            background: rgba(255, 215, 0, 0.1);
            border: 2px dashed #ffd700;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 150px;
            cursor: pointer;
        }

        .create-table-card .plus {
            font-size: 48px;
            color: #ffd700;
            margin-bottom: 10px;
        }

        .create-table-card .text {
            color: #ffd700;
            font-size: 14px;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .mode-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid;
        }

        .mode-btn.fast {
            background: rgba(255, 107, 107, 0.2);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .mode-btn.fast:hover, .mode-btn.fast.active {
            background: #ff6b6b;
            color: #1a3d2a;
        }

        .mode-btn.normal {
            background: rgba(77, 171, 247, 0.2);
            border-color: #4dabf7;
            color: #4dabf7;
        }

        .mode-btn.normal:hover, .mode-btn.normal.active {
            background: #4dabf7;
            color: #1a3d2a;
        }

        /* ç‰Œæ¡Œæ¨¡å¼æ ‡ç­¾ */
        .table-mode {
            position: absolute;
            top: 8px;
            right: 8px;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
        }

        .table-mode.fast {
            background: #ff6b6b;
            color: #fff;
        }

        .table-mode.normal {
            background: #4dabf7;
            color: #fff;
        }

        .table-card {
            position: relative;
        }

        .name-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            margin-top: 20px;
        }

        .name-bar label {
            color: #ffd700;
            font-size: 14px;
        }

        .name-bar input {
            width: 200px;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.5);
            border: 2px solid #ffd700;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
        }

        .name-bar input:focus {
            outline: none;
            box-shadow: 0 0 15px #ffd700;
        }

        .name-bar input::placeholder {
            color: #666;
        }

        /* åœ†æ¡Œå¸ƒå±€æ ·å¼ */
        .table-layout {
            position: relative;
            width: 350px;
            height: 350px;
            margin: 30px auto;
        }

        .table-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, #2d5a3d 0%, #1a3d2a 100%);
            border: 4px solid #ffd700;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .table-surface {
            font-size: 36px;
        }

        .seat-pos {
            position: absolute;
            text-align: center;
            width: 100px;
        }

        .seat-1 { bottom: 0; left: 50%; transform: translateX(-50%); }
        .seat-2 { left: 0; top: 50%; transform: translateY(-50%); }
        .seat-3 { top: 0; left: 50%; transform: translateX(-50%); }
        .seat-4 { right: 0; top: 50%; transform: translateY(-50%); }

        .seat-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            font-weight: bold;
            margin: 0 auto 8px;
            border: 3px solid;
            background: rgba(0, 0, 0, 0.3);
        }

        .team1-avatar {
            border-color: #ff6b6b;
            color: #ff6b6b;
        }

        .team2-avatar {
            border-color: #4dabf7;
            color: #4dabf7;
        }

        .seat-avatar.occupied {
            background: rgba(255, 215, 0, 0.2);
        }

        .seat-avatar.occupied.team1-avatar {
            background: rgba(255, 107, 107, 0.2);
        }

        .seat-avatar.occupied.team2-avatar {
            background: rgba(77, 171, 247, 0.2);
        }

        .seat-name {
            font-size: 12px;
            color: #fff;
            max-width: 90px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .seat-status {
            font-size: 10px;
            color: #90ee90;
            margin-top: 4px;
        }

        .seat-status.ready {
            color: #ffd700;
            font-weight: bold;
        }

        .seat-pos.is-me .seat-avatar {
            box-shadow: 0 0 15px #ffd700;
        }

        .team-legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 10px;
        }

        .team-legend-item {
            font-size: 12px;
        }

        .team-legend-item.team1 {
            color: #ff6b6b;
        }

        .team-legend-item.team2 {
            color: #4dabf7;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- ç™»å½•ç•Œé¢ -->
        <div id="loginScreen">
            <h1>ğŸƒ æ¼è›‹ ğŸƒ</h1>
            <div class="subtitle">å®‰å¾½å®‰åº†çƒ­é—¨æ‰‘å…‹æ¸¸æˆ Â· å±€åŸŸç½‘ç‰ˆ</div>

            <!-- åº•éƒ¨åç§°æ  -->
            <div class="name-bar">
                <label>ç©å®¶åç§°:</label>
                <input type="text" id="playerName" placeholder="è¾“å…¥ä½ çš„åç§°" maxlength="10">
            </div>

            <!-- ç‰Œæ¡Œåˆ—è¡¨ -->
            <div class="lobby-container">
                <div class="lobby-header">
                    <h2>ğŸª‘ ç‰Œæ¡Œåˆ—è¡¨</h2>
                </div>
                <div class="table-grid" id="tableGrid">
                    <!-- åˆ›å»ºæ–°æ¡Œå¡ç‰‡ -->
                    <div class="table-card create-table-card">
                        <div class="plus">+</div>
                        <div class="text">åˆ›å»ºæ–°æ¡Œ</div>
                        <div class="mode-selector">
                            <div class="mode-btn fast" onclick="createRoom('fast')">âš¡ å¿«é€Ÿ 7ç§’</div>
                            <div class="mode-btn normal active" onclick="createRoom('normal')">ğŸ® æ­£å¸¸ 15ç§’</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç­‰å¾…æˆ¿é—´ -->
        <div id="waitingRoom">
            <h2>â³ ç­‰å¾…ç©å®¶</h2>
            <div class="room-info">
                <p>æˆ¿é—´å·</p>
                <p class="room-id" id="displayRoomId">------</p>
                <p style="margin-top: 10px; font-size: 14px;">åˆ†äº«æˆ¿é—´å·ç»™å¥½å‹åŠ å…¥</p>
            </div>

            <!-- åœ†æ¡Œå¸ƒå±€ -->
            <div class="table-layout">
                <div class="table-center">
                    <div class="table-surface">
                        <span>ğŸƒ</span>
                    </div>
                </div>
                <!-- 1å·ä½ - ä¸‹æ–¹ï¼ˆè‡ªå·±ï¼‰ -->
                <div class="seat-pos seat-1" id="waitSeat1">
                    <div class="seat-avatar team1-avatar">1</div>
                    <div class="seat-name" id="waitSeat1Name">ç­‰å¾…åŠ å…¥...</div>
                    <div class="seat-status" id="waitSeat1Status"></div>
                </div>
                <!-- 2å·ä½ - å·¦è¾¹ -->
                <div class="seat-pos seat-2" id="waitSeat2">
                    <div class="seat-avatar team2-avatar">2</div>
                    <div class="seat-name" id="waitSeat2Name">ç­‰å¾…åŠ å…¥...</div>
                    <div class="seat-status" id="waitSeat2Status"></div>
                </div>
                <!-- 3å·ä½ - ä¸Šæ–¹ï¼ˆå¯¹å®¶ï¼‰ -->
                <div class="seat-pos seat-3" id="waitSeat3">
                    <div class="seat-avatar team1-avatar">3</div>
                    <div class="seat-name" id="waitSeat3Name">ç­‰å¾…åŠ å…¥...</div>
                    <div class="seat-status" id="waitSeat3Status"></div>
                </div>
                <!-- 4å·ä½ - å³è¾¹ -->
                <div class="seat-pos seat-4" id="waitSeat4">
                    <div class="seat-avatar team2-avatar">4</div>
                    <div class="seat-name" id="waitSeat4Name">ç­‰å¾…åŠ å…¥...</div>
                    <div class="seat-status" id="waitSeat4Status"></div>
                </div>
            </div>

            <div class="team-legend">
                <span class="team-legend-item team1">ğŸ”´ çº¢é˜Ÿ: 1å·ã€3å·</span>
                <span class="team-legend-item team2">ğŸ”µ è“é˜Ÿ: 2å·ã€4å·</span>
            </div>

            <p style="color: #90ee90; margin: 15px 0; font-size: 14px;">éœ€è¦4åç©å®¶æ‰èƒ½å¼€å§‹æ¸¸æˆ</p>

            <button class="btn" id="readyBtn" onclick="toggleReady()">å‡†å¤‡</button>
        </div>

        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div id="gameArea" style="display: none;">
            <!-- é¡¶éƒ¨ä¿¡æ¯æ  -->
            <div id="topBar">
                <div class="game-info">
                    <div class="info-item">
                        <div class="info-label">ğŸ”´ çº¢é˜Ÿ</div>
                        <div class="info-value" id="team1Level">2</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ğŸ”µ è“é˜Ÿ</div>
                        <div class="info-value" id="team2Level">2</div>
                    </div>
                </div>
                <div class="game-info">
                    <div class="info-item">
                        <div class="info-label">é€¢äººé…</div>
                        <div class="info-value" id="trumpCard">â™¥2</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æˆ‘çš„é˜Ÿä¼</div>
                        <div class="info-value" id="myTeam">çº¢é˜Ÿ</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ‰“ç‰Œæ–¹</div>
                        <div class="info-value" id="currentLevelTeam">çº¢é˜Ÿ</div>
                    </div>
                </div>
                <div id="connectionStatus" class="connected">å·²è¿æ¥</div>
            </div>

            <!-- æ¸¸æˆæ¡Œé¢ -->
            <div id="gameTable">
                <!-- å¯¹æ‰‹åŒºåŸŸ - è‡ªå·±å§‹ç»ˆåœ¨ä¸‹æ–¹ï¼Œå…¶ä»–äººæŒ‰ç›¸å¯¹ä½ç½®æ—‹è½¬ -->
                <div class="opponents-area">
                    <div class="opponent" id="opponentLeft">
                        <div class="opponent-name" id="opLeftName">ç©å®¶</div>
                        <div class="opponent-cards" id="opLeftCards"></div>
                        <div class="card-count">å‰©ä½™: <span id="opLeftCount">27</span>å¼ </div>
                        <div class="opponent-play" id="opLeftPlay"></div>
                        <div class="turn-indicator" id="opLeftTurn" style="display: none;">â–¼ å‡ºç‰Œä¸­</div>
                    </div>
                    <div class="opponent" id="opponentTop">
                        <div class="opponent-name" id="opTopName">ç©å®¶</div>
                        <div class="opponent-cards" id="opTopCards"></div>
                        <div class="card-count">å‰©ä½™: <span id="opTopCount">27</span>å¼ </div>
                        <div class="opponent-play" id="opTopPlay"></div>
                        <div class="turn-indicator" id="opTopTurn" style="display: none;">â–¼ å‡ºç‰Œä¸­</div>
                    </div>
                    <div class="opponent" id="opponentRight">
                        <div class="opponent-name" id="opRightName">ç©å®¶</div>
                        <div class="opponent-cards" id="opRightCards"></div>
                        <div class="card-count">å‰©ä½™: <span id="opRightCount">27</span>å¼ </div>
                        <div class="opponent-play" id="opRightPlay"></div>
                        <div class="turn-indicator" id="opRightTurn" style="display: none;">â–¼ å‡ºç‰Œä¸­</div>
                    </div>
                </div>

                <!-- ä¸­å¤®å‡ºç‰ŒåŒº -->
                <div id="centerPlayArea">
                    <div class="played-cards" id="lastPlayCards">
                        <span style="color: #888;">ç­‰å¾…å‡ºç‰Œ...</span>
                    </div>
                </div>

                <!-- ç©å®¶åŒºåŸŸ -->
                <div id="playerArea">
                    <div id="myPlayArea">
                        <div class="played-cards" id="myPlayCards"></div>
                    </div>

                    <div id="handContainer">
                        <div id="myHand"></div>
                    </div>

                    <div id="actionButtons">
                        <button class="btn" id="playBtn" onclick="playSelectedCards()">å‡ºç‰Œ</button>
                        <button class="btn btn-secondary" id="passBtn" onclick="passRound()">ä¸å‡º</button>
                        <button class="btn btn-secondary" onclick="clearSelection()">æ¸…ç©ºé€‰æ‹©</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- èŠå¤©æ¡† -->
        <div id="chatBox">
            <div id="chatMessages"></div>
            <div id="chatInput">
                <input type="text" id="messageInput" placeholder="æŒ‰Enterå‘é€æ¶ˆæ¯..." maxlength="50">
                <button onclick="sendMessage()">å‘é€</button>
            </div>
        </div>

        <!-- æç¤º -->
        <div id="notification"></div>
    </div>

    <!-- å›åˆç»“æŸå¼¹çª— -->
    <div id="roundEndModal">
        <h2 id="roundEndTitle">ğŸ‰ å›åˆç»“æŸ ğŸ‰</h2>
        <div class="rank-list" id="rankList"></div>
        <p style="color: #90ee90; margin-bottom: 20px;" id="levelUpInfo"></p>
        <button class="btn" id="nextRoundBtn" onclick="startNewRound()">ä¸‹ä¸€å±€</button>
    </div>

    <script>
    // ==================== æ¸¸æˆçŠ¶æ€ ====================
    let ws = null;
    let playerId = null;
    let roomId = null;
    let playerName = '';
    let isReady = false;
    let gameState = null;
    let selectedCards = [];
    let myInfo = null;

    let LEVEL_TO_RANK = { 2: '2', 3: '3', 4: '4', 5: '5', 6: '6', 7: '7', 8: '8', 9: '9', 10: '10', 11: 'J', 12: 'Q', 13: 'K', 14: 'A' };


    // ==================== WebSocketè¿æ¥ ====================
    function connect(serverAddress) {
        return new Promise((resolve, reject) => {
            ws = new WebSocket(`ws://${serverAddress}`);

            ws.onopen = () => {
                updateConnectionStatus(true);
                showNotification('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
                resolve();
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };

            ws.onclose = () => {
                updateConnectionStatus(false);
                showNotification('ä¸æœåŠ¡å™¨æ–­å¼€è¿æ¥');
            };

            ws.onerror = (error) => {
                console.error('WebSocketé”™è¯¯:', error);
                updateConnectionStatus(false);
                reject(error);
            };
        });
    }

    function updateConnectionStatus(connected) {
        const status = document.getElementById('connectionStatus');
        if (connected) {
            status.textContent = 'å·²è¿æ¥';
            status.className = 'connected';
        } else {
            status.textContent = 'æœªè¿æ¥';
            status.className = 'disconnected';
        }
    }

    // ==================== æ¶ˆæ¯å¤„ç† ====================
    function handleMessage(data) {
        switch(data.type) {
            case 'roomList':
                renderTableList(data.rooms);
                break;
            case 'roomCreated':
                handleRoomCreated(data);
                break;
            case 'roomJoined':
                handleRoomJoined(data);
                break;
            case 'playerList':
                updatePlayerList(data.players);
                break;
            case 'playerJoined':
                showNotification(`${data.player.name} åŠ å…¥äº†æ¸¸æˆ`);
                break;
            case 'playerLeft':
                showNotification(`${data.playerName} ç¦»å¼€äº†æ¸¸æˆ`);
                break;
            case 'gameStart':
                handleGameStart(data);
                break;
            case 'gameState':
                handleGameState(data);
                break;
            case 'playError':
                showNotification(data.message);
                break;
            case 'playerFinished':
                showNotification(`ğŸ‰ ${data.playerName} ç¬¬${data.rank}ä¸ªå‡ºå®Œç‰Œï¼`);
                break;
            case 'roundEnd':
                handleRoundEnd(data);
                break;
            case 'newRound':
                handleNewRound(data);
                break;
            case 'chat':
                handleChat(data);
                break;
            case 'error':
                showNotification(data.message);
                break;
        }
    }

    // ==================== ç‰Œæ¡Œåˆ—è¡¨ ====================
    function renderTableList(rooms) {
        const grid = document.getElementById('tableGrid');

        // ä¿ç•™åˆ›å»ºæ–°æ¡Œå¡ç‰‡
        grid.innerHTML = `
            <div class="table-card create-table-card">
                <div class="plus">+</div>
                <div class="text">åˆ›å»ºæ–°æ¡Œ</div>
                <div class="mode-selector">
                    <div class="mode-btn fast" onclick="createRoom('fast')">âš¡ å¿«é€Ÿ 7ç§’</div>
                    <div class="mode-btn normal" onclick="createRoom('normal')">ğŸ® æ­£å¸¸ 15ç§’</div>
                </div>
            </div>
        `;

        // æ·»åŠ ç°æœ‰æˆ¿é—´
        rooms.forEach(room => {
            const card = document.createElement('div');
            const isFull = room.playerCount >= room.maxPlayers;
            const isPlaying = room.started;
            const isFast = room.mode === 'fast';

            card.className = `table-card ${isFull ? 'full' : ''} ${isPlaying ? 'playing' : ''}`;

            // æ¨¡å¼æ ‡ç­¾
            const modeLabel = isFast ? 'âš¡ å¿«é€Ÿ' : 'ğŸ® æ­£å¸¸';
            const modeClass = isFast ? 'fast' : 'normal';

            // ç”Ÿæˆåº§ä½æ˜¾ç¤ºï¼ˆæ¯ä¸ªåº§ä½å¯å•ç‹¬ç‚¹å‡»ï¼‰
            let seatsHtml = '';
            for (let i = 0; i < 4; i++) {
                const occupied = i < room.playerCount;
                const player = room.players[i];
                let seatClass = occupied ? 'occupied' : '';
                if (occupied && player) {
                    seatClass += (i < 2) ? ' red' : ' blue';
                }
                // ç©ºåº§ä½æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const clickHandler = (!occupied && !isPlaying) ? `onclick="event.stopPropagation(); joinRoomById('${room.roomId}')"` : '';
                const title = occupied && player ? player.name : (isPlaying ? '' : 'ç‚¹å‡»åŠ å…¥');
                seatsHtml += `<div class="seat ${seatClass}" ${clickHandler} title="${title}">${occupied ? 'ğŸ‘¤' : '+'}</div>`;
            }

            // ç©å®¶åˆ—è¡¨
            const playerNames = room.players.map(p => p.name).join(', ');

            // çŠ¶æ€æ–‡å­—
            let statusText = `${room.playerCount}/4 äºº`;
            if (isPlaying) statusText = 'æ¸¸æˆä¸­';
            else if (isFull) statusText = 'å·²æ»¡';

            card.innerHTML = `
                <div class="table-mode ${modeClass}">${modeLabel}</div>
                <div class="table-id">${room.roomId}</div>
                <div class="table-seats">${seatsHtml}</div>
                <div class="table-status ${isFull ? 'full' : ''} ${isPlaying ? 'playing' : ''}">${statusText}</div>
                ${playerNames ? `<div class="table-players">${playerNames}</div>` : ''}
            `;

            grid.appendChild(card);
        });
    }

    function joinRoomById(roomId) {
        playerName = document.getElementById('playerName').value.trim();

        if (!playerName) {
            showNotification('è¯·è¾“å…¥ç©å®¶åç§°');
            return;
        }

        // ä¿å­˜ç”¨æˆ·å
        savePlayerName(playerName);

        // å¦‚æœè¿˜æ²¡è¿æ¥ï¼Œå…ˆè¿æ¥
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            connect(window.location.host).then(() => {
                send({
                    type: 'joinRoom',
                    roomId: roomId,
                    playerName: playerName
                });
            }).catch(() => {
                showNotification('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
            });
        } else {
            send({
                type: 'joinRoom',
                roomId: roomId,
                playerName: playerName
            });
        }
    }

    function handleRoomCreated(data) {
        playerId = data.playerId;
        roomId = data.roomId;
        updatePlayerList(data.players);
        showWaitingRoom();
    }

    function handleRoomJoined(data) {
        playerId = data.playerId;
        roomId = data.roomId;
        updatePlayerList(data.players);
        showWaitingRoom();
    }

    function showWaitingRoom() {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('waitingRoom').style.display = 'flex';
        document.getElementById('displayRoomId').textContent = roomId;
    }

    function updatePlayerList(players) {
        // æ¸…ç©ºæ‰€æœ‰åº§ä½
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`waitSeat${i}Name`).textContent = 'ç­‰å¾…åŠ å…¥...';
            document.getElementById(`waitSeat${i}Status`).textContent = '';
            document.getElementById(`waitSeat${i}Status`).className = 'seat-status';
            document.getElementById(`waitSeat${i}`).classList.remove('is-me');
            document.querySelector(`#waitSeat${i} .seat-avatar`).classList.remove('occupied');
        }

        // å¡«å……ç©å®¶åˆ°å¯¹åº”åº§ä½
        players.forEach(p => {
            const seatNum = p.playerNum;
            const seatEl = document.getElementById(`waitSeat${seatNum}`);
            const avatarEl = seatEl.querySelector('.seat-avatar');

            document.getElementById(`waitSeat${seatNum}Name`).textContent = p.name + (p.id === playerId ? ' (ä½ )' : '');
            document.getElementById(`waitSeat${seatNum}Status`).textContent = p.ready ? 'âœ“ å·²å‡†å¤‡' : 'ç­‰å¾…ä¸­';
            document.getElementById(`waitSeat${seatNum}Status`).className = `seat-status ${p.ready ? 'ready' : ''}`;

            if (p.id === playerId) {
                seatEl.classList.add('is-me');
            }
            avatarEl.classList.add('occupied');
        });
    }

    function handleGameStart(data) {
        gameState = data.gameState;
        myInfo = gameState.myInfo;

 document.getElementById('waitingRoom').style.display = 'none';
        document.getElementById('gameArea').style.display = 'block';
        document.getElementById('chatBox').style.display = 'flex';

        updateGameUI();
    }

    function handleGameState(data) {
        gameState = data.gameState;
        updateGameUI();
    }

    function updateGameUI() {
        if (!gameState || !myInfo) return;

        // æ›´æ–°åŒæ–¹çº§ç‰Œ
        const team1Level = gameState.teamLevels[1];
        const team2Level = gameState.teamLevels[2];

        const level1Text = LEVEL_TO_RANK[team1Level];
        const level2Text = LEVEL_TO_RANK[team2Level];

        document.getElementById('team1Level').textContent = level1Text;
        document.getElementById('team2Level').textContent = level2Text;

        // é€¢äººé…ï¼ˆå½“å‰æ‰“ç‰Œæ–¹çš„çº§ç‰Œå¯¹åº”çš„çº¢æ¡ƒ)
        const currentLevel = gameState.teamLevels[gameState.currentLevelTeam];
        const currentLevelRank = LEVEL_TO_RANK[currentLevel];
        document.getElementById('trumpCard').textContent = 'â™¥' + currentLevelRank;

        // æˆ‘çš„é˜Ÿä¼
        document.getElementById('myTeam').textContent = myInfo.team === 1 ? 'çº¢é˜Ÿ' : 'è“é˜Ÿ';
        document.getElementById('myTeam').style.color = myInfo.team === 1 ? '#ff6b6b' : '#4dabf7';

        // æ‰“ç‰Œæ–¹
        const currentTeam = gameState.currentLevelTeam;
        document.getElementById('currentLevelTeam').textContent = currentTeam === 1 ? 'çº¢é˜Ÿ' : 'è“é˜Ÿ';
        document.getElementById('currentLevelTeam').style.color = currentTeam === 1 ? '#ff6b6b' : '#4dabf7';

        // æ¸²æŸ“æ‰‹ç‰Œ
        renderMyHand();

        // æ›´æ–°å¯¹æ‰‹ä¿¡æ¯
        updateOpponents();

        // æ›´æ–°ä¸Šä¸€æ¬¡å‡ºçš„ç‰Œ
        updateLastPlay();

        // æ›´æ–°å½“å‰ç©å®¶æŒ‡ç¤º
        updateTurnIndicator();

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        updateButtons();
    }

    function renderMyHand() {
        const hand = document.getElementById('myHand');
        hand.innerHTML = '';

        const cards = gameState.myHand || [];
        cards.forEach((card, index) => {
            const cardEl = createCardElement(card, false);
            cardEl.onclick = () => toggleCardSelection(index, card);
            if (selectedCards.some(sc => sc.suit === card.suit && sc.rank === card.rank)) {
                cardEl.classList.add('selected');
            }
            hand.appendChild(cardEl);
        });
    }

    function createCardElement(card, small = false) {
        const el = document.createElement('div');
        el.className = `card ${small ? 'card-small' : ''}`;

        if (card.isJoker) {
            el.classList.add(card.rank === 'å¤§ç‹' ? 'joker-red' : 'joker-black');
        } else if (card.suit === 'â™¥' || card.suit === 'â™¦') {
            el.classList.add('red');
        } else {
            el.classList.add('black');
        }

        if (card.isTrump) {
            el.classList.add('trump');
        }

        el.innerHTML = `
            <span class="suit">${card.suit}</span>
            <span class="rank">${card.rank}</span>
        `;

        return el;
    }

    function toggleCardSelection(index, card) {
        const idx = selectedCards.findIndex(sc => sc.suit === card.suit && sc.rank === card.rank);
        if (idx === -1) {
            selectedCards.push(card);
        } else {
            selectedCards.splice(idx, 1);
        }
        renderMyHand();
    }

    function updateOpponents() {
        // è·å–æ‰€æœ‰ç©å®¶ä¿¡æ¯ï¼ŒæŒ‰playerNumæ’åº
        const playerList = [];
        for (let [pid, player] of Object.entries(gameState.playerInfo || {})) {
            playerList.push({ ...player, playerId: pid });
        }
        playerList.sort((a, b) => a.playerNum - b.playerNum);

        // æ‰¾åˆ°è‡ªå·±çš„ä½ç½®
        const myPos = myInfo.playerNum - 1; // 0-3

        // è®¡ç®—ç›¸å¯¹ä½ç½®ï¼šå·¦å®¶ã€ä¸Šå®¶ï¼ˆå¯¹å®¶ï¼‰ã€å³å®¶
        const positions = ['Left', 'Top', 'Right'];
        const relativeOffsets = [3, 2, 1]; // å·¦å®¶=è‡ªå·±-1, ä¸Šå®¶=è‡ªå·±+2, å³å®¶=è‡ªå·±+1

        positions.forEach((pos, idx) => {
            const targetPlayerNum = ((myPos + relativeOffsets[idx]) % 4) + 1;
            const targetPlayer = playerList.find(p => p.playerNum === targetPlayerNum);

            if (targetPlayer) {
                const pid = targetPlayer.playerId;
                const count = gameState.hands[pid]?.count || 0;

                // æ›´æ–°ç‰Œæ•°
                document.getElementById(`op${pos}Count`).textContent = count;

                // æ›´æ–°åå­—å’Œé˜Ÿä¼é¢œè‰²
                const nameEl = document.getElementById(`op${pos}Name`);
                nameEl.textContent = targetPlayer.name;
                nameEl.className = `opponent-name ${targetPlayer.team === 1 ? 'team1' : 'team2'}`;

                // æ˜¾ç¤ºç‰ŒèƒŒ
                const cardsContainer = document.getElementById(`op${pos}Cards`);
                cardsContainer.innerHTML = '';
                const cardCount = Math.min(count, 10);
                for (let j = 0; j < cardCount; j++) {
                    const back = document.createElement('div');
                    back.className = 'card-back';
                    cardsContainer.appendChild(back);
                }
            }
        });
    }

    function updateLastPlay() {
        const container = document.getElementById('lastPlayCards');

        if (gameState.lastPlay && gameState.lastPlay.cards) {
            container.innerHTML = '';
            gameState.lastPlay.cards.forEach(card => {
                container.appendChild(createCardElement(card, true));
            });
        } else {
            container.innerHTML = '<span style="color: #888;">ç­‰å¾…å‡ºç‰Œ...</span>';
        }
    }

    function updateTurnIndicator() {
        // æ¸…é™¤æ‰€æœ‰æŒ‡ç¤º
        ['Left', 'Top', 'Right'].forEach(pos => {
            document.getElementById(`op${pos}Turn`).style.display = 'none';
            document.getElementById(`opponent${pos}`).classList.remove('current-turn');
        });
        document.getElementById('myPlayArea').style.border = '2px dashed #ffd700';
        document.getElementById('myPlayArea').style.boxShadow = 'none';

        // è·å–ç©å®¶åˆ—è¡¨ï¼ˆæŒ‰playerNumæ’åºï¼‰
        const playerList = [];
        for (let [pid, player] of Object.entries(gameState.playerInfo || {})) {
            playerList.push({ ...player, playerId: pid });
        }
        playerList.sort((a, b) => a.playerNum - b.playerNum);
        const playerIds = playerList.map(p => p.playerId);

        // åˆ¤æ–­æ˜¯å¦è½®åˆ°æˆ‘
        const currentPlayerIndex = gameState.currentPlayer;
        const currentId = playerIds[currentPlayerIndex];

        if (currentId === playerId) {
            document.getElementById('myPlayArea').style.border = '3px solid #ffd700';
            document.getElementById('myPlayArea').style.boxShadow = '0 0 20px #ffd700';
        } else {
            document.getElementById('myPlayArea').style.boxShadow = 'none';

            // æ‰¾åˆ°å½“å‰ç©å®¶çš„ç›¸å¯¹ä½ç½®
            const myPos = myInfo.playerNum - 1;
            const currentPos = playerList.findIndex(p => p.playerId === currentId);

            if (currentPos !== -1) {
                const relativePos = (currentPos - myPos + 4) % 4;
                const posMap = { 1: 'Right', 2: 'Top', 3: 'Left' };
                const targetPos = posMap[relativePos];

                if (targetPos) {
                    document.getElementById(`op${targetPos}Turn`).style.display = 'block';
                    document.getElementById(`opponent${targetPos}`).classList.add('current-turn');
                }
            }
        }
    }

    function updateButtons() {
        // è·å–ç©å®¶åˆ—è¡¨ï¼ˆæŒ‰playerNumæ’åºï¼‰
        const playerList = [];
        for (let [pid, player] of Object.entries(gameState.playerInfo || {})) {
            playerList.push({ ...player, playerId: pid });
        }
        playerList.sort((a, b) => a.playerNum - b.playerNum);
        const playerIds = playerList.map(p => p.playerId);

        const currentPlayerIndex = gameState.currentPlayer;
        const currentId = playerIds[currentPlayerIndex];

        const isMyTurn = currentId === playerId;
        const canPlay = isMyTurn && selectedCards.length > 0;
        const canPass = isMyTurn && gameState.lastPlay && gameState.lastPlayer !== playerId;

        document.getElementById('playBtn').disabled = !canPlay;
        document.getElementById('passBtn').disabled = !canPass;
    }

    function handleRoundEnd(data) {
        const modal = document.getElementById('roundEndModal');
        modal.style.display = 'flex';

        const winnerTeam = data.winner === 1 ? 'çº¢é˜Ÿ' : 'è“é˜Ÿ';
        const myTeam = myInfo.team === 1 ? 'çº¢é˜Ÿ' : 'è“é˜Ÿ';
        const won = myTeam === winnerTeam;

        document.getElementById('roundEndTitle').textContent = won ? 'ğŸ‰ èƒœåˆ©ï¼' : 'ğŸ˜¢ æœ¬å±€å¤±è´¥';

        const rankList = document.getElementById('rankList');
        rankList.innerHTML = data.ranks
            .sort((a, b) => a.rank - b.rank)
            .map(r => `
                <div class="rank-item">
                    <span class="name">${r.name} (${r.team === 1 ? 'çº¢é˜Ÿ' : 'è“é˜Ÿ'})</span>
                    <span class="rank">ç¬¬${r.rank}å</span>
                </div>
            `).join('');

        const levelInfo = document.getElementById('levelUpInfo');
        levelInfo.textContent = `${winnerTeam} å‡çº§ ${data.levelUp} çº§ï¼ å½“å‰çº§åˆ«: ${LEVEL_TO_RANK[data.teamLevels[data.winner]]}`;
        levelInfo.textContent += ` â†’ ${LEVEL_TO_RANK[data.teamLevels[data.winner]]}`;
    }

    function handleNewRound(data) {
        gameState = data.gameState;
        selectedCards = [];
        document.getElementById('roundEndModal').style.display = 'none';
        updateGameUI();
        showNotification('æ–°ä¸€å±€å¼€å§‹ï¼');
    }

    function handleChat(data) {
        const messages = document.getElementById('chatMessages');
        const msgDiv = document.createElement('div');
        msgDiv.className = 'chat-message';
        msgDiv.innerHTML = `<span class="sender">${data.playerName}:</span> <span class="text">${data.message}</span>`;
        messages.appendChild(msgDiv);
        messages.scrollTop = messages.scrollHeight;
    }

    // ==================== æ¸¸æˆæ“ä½œ ====================
    async function createRoom(mode = 'normal') {
        console.log('createRoom called, mode:', mode);
        playerName = document.getElementById('playerName').value.trim();
        console.log('playerName:', playerName);

        if (!playerName) {
            showNotification('è¯·è¾“å…¥ç©å®¶åç§°');
            return;
        }

        // ä¿å­˜ç”¨æˆ·å
        savePlayerName(playerName);

        // å¦‚æœè¿˜æ²¡è¿æ¥ï¼Œå…ˆè¿æ¥
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            console.log('Connecting to:', window.location.host);
            try {
                await connect(window.location.host);
                console.log('Connected!');
            } catch (e) {
                console.error('Connection failed:', e);
                showNotification('è¿æ¥æœåŠ¡å™¨å¤±è´¥');
                return;
            }
        }

        console.log('Sending createRoom message');
        send({
            type: 'createRoom',
            playerName: playerName,
            mode: mode
        });
    }

    function toggleReady() {
        isReady = !isReady;
        const btn = document.getElementById('readyBtn');
        btn.textContent = isReady ? 'å–æ¶ˆå‡†å¤‡' : 'å‡†å¤‡';
        btn.style.background = isReady ? 'linear-gradient(180deg, #ffd700, #ff8c00)' : '';
        btn.style.color = isReady ? '#1a3d2a' : '';

        send({
            type: 'ready',
            playerId: playerId,
            ready: isReady
        });
    }

    function playSelectedCards() {
        if (selectedCards.length === 0) {
            showNotification('è¯·é€‰æ‹©è¦å‡ºçš„ç‰Œ');
            return;
        }

        send({
            type: 'play',
            playerId: playerId,
            cards: selectedCards
        });

        selectedCards = [];
    }

    function passRound() {
        send({
            type: 'pass',
            playerId: playerId
        });
    }

    function clearSelection() {
        selectedCards = [];
        renderMyHand();
    }

    function startNewRound() {
        send({
            type: 'newRound',
            playerId: playerId
        });
    }

    function sendMessage() {
        const input = document.getElementById('messageInput');
        const message = input.value.trim();

        if (!message) return;

        send({
            type: 'chat',
            playerId: playerId,
            message: message
        });

        input.value = '';
    }

    // ==================== å·¥å…·å‡½æ•° ====================
    function send(data) {
        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(data));
        }
    }

    function showNotification(message) {
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';

        setTimeout(() => {
            notification.style.display = 'none';
        }, 3000);
    }

    // èŠå¤©å›è½¦å‘é€ & åŠ è½½ä¿å­˜çš„ç”¨æˆ·å & åˆå§‹åŒ–è¿æ¥
    document.addEventListener('DOMContentLoaded', () => {
        // åŠ è½½ä¸Šæ¬¡ä½¿ç”¨çš„ç”¨æˆ·å
        const savedName = localStorage.getItem('guandan_player_name');
        if (savedName) {
            document.getElementById('playerName').value = savedName;
        }

        // é¡µé¢åŠ è½½æ—¶è¿æ¥æœåŠ¡å™¨ï¼Œä»¥ä¾¿æ¥æ”¶æˆ¿é—´åˆ—è¡¨
        connect(window.location.host).catch(e => {
            console.log('åˆå§‹è¿æ¥å¤±è´¥ï¼Œå°†åœ¨åˆ›å»º/åŠ å…¥æˆ¿é—´æ—¶é‡è¯•');
        });

        document.getElementById('messageInput').addEventListener('keydown', (e) => {
            if (e.code === 'Enter') {
                sendMessage();
            }
        });
    });

    // ä¿å­˜ç”¨æˆ·ååˆ°æœ¬åœ°å­˜å‚¨
    function savePlayerName(name) {
        if (name) {
            localStorage.setItem('guandan_player_name', name);
        }
    }
    </script>
</body>
</html>